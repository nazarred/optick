function removeTrailingSlash(e){return e.replace(/\/$/,"")}function removeProtocol(e){return e.replace(/^https?:\/\//,"")}function removeWww(e){return e.replace(/^www\./,"")}function get_labels_list(){var e={};return $.ajax({url:"/j_box_name_list",dataType:"json",async:!1,success:function(t){e=t}}),exMail.currentParams.labels=converLabelsData(e),e}function converLabelsData(e){return _.map(e,function(e,t){var i,a={color:"6c7a89"};try{void 0!=(i=JSON.parse(e[2])).color&&(a=i)}catch(e){console.log(e.message)}return e[2]=a,e})}function replaceLink(e){exMail.currentParams.cids=[];for(var t,i=document.createTreeWalker(e,NodeFilter.SHOW_ALL,null,!1);t=i.nextNode();)!function(e){if("IMG"==e.nodeName){var t=$(e),i=t.attr("src");if(/^cid:/i.test(i)||t.data("sid"))try{var a=/^cid:/i.test(i)?i.split(":")[1]:t.data("sid");$.each(cur_msg.upload_list,function(e,i){if(a==i.content_id)return exMail.currentParams.cids.push(a),t.attr({src:"/show/"+i.upload_id+"?resize=1280","data-sid":a}),!1})}catch(e){console.warn(e.message)}}}(t);exMail.currentParams.cids=_.compact(exMail.currentParams.cids)}function cleanClassName(e){if(e.length){var t=["gmail_quote","signature","quote","noselect"],i=[];return i=_.map(e.split(" "),function(e,i){return _.indexOf(t,e)>-1?e:""}),_.compact(i).join(" ")}return""}function iframeIsLoad(e,t){function i(e){try{if("A"===e.nodeName){var t=e.getAttribute("href");if(t)if(/^\s*((http|https|ftp):\/\/)/i.test(t)){if(!$(e).hasClass("gmail_quote")){var i=t.match(/http:\/\/www.ex.ua\/(\d+)/);i&&(console.log("ex link",i[1]),r.push(i[1]))}e.setAttribute("target","_blank")}else/^\s*((mailto|tel):|\#)/i.test(t)}else"TABLE"===e.nodeName&&$(e).data("object")&&l.push($(e).data("object"))}catch(e){console.log("Error: ",e.message)}}function a(e){i(e),$(e).children("*").each(function(){1===this.nodeType&&a(this)})}$iframe=e,cur_msg=t;var n=/<script(\s+(\w+\s*=\s*("|').*?\3)\s*)*\s*(\/>|>.*?<\/script\s*>)/,o=t.html.replace(n,"");o=o.replace(/<!--[\s\S]*?-->/g,""),$frame.contents().find("body").html(o);var s=$frame.contents().find("body").get(0);$(s).linkify({linkClass:".ln"}),replaceLink(s);var r=[],l=[];a(s);var d=$(s).html();return $frame.empty(),{html:d,ex_link:r,msg:t,halva:l}}function long2ip(e){return!!isFinite(e)&&[e>>>24,e>>>16&255,e>>>8&255,255&e].join(".")}function timeConverter(e,t){var i=window.months||["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"],a=new Date(1e3*e),n=a.getFullYear(),o=i[a.getMonth()],s=a.getDate(),r=a.getHours(),l=a.getMinutes(),d=a.getSeconds();r<10&&(r="0"+r),l<10&&(l="0"+l),d<10&&(d="0"+d);var c=s+" "+o+" "+n+", "+r+":"+l;if(t){var u=new Date;u.getFullYear()==a.getFullYear()&&u.getMonth()==a.getMonth()&&u.getDate()==a.getDate()?c=r+":"+l:u.getFullYear()==a.getFullYear()?c=s+" "+o:((o=a.getMonth()+1)<10&&(o="0"+o),s<10&&(s="0"+s),c=s+"."+o+"."+n)}return c}function createCookie(e,t,i){var a="";if(i){var n=new Date;n.setTime(n.getTime()+24*i*60*60*1e3),a="; expires="+n.toGMTString()}document.cookie=e+"="+t+a+";domain=."+window.location.host.split(":")[0]+";path=/"}function getCookie(e){return document.cookie.length>0&&(c_start=document.cookie.indexOf(e+"="),-1!=c_start)?(c_start=c_start+e.length+1,c_end=document.cookie.indexOf(";",c_start),-1==c_end&&(c_end=document.cookie.length),unescape(document.cookie.substring(c_start,c_end))):""}function getLanguage(){return"ru"}function getLanguageFromCookie(){var e=getCookie("lang"),t=["ru","ua","lt"];return _.indexOf(t,e)>-1?e:"ua"}function getTidFromCookie(){return getCookie("tid")}function getLanguageName(e){return $.uConfig.lang_list[e]||"Українська"}function getMode(){return $.uConfig.mode}function r13(){createCookie("tid",1),$.uConfig.tid=1,setConfig($.uConfig),setTimeout("window.location.reload()",1e3)}function loadTemplate(){$.ajax({url:getTemplate(),async:!1,cache:!1,type:"get",dataType:"text",success:function(e){$("#dot_template").html(e)},error:function(e,t,i){console.log(e,t,i),200==e.status&&$("#dot_template").html(e.responseText)}})}function translate(e){return window.dictionary[e]||e}function makeCrcTable(){for(var e,t=[],i=0;i<256;i++){e=i;for(var a=0;a<8;a++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t}function crc32(e){for(var t=window.crcTable||(window.crcTable=makeCrcTable()),i=-1,a=0;a<e.length;a++)i=i>>>8^t[255&(i^e.charCodeAt(a))];return(-1^i)>>>0}function getConfig(){var e={};return $.ajax({url:"/j_config",type:"get",async:!1,dataType:"json",success:function(t){try{e=$.parseJSON(t.data)||{}}catch(t){e={}}}}),delete e.tid,e}function setConfig(e){var t;return $.ajax({url:"/j_config_save",type:"get",async:!1,dataType:"json",data:{data:JSON.stringify(e)},success:function(e){t=e.result}}),t}function nl2br(e,t){var i=t||void 0===t?"<br />":"<br>";return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+i+"$2")}function sendFexGa(e){exMail.isMailFexNet&&ga&&"function"==typeof ga&&(e=_.extend({hitType:"event"},e),ga("send",e))}function maybeCaptcha(e,t,i){return function(a){return exMail.utils.needCaptcha(a)?exMail.ui.captcha.show({action:e,data:t,isAuthAction:i}):a}}function newUploader(e,t){var i="compose_text",a=["image/jpeg","image/gif","image/png"];t&&(i=$(".compose_wrap").get(0)),uploader[e]&&uploader[e].destroy(),uploader[e]=new plupload.Uploader({runtimes:"html5,html4,flash,silverlight",browse_button:e+"_upload_button",container:e+"_upload_container",drop_element:i,required_features:"send_browser_cookies",url:exMail.uploadUrl,filters:{max_file_size:"200mb"},flash_swf_url:"/js/pluploader/Moxie.swf",silverlight_xap_url:"/js/pluploader/Moxie.xap",init:{PostInit:function(e){$("#"+e.msg_id+"_upload_button").show()},FilesAdded:function(e,t){plupload.each(t,function(t){console.log("plupload",arguments),$("#"+e.msg_id+"_upload_body").append(e.getFileLine(t)),$("#"+e.msg_id+"_upload_body").trigger("added_file")}),$("#"+e.msg_id+"_upload_body").show(),e.state!=plupload.STARTED&&e.start()},BeforeUpload:function(e,t){},UploadProgress:function(e,t){e.setProgressWidth(t,t.percent),window.isProgress=!0},FileUploaded:function(e,t,i){var n=parseInt(i.response);200==i.status&&n?(e.setProgressWidth(t,-1),-1!=_.indexOf(a,t.type)&&console.log("insert",t.type),$("#upload_"+t.id).data("upload_id",n).find(".name").click(getFile)):e.setProgressText(t,"Ошибка."),window.isProgress=!1},UploadComplete:function(){window.autoSend&&!t?$(".im_send_btn").trigger("eAutoSend"):window.autoSend&&$(".js-popup-send-btn").trigger("eAutoSend"),window.isProgress=!1},Error:function(e,t){t.code==plupload.HTTP_ERROR?e.setProgressText(t.file,"Ошибка."):t.code==plupload.FILE_SIZE_ERROR&&alert("Файл слишком большой. Ограничение 200MB")}},multipart_params:{msg_id:e}}),uploader[e].getFileLine=function(t){return $("<div>",{id:"upload_"+t.id,class:"upload ani new","data-file_id":t.id,"data-msg_id":e}).append($("<div>",{class:"progress ani"})).append($("<div>",{class:"delete"}).click(deleteUploadClick).append($("<i>"))).append($("<div>",{class:"name disabled ani","data-method":"/load/"}).text(t.name)).append($("<div>",{class:"size"}).text($.formatSize(t.size))).click(uploadClick)},uploader[e].removeQueuedFile=function(e){for(var t="string"==typeof e?e:e.id,i=this.files.length-1;i>=0;i--)if(this.files[i].id===t){var a=this.files.splice(i,1),n=!1;return a[0].status==plupload.UPLOADING&&this.state==plupload.STARTED&&(n=!0,this.stop()),this.trigger("FilesRemoved",a),a[0].destroy(),this.trigger("QueueChanged"),this.refresh(),n&&this.start(),window.isProgress=!1,a[0]}},uploader[e].setProgressText=function(e,t){$("#upload_"+e.id+" > div.progress").text(t)},uploader[e].setProgressWidth=function(e,t){-1==t?($("#upload_"+e.id).removeClass("new").find(".name").addClass("loaded"),$("#upload_"+e.id+" > div.progress").addClass("done"),$("#upload_"+e.id+" > div.name").removeClass("disabled")):$("#upload_"+e.id+" > div.progress").css("width",t+"%")},uploader[e].bind("Init",function(e,t){console.log(t.runtime)}),uploader[e].msg_id=e,uploader[e].init(),console.log(uploader[e])}function getFile(e){var t=$(this).parent().data("upload_id");return $(this).data("method")?(window.open("/load/"+t,"_blank"),!1):(t&&e&&e.altKey&&window.open("/load/"+t,"_blank"),!1)}function getCheckedList(){var e=[];return $(".ib_mail_list").find("li").find(".check input:checked").each(function(){e.push($(this).parent().parent().data("thread_id"))}),console.log($(".ib_mail_list").find("li").length),e.join()}function removeCheckedElements(e){_.each(e.split(","),function(e,t){$('li[data-thread_id="'+e+'"]').remove(),console.log("removed item:",e)}),$("li[data-thread_id]").length||Backbone.history.loadUrl(Backbone.history.fragment),mailUnselect(),boxInfo()}function getAllList(){var e=[];return $(".ib_mail_list").find("li").find(".check input").each(function(){e.push($(this).parent().parent().data("thread_id"))}),e.join()}function checkboxes(e,t){var i=$(".ib_mail_list").find('li[data-garbage="0"]'),a=$();if(!0!==t)switch(i.removeClass("selected"),i.find(".check input").prop("checked",!1),e){case 0:a=i.addClass("selected").find(".check input").prop("checked",!0);break;case 1:break;case 2:a=i.not(".new").addClass("selected").find(".check input").prop("checked",!0);break;case 3:a=i.filter(".new").addClass("selected").find(".check input").prop("checked",!0);break;case 4:a=i.find(".ib_important_select").parent().addClass("selected").find(".check input").prop("checked",!0);break;case 5:a=i.not(i.find(".ib_important_select").parent()).addClass("selected").find(".check input").prop("checked",!0)}else a=i.find(".check input:checked");var n=$(".ib_mail_check");n.removeClass("all one"),i.length==a.length?n.addClass("all"):0!=a.length&&n.addClass("one");var o=$(".rm_drafts").find(".ib_tt");0==a.length?(o.text(window.tooltip.REMOVE_DRAFTS),mailUnselect(),contactUnselect()):(o.text(window.tooltip.REMOVE_SEL_DRAFTS),mailSelect(),contactSelect())}function mailSelect(){$(".ib_mail_check").addClass("one");var e=$(".im_check_back_btn"),t=$(".im_check_rm_btn"),i=$(".im_spam_btn"),a=$(".im_rm_btn"),n=$(".im_rm_trash_btn"),o=$(".im_rm_spam_btn");$unread_btn=$(".im_unread_btn"),i.add(e).add(a).add(t).add($unread_btn).add($(".to_label")).add($(".unmarck_labels")).show(),o.add(n).hide()}function mailUnselect(e){var t=$(".ib_mail_check"),i=getCheckedList();if(i.length&&!e)return 0;var a=$(".im_check_back_btn"),n=$(".im_check_rm_btn"),o=$(".im_spam_btn"),s=$(".im_rm_btn"),r=$(".im_rm_trash_btn"),l=$(".im_rm_spam_btn");$unread_btn=$(".im_unread_btn"),o.add(a).add(s).add(n).add($unread_btn).add($(".to_label")).add($(".unmarck_labels")).hide(),t.removeClass("all one"),l.add(r).show(),console.log("checked_l",i)}function addToGarbage(e){$('li[data-garbage="1"]').remove(),_.each(e.split(","),function(e,t){$('li[data-thread_id="'+e+'"]').attr("data-garbage",1)}),$('li[data-garbage="0"]').length||Backbone.history.loadUrl(Backbone.history.fragment)}function resetGarbage(e){var t=!0;_.each(e.split(","),function(e,i){var a=$('li[data-thread_id="'+e+'"]');a.length?a.attr("data-garbage",0):(console.log((new Date).getTime()),t=!1)}),t?cancel_list=[]:(console.warn("resetGarbage reload page"),Backbone.history.loadUrl(Backbone.history.fragment))}function contactSelect(){$(".ib_groups_btn, .ib_send_to_group_btn, .ib_rm_from_group_btn").show(),$(".ib_add_to_group_btn, .ib_send_to_all_btn").hide()}function contactUnselect(){$(".ib_groups_btn, .ib_send_to_group_btn, .ib_rm_from_group_btn, .im_rm_btn").hide(),$(".ib_send_to_all_btn, .ib_add_to_group_btn").show()}function t_init_contact_info(e,t,i,a){$("#mail_list").empty().tmpl("t_contact_edit",{email:t,name:i}),t?$(".js-top-toolbar").tmpl("t_toolbar_contact",{groups:$._user_group}):$(".js-top-toolbar").empty(),$(".ib_select_btn").ddOZ(),$("#do_back_contact, .cansel").click(function(){void 0!==exMail.currentParams.groupId?exMail.router.navigate("!contacts/g/"+exMail.currentParams.groupId,{trigger:!0}):exMail.router.navigate("!contacts",{trigger:!0})}),$(".im_rm_btn").click(function(){if(confirm(alerts.REMOVE_FOREVER+"?")){var e=$('input[name="email"]');$.ajax({url:"/j_contact_change",type:"GET",dataType:"JSON",data:{email:e.val()}}).done(function(e){void 0!==exMail.currentParams.groupId?exMail.router.navigate("!contacts/g/"+exMail.currentParams.groupId,{trigger:!0}):exMail.router.navigate("!contacts",{trigger:!0})})}}),$(".save").click(function(){var e=$('input[name="name"]'),t=$('input[name="email"]');if(t.val().isEmpty())return $.note({text:alerts.ERR_EMPTY_EMAIL,cont:$("#alert_box")}),!1;if(!validateEmail(t.val()))return $.note({text:alerts.ERR_INVALID_EMAIL,cont:$("#alert_box")}),!1;var i=e.val(),n=t.val();$.ajax({url:"/j_contact_change",type:"GET",dataType:"JSON",data:{email:n,name:i,group_mask:a}}).done(function(e){void 0!==exMail.currentParams.groupId?exMail.router.navigate("!contacts/g/"+exMail.currentParams.groupId,{trigger:!0}):exMail.router.navigate("!contacts",{trigger:!0})})}),$(".ib_groups_btn").ddOZ({autoClose:!1}),$(".ib_groups_btn").click(function(){var e=$(".ib_filter_item[data-group]",this),t={};e.removeClass("all one");for(var i=0;i<30;++i)0!=(1<<i&a)&&(t[i]=1);for(var n in t)e.filter('[data-group="'+n+'"]').addClass("all")});var n=$(".ib_filter_item[data-group]");n.click(function(){$(this).removeClass("one").toggleClass("all")}),$(".set_groups").click(function(){var e=0;n.filter(".all").each(function(){var t=0|$(this).data("group");e|=1<<t}),exMail.ui.contacts.setGroup(t,i,e),a=e,exMail.ui.contacts.refreshContactList(),$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")}),$(document).click()}),$(".ib_send_to_group_btn").click(function(){$(".tools_item > a").removeClass("active"),$(".mailbox_ln").addClass("active"),$._j_compose={to:[i+" <"+t+">"],name:i+" <"+t+">",set:!0},exMail.router.navigate("!inbox?compose=new",{trigger:!0})}),exMail.firstLoad&&(exMail.firstLoad=!1)}function t_init_contact(e){$(".rm_contact_one").on("click",function(e){if(confirm(alerts.NOTE_RM_CONTACT)){var t=$(this).data("email"),i=$(this).parent();$.ajax({url:"/j_contact_change",type:"GET",async:!1,dataType:"JSON",data:{email:t},success:function(e){console.log(e),i.remove()}}),exMail.router.navigate("!contacts",{trigger:!0})}e.stopImmediatePropagation()}),t_action=e,$(".main-list-item").on("click",function(){var t=$(this).data("email");void 0!==exMail.currentParams.groupId?exMail.router.navigate("!contacts/g/"+exMail.currentParams.groupId+"/"+t,{trigger:!0}):exMail.router.navigate("!contacts/"+t,{trigger:!0}),t_init_contact_info(e,t,$(this).data("name"),$(this).data("mask"))});var t=$(".toolbar"),i=t.find(".ib_select_btn .ib_filter_item");i.click(function(){t.find(".ib_select_btn").removeClass("ddoz_handler"),$(this).closest(".ib_select_filter_dd").removeClass("open_dd"),checkboxes(i.index(this))}),t.find(".ib_mail_check").click(function(){return checkboxes($(this).hasClass("all")?1:0),!1}),$(".ib_mail_list .check input").prop("checked",!1).change(function(){var e=$(this);e.is(":checked")?e.parent().parent().addClass("selected"):e.parent().parent().removeClass("selected"),checkboxes(0,!0),$anchor=$(this).parent()}),$(".ib_mail_list .check").click(function(e){e.stopImmediatePropagation()});var a=$(".ib_filter_item[data-group]");a.click(function(){$(this).removeClass("one").toggleClass("all")}),$(".ib_groups_btn").click(function(){var e=$(".ib_groups_btn .ib_filter_item[data-group]");e.removeClass("all one");var t={},i=$("#mail_list").find(".selected");i.each(function(){for(var e=$(this).data("mask"),i=0;i<30;++i)0!=(1<<i&e)&&(t[i]>0?t[i]+=1:t[i]=1)});var a=i.length;for(var n in t)console.log(n),t[n]==a?e.filter('[data-group="'+n+'"]').addClass("all"):t[n]>0&&e.filter('[data-group="'+n+'"]').addClass("one")}),$(".set_groups").click(function(){var e=0,t=0;a.filter(".all").each(function(){var t=0|$(this).data("group");e|=1<<t}),a.filter(".one").each(function(){var e=0|$(this).data("group");t|=1<<e}),$("#mail_list").find(".selected").each(function(){var i=$(this).data("email"),a=$(this).data("name"),n=$(this).data("mask"),o=e|t&n;exMail.ui.contacts.setGroup(i,a,o)}),exMail.router.navigate("!contacts",{trigger:!0}),$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")}),$(this).parent().parent().toggleClass("open_dd")}),$(".ib_rm_from_group_btn").click(function(){var e=$(this).data("group");$("#mail_list").find(".selected").each(function(){var t=$(this).data("email"),i=$(this).data("name"),a=$(this).data("mask");a&=~(1<<e),exMail.ui.contacts.setGroup(t,i,a),$(this).remove()}),exMail.ui.contacts.refreshContactList(1),$(document).click()}),$(".ib_send_to_group_btn").click(function(){$(".tools_item > a").removeClass("active"),$(".mailbox_ln").addClass("active");var e=[];$("#mail_list").find(".selected").each(function(){var t=$(this).data("email"),i=$(this).data("name");i=""!=i?i+" <"+t+">":t,e.push(i)}),$._j_compose={to:e,name:e.join(", "),set:!0},exMail.router.navigate("!inbox?compose=new",{trigger:!0})}),$(".ib_send_to_all_btn").click(function(){var e=[];$("#mail_list").find(".main-list-item").each(function(){var t=$(this).data("email"),i=$(this).data("name");i=""!=i?i+" <"+t+">":t,e.push(i)}),$._j_compose={to:e,name:e.join(", "),set:!0},exMail.router.navigate("!inbox?compose=new",{trigger:!0});var t=$(".tools_list > li > a");t.removeClass("active"),t.eq(0).addClass("active")}),contactUnselect(),$(".rm_sel_cont").click(function(){confirm(alerts.NOTE_RM_CONTACT)&&$("#mail_list").find(".selected").each(function(){var e=$(this).data("email"),t=$(this);$.ajax({url:"/j_contact_change",type:"GET",dataType:"JSON",data:{email:e},success:function(e){console.log(e),t.remove()}}),exMail.router.navigate("!contacts",{trigger:!0})})}),exMail.firstLoad&&(exMail.firstLoad=!1)}function unreadChack(){checked_list=getCheckedList(),has_unread=0,$.each(checked_list.split(","),function(e,t){if($('li[data-thread_id="'+t+'"]').hasClass("new"))return has_unread=1,!1});var e=$(".im_unread_btn"),t=$.parseJSON(e.attr("data-condition"));has_unread?(e.find(".ib_tt").text(t[1]),e.addClass("read_btn")):(e.find(".ib_tt").text(t[0]),e.removeClass("read_btn"))}function t_init_box(e){function t(e,t){if(t)_.contains(exMail.currentParams.chackedList,e)||exMail.currentParams.chackedList.push(e);else{var i=exMail.currentParams.chackedList.indexOf(e);exMail.currentParams.chackedList.splice(i,1)}}function i(){$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:cancel_list.join(",")},dataType:"text",complete:function(){$("#alert_box").hide(),resetGarbage(cancel_list.join(",")),mailSelect()}})}t_action=e,$(".ib_mail_list .check").click(function(e){$(".ib_select_btn").removeClass("ddoz_handler"),$(".ib_select_filter_dd, .to_label_dd").removeClass("open_dd"),e.stopImmediatePropagation()}),$(".main-list-item").on("click",function(){var e=$(this).data("thread_id"),t=$(this).data("count"),i=$(this).data("draft_count");t<=1&&i?exMail.router.navigate("!"+exMail.currentParams.action+"?compose="+e,{trigger:!0}):exMail.currentParams.sarchQuery.length?exMail.router.navigate("!"+t_action+"/"+e+"/"+exMail.currentParams.sarchQuery,{trigger:!0}):exMail.router.navigate("!"+t_action+"/"+e,{trigger:!0})});var a=$(".toolbar"),n=a.find(".ib_filter_item");n.click(function(){checkboxes(n.index(this)),unreadChack()}),a.find(".ib_mail_check").click(function(){return checkboxes($(this).hasClass("all")?1:0),unreadChack(),!1}),$(".ib_mail_list .check input").prop("checked",!1).change(function(e){var i=$(this),a=$(this).parent().parent().data("thread_id");i.is(":checked")?(i.parent().parent().addClass("selected"),t(a,!0)):(i.parent().parent().removeClass("selected"),t(a,!1)),checkboxes(0,!0),$anchor=$(this).parent(),$(".ib_mail_list .check i").removeClass("anchor"),$anchor.find("i").addClass("anchor"),unreadChack()}),console.log("exMail.currentParams.chackedList",exMail.currentParams.chackedList),function(e){if(!e.length)return 0;$.each(e,function(e,t){$("li[data-thread_id="+t+"]").find(".check").click()})}(exMail.currentParams.chackedList),mailUnselect();var o="";$(".im_spam_btn",a).unbind("click").click(function(){o=getCheckedList(),$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:o,mark_id:1},dataType:"text",complete:function(){cancel_list=o.split(","),addToGarbage(o),mailUnselect(1),$.note({text:alerts.IS_SPAM,cont:$("#alert_box"),handler:i,nameEvent:"click",eventElement:".rm_cancel"})}})}),$(".ib_refresh_btn",a).unbind("click").click(function(){$.ajax({url:"/j_box_info",dataType:"json",success:function(e){res=0|parseInt(e.new_count),res?Backbone.history.loadUrl(Backbone.history.fragment):$.note({text:alerts.NEW_MAIL_HASNT,cont:$("#alert_box")})}})}),$.__check_trash=!1,$(".im_unread_btn",a).unbind("click").on("click",function(){o=getCheckedList(),$.ajax({url:"/j_thread_list_is_new",type:"get",data:{thread_list:o,is_new:has_unread?0:1},dataType:"text",complete:function(){_.each(o.split(","),function(e,t){var i=$('li[data-thread_id="'+e+'"]');has_unread?i.removeClass("new"):i.addClass("new")}),has_unread=0,unreadChack(),boxInfo()}})}),$(".im_rm_btn",a).unbind("click").click(function(){$.__check_trash||(o=getCheckedList(),$.__check_trash=!0,$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:o,mark_id:2},dataType:"text",success:function(){cancel_list=o.split(","),addToGarbage(o),$.note({text:o.split(",").length>1?alerts.NOTE_MAILS_RM:alerts.NOTE_MAIL_RM,cont:$("#alert_box"),handler:i,nameEvent:"click",eventElement:".rm_cancel"}),mailUnselect(1),exMail.currentParams.chackedList=[],boxInfo()},complete:function(){$.__check_trash=!1}}))}),$(".main-list-item__btn").on("click",function(e){e.stopImmediatePropagation();var t=$(this),a=t.data("thread_id");if(t.hasClass("main-list-item__btn--remove")){if($.__check_trash)return;if(console.log("threadId",a),o=a,$.__check_trash=!0,t.hasClass("main-list-item__btn--remove-forever"))return confirm(alerts.DELET_CONFIRM)?void $.ajax({url:"/j_thread_list_delete",type:"get",data:{thread_list:o},dataType:"text",complete:function(){$.__check_trash=!1,mailUnselect(1),addToGarbage(o+","),exMail.currentParams.chackedList=[]}}):void($.__check_trash=!1);$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:o,mark_id:2},dataType:"text",success:function(){cancel_list=[o],addToGarbage(o+","),$.note({text:alerts.NOTE_MAIL_RM,cont:$("#alert_box"),handler:i,nameEvent:"click",eventElement:".rm_cancel"}),mailUnselect(1),exMail.currentParams.chackedList=[]},complete:function(){$.__check_trash=!1}})}}),$(".rm_drafts",a).unbind("click").click(function(){if(!confirm(window.alerts.DELET_CONFIRM_DRAFTS))return!1;var e=getCheckedList();e.length||(e=getAllList()),$.ajax({url:"/j_thread_list_drafts_delete",type:"get",dataType:"json",async:!1,data:{thread_list:e},success:function(t){1==t.result||2==t.result?console.log("rm draft: ",e):console.log("Ошибка при удалении черновика.")}}),removeCheckedElements(e)}),$(".im_rm_trash_btn").unbind("click").click(function(){return confirm(alerts.DELET_CONFIRM)?($.ajax({url:"/j_box_delete",type:"get",dataType:"text",success:function(e){Backbone.history.loadUrl(Backbone.history.fragment)}}),!1):0}),$(".im_check_back_btn").unbind("click").click(function(){$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:getCheckedList()},dataType:"text",success:function(e){Backbone.history.loadUrl(Backbone.history.fragment)}})}),$(".im_check_rm_btn").unbind("click").click(function(){confirm(alerts.REMOVE_FOREVER+"?")&&($.note({text:alerts.REMOVE_MAILS,cont:$("#alert_box"),fixed:!0,spin:!0}),$.ajax({url:"/j_thread_list_delete",type:"get",data:{thread_list:getCheckedList()},dataType:"text",complete:function(){$("#alert_box").empty(),removeCheckedElements(getCheckedList())}}))}),$(".im_rm_spam_btn").unbind("click").click(function(){return confirm(alerts.DELET_SPAM)?($.ajax({url:"/j_box_delete",type:"get",data:{box_id:4},dataType:"text",complete:function(){Backbone.history.loadUrl(Backbone.history.fragment)}}),!1):0}),$(".unmarck_labels").unbind("click").click(function(){var e=$(this).data("l_id");if(!(cancel_list=getCheckedList()).length)return!1;_.each(cancel_list.split(","),function(t,i){$.ajax({url:"/j_thread_mark/"+t,data:{box_id:e,is_mark:0},dataType:"json",success:function(e){console.log(e)}})}),exMail.currentParams.chackedList=[],removeCheckedElements(cancel_list),$.note({text:alerts.LABEL_REMOVED,cont:$("#alert_box")})}),$(".to_label_dd li[data-l_id]").unbind("click").click(function(){var e=$(this).data("l_id"),t=$(this).text();if(!(cancel_list=getCheckedList()).length)return!1;_.each(cancel_list.split(","),function(i,a){$.ajax({url:"/j_thread_mark/"+i,data:{box_id:e,is_mark:1},dataType:"json",success:function(a){console.log(a),a.result&&addLabelUI(i,e,t)}})}),exMail.currentParams.chackedList=[]})}function addLabelUI(e,t,i){var a=[];_.each(exMail.currentParams.labels,function(e,i){if(e[0]==t)return a=e,!1});var n=$("li[data-thread_id="+e+"]"),o=n.find(".label-small-list"),s='<li class="label-small-item" style="background-color: #'+a[2].color+'" data-f="'+t+'">'+i+"</li>";n.css({"background-color":"#"+a[2].color,zIndex:99,borderBottom:"1px solid #"+a[2].color,opacity:".8"}),setTimeout(function(){n.removeAttr("style")},500);var r=o.find("li:last-child").prev();console.log("len",o.find("li[data-f]").length),o.find("li[data-f]").length>2?(o.find("li:last-child").attr("title",o.find("li:last-child").attr("title")+" "+r.text()),r.remove()):2==o.find("li[data-f]").length&&2==o.find("li").length&&(o.append('<li class="label-small-item label-small-item--last" title="'+r.text()+'">...</li>'),r.remove()),o.prepend(s),$.note({text:alerts.LABEL_ADDED,cont:$("#alert_box")})}function openMsg(e,t,i,a,n){function o(o){e.html=o.html,s=o.ex_link||[],o.halva=o.halva||[],e.file_size&&(e.file_size=$.formatSize(e.file_size));try{if(e.upload_list){var r=[];_.each(e.upload_list,function(e,t){var i=e.content_id.trim();i.length&&_.contains(exMail.currentParams.cids,i)||(e.size=$.formatSize(e.size),r.push(e))}),e.upload_list=r;var l=e.upload_list.length-r.length;l||(l=e.upload_list.length),e.file_count=l}}catch(e){console.wran(e.message)}updateFileList(e),updateExFileList(e,s,"ex"),updateExFileList(e,o.halva,"halva"),e.msg_time_full=timeConverter(0|e.msg_time),e.msg_time=timeConverter(0|e.msg_time,!0),e.avatar_data=getAvatart(e.from,getLoginColor(e.from)),e.is_compose&&(e.to=_.map(e.to,function(t,i){return e.to_name[i].length?e.to_name[i]+" <"+t+">":t})),e.to_prepare=_.map(e.to,function(t,i){return'<span class="js-user-mail-tt" data-user="'+e.to_name[i]+'" data-mail="'+t+'">'+(e.to_name[i]?e.to_name[i]:t)+"</span>"});var d=$.htmlTmpl(e.is_compose?"t_compose":"t_read",e),c=$(d);if(c.find(".im_mail_body").find('div[dir="ltr"]').removeAttr("id").removeAttr("class"),e.is_compose&&($(".app-main-js").addClass("app-thread-compose"),c.find(".loaded").on("click",getFile),exMail.currentParams.aliases.length>1&&c.find(".answer_from").val(e.from),exMail.currentParams.$redactor=c.find(".msg_content"),exMail.currentParams.$redactor.redactor({toolbarExternal:c.find("#toolbar_layer_id"),replaceDivs:!1,formatting:!1,cleanOnPaste:!1,source:!1,lang:"en",italicTag:"i",focus:!e.forward,initCallback:function(){if(exMail.TMP_CONTENT.length)$code=$("<div>",{html:exMail.TMP_CONTENT}),console.log(exMail.TMP_CONTENT);else{$code=$("<div>",{html:this.code.get()}),$code.find(".gmail_quote").removeAttr("contenteditable");var e=$code.find(".gmail_quote").prev().get(0);e&&"BR"==e.tagName.toUpperCase()&&($code.find(".gmail_quote").prev().remove(),console.log("remove first br")),$code.find(".gmail_quote").after("<br>")}if(parseInt($.uConfig.quote)&&($code.find(".gmail_quote").addClass("active"),$code.find(".quote").remove()),$code.find(".gmail_quote").after("<br>"),this.code.set($code.html()),n&&parseInt($.uConfig.signature.stat)&&!exMail.TMP_CONTENT.length){var t=$('<div class="signature"></div>');t.html(nl2br($.uConfig.signature.text)),t.find("script").remove(),this.$editor.prepend(t).prepend("<br><br>-- \n")}},dropdownShownCallback:function(e){var t=e.button,i=e.dropdown,a=t.offset().top;i.css("top",a-i.innerHeight()+"px")},keydownCallback:function(e){var t=this.selection.getCurrent(),i=$(".ib_mail_list_wr");if(exMail.TMP_CONTENT="need",isElement(t)&&13==e.keyCode){$(".ib_mail_list_wr").scroll();var a=$(t).position().top+Math.abs($(".compose").position().top)+100,n=i.scrollTop(),o=i.height();(a<n||a+65>n+o)&&i.scrollTop(i.scrollTop()+20)}}})),a)t&&(c.hide(),$(t).replaceWith(c),c.fadeIn(400));else{t?($(t).remove(),$("#buttons").before(c)):e.is_compose&&i>1?$("#buttons").append(c).show():$("#buttons").before(c);$.user_email,$.host_email}if(e.is_compose&&(compose_id=e.msg_id,$(".compose-control-btn").removeClass("compose-control-btn--active"),e.to.length?1==e.to.length?$("#reply_button").addClass("compose-control-btn--active"):e.to.length&&$("#reply_all_button").addClass("compose-control-btn--active"):$("#forward_button").addClass("compose-control-btn--active")),e.is_compose&&i>=1){clearAirButton();$("#fix_wr1"),$("#toolbar_layer_id"),$("#compose_text"),$(".ib_mail_list_wr");var u=!0;$(".ib_mail_list_wr").on("scroll",function(){var e,t,i;e=$("#mail_list").height(),t=$(".redactor-editor").height(),i=$(this).scrollTop(),$(".r-side").height()-(e-t-i)<100||$(this).scrollTop()+$(this).innerHeight()+24>=$(this)[0].scrollHeight?$(this).removeClass("thread-compose-fix-block"):($(".cps_btns_list").removeAttr("style"),$(this).addClass("thread-compose-fix-block"),u=!0),is_top_mail_listWr($(this))}),$(".ib_mail_list_wr").scroll()}setMsgClicks(e.msg_id),setPreview(e.msg_id),setVideo(e.msg_id),setAudio(e.msg_id);for(var p=0;p<s.length;++p){var h=e.msg_id+"_"+s[p];setMsgClicks(h),setPreview(h),setVideo(h),setAudio(h)}$("#buttons").find("[name=to]").focus(function(){$("#buttons").find(".inline_emails").hide()}).blur(function(){var e=[];if($("#buttons").find(".adresable li").each(function(){e.push($(this).find("[data-email]").attr("data-email"))}),!e.length)return 0;$("#buttons").find(".to").hide(),$("#buttons").find(".inline_emails").show().text(e.join(", "))}).focus(),$("#buttons").find(".inline_emails").on("click",function(){$("#buttons").find(".to").show(),$(this).hide(),$("#buttons").find("[name=to]").focus()})}a||(a=!1);var s=[];e.html?$.htmlBody(e,o):o({html:"",ex_link:[]})}function updateExFileList(e,t,i){if(t.length>0){e.ex_file_list=[];for(var a={},n=0;n<t.length;++n){var o=t[n];if(!a[o]){var s={};s.ex_object_id=o,s.ex_upload_list=[],s.ex_audio_list=[],s.ex_image_list=[],s.ex_video_list=[],s.ex_file_count=0,a[o]=1,$.ajax({url:"https://exapi.mail.ex.ua/r_view/"+o,dataType:"XML",async:!1}).done(function(e){$(e).find("file").each(function(e,t){var i=(t=$(t)).attr("upload_id"),a=t.attr("name"),n=t.attr("size"),r=(t.attr("md5"),t.attr("type_id")),l=t.attr("preview"),d=t.attr("rotate"),c="http://www.ex.ua/load/"+o+"/"+i+"/"+encodeURIComponent(a),u=l;12!=o.length&&(c="http://www.ex.ua/load/"+i+"/"+encodeURIComponent(a)),exMail.exObjects[i]={link:u,name:a,size:n,fileLink:c};var p={has_magick:"1",upload_id:"",name:a,type_id:r,preview:l,file_link:c,rotate:d,size:$.formatSize(n)};2==r||a.match(/\.(mp4)$/i)?s.ex_video_list.push(p):a.match(/\.(mp3|ogg)$/i)?s.ex_audio_list.push(p):1==r||a.match(/\.(jpg|jpeg|gif|png|bmp|tif|tiff)$/i)?s.ex_image_list.push(p):s.ex_upload_list.push(p)})}),s.ex_file_count=s.ex_upload_list.length+s.ex_audio_list.length+s.ex_image_list.length+s.ex_video_list.length,e.halva=!1,s.ex_file_count&&(e.ex_file_list.push(s),"halva"==i&&(e.halva=!0))}}}}function setVideo(e){function t(e){s.add(r).show(),0==e&&s.hide(),e==v.length-1&&r.hide()}function i(e){if(console.log(e),!(v.length<10))return e<0&&(e=0),e>v.length-1&&(e=v.length-1),e<5?u.css("left","0px"):e>v.length-5?u.css("left",-60*(v.length-5-4)+"px"):u.css("left",-60*(e-4)+"px"),e}function a(e){if(u.attr("data-pv")!=e){var t=[];console.log("$mp4",v.length),v.each(function(e,i){t.push($("<div>").attr("data-npp",e).css({background:"#000 url(/i/movie.png) 50% 50% no-repeat"}).click(function(){$(i).find(".play").click()})),$(this).attr("data-npp",e)}),u.attr("data-pv",e).empty().append(t),u.css("width",60*v.length+"px").css("left","0px"),v.length<=9?(_.add(m).off("click").hide(),u.parent().width(60*v.length-10)):(_.show(),m.show(),u.parent().width(530),_.off("click").click(function(){var e=0|u.css("left").replace("px","");(e=Math.abs(e)-180)<0&&(e=0),u.css("left",-e+"px")}),m.off("click").click(function(){var e=0|u.css("left").replace("px",""),t=u.width()-540;(e=Math.abs(e)+180)>t&&(e=t),u.css("left",-e+"px")}))}}function n(e){console.log(e.data.id),a(e.data.id),x=v.index($(this).parent()),"file"==e.data.prop&&(x=f.index($(this))),g=$(this).parent().data("upload_id"),t(x),i(x),s.unbind().click(function(){return--x<0&&(x=0),v.eq(x).find(".play").click(),i(x),!1}),r.unbind().click(function(){return++x>v.length-1&&(x=v.length-1),v.eq(x).find(".play").click(),i(x),!1});var n=$(this).parent().find(".name").text();if("file"==e.data.prop&&(n=exMail.exObjects[$(this).data("file")].name),h.text(n),g)c.empty().hide(),d.show(),exMail.videojs?$(exMail.videojs.el()).show():exMail.videojs=videojs(d.get(0),{width:"100%",height:"100%"},function(){this.foxPlugin()}),exMail.videojs.src({type:"video/mp4",src:"/get/"+g}),p.eq(0).attr("href","/load/"+g).attr("target","_blank").html(alerts.DOWNLOAD+" <span>"+$(this).parent().find(".size").text()+"</span>");else{var l=$(this).parent().data(e.data.prop),_=$(this).parent().data("npp");size=$(this).parent().find(".size").text(),file_link=$(this).parent().data("file_link"),"file"==e.data.prop&&(l=exMail.exObjects[$(this).data("file")].link,_=f.index($(this)),size=$.formatSize(exMail.exObjects[$(this).data("file")].size),file_link=exMail.exObjects[$(this).data("file")].fileLink),c.empty().hide(),d.show(),exMail.videojs?$(exMail.videojs.el()).show():exMail.videojs=videojs(d.get(0),{width:"100%",height:"100%"},function(){this.foxPlugin()}),exMail.videojs.src({type:"video/mp4",src:l}),p.eq(0).attr("href",file_link).attr("target","_blank").html(alerts.DOWNLOAD+" <span>"+size+"</span>")}u.find("div").removeClass("active"),u.find('div[data-npp="'+_+'"]').addClass("active"),o.show(),$._pause&&$._pause()}console.log("id",e);var o=$("#video_box"),s=o.find(".prev"),r=o.find(".next"),l=o.find(".close"),d=o.find("video").addClass("video-js vjs-default-skin"),c=$("#player_window"),u=o.find(".list"),p=o.find(".file_download"),h=o.find(".file_name"),_=o.find(".ssc_prev"),m=o.find(".ssc_next"),f=$("#"+e+"_msg").find("table a[data-file]");f.length&&(e=e+"_"+$("#"+e+"_msg").find("table[data-object]").data("object"));var g,v=$("#"+e+"_upload_body, #"+e+"_ex_body").find(".upload.mp4"),x=0;v.find(".play").unbind().click({id:e,prop:"preview"},n),f.unbind().click({id:e,prop:"file"},n),l.unbind().click(function(){"object"==typeof exMail.videojs&&(exMail.videojs.pause(),$(exMail.videojs.el()).hide(),console.info("VideoJs stoped")),c.empty().hide(),o.hide()})}function setPreview(e,t){function i(e){r.add(l).show(),0==e&&r.hide(),e==f.length-1&&l.hide()}function a(e){if(!v)return e<0&&(e=0),e>f.length-1&&(e=f.length-1),e<6?d.css("left","0px"):e>f.length-5?d.css("left",-60*(f.length-5-4)+"px"):d.css("left",-60*(e-4)+"px"),e}function n(e){if(d.attr("data-pv")!=e){var t=[];f.each(function(e,i){var a=$(this).data("upload_id");if(a)t.push($("<div>").attr("data-npp",e).css({background:"url(/show/"+a+"?resize=80) 50% 50% no-repeat","background-size":"contain"}).click(function(){$(i).click()}));else{var n=$(this).data("preview"),o=$(this).data("rotate");t.push($("<div>").attr("data-npp",e).css({background:"url("+n+"?100x"+(o?","+o:"")+") 50% 50% no-repeat","background-size":"contain"}).click(function(){$(i).click()}))}$(this).attr("data-npp",e)}),d.attr("data-pv",e).empty().append(t),d.css("width",60*f.length+"px").css("left","0px"),f.length<=9?(_.add(m).off("click").hide(),d.parent().width(60*f.length-10),v=!0):(_.show(),m.show(),d.parent().width(530),v=!1,_.off("click").click(function(){var e=0|d.css("left").replace("px","");(e=Math.abs(e)-180)<0&&(e=0),d.css("left",-e+"px")}),m.off("click").click(function(){var e=0|d.css("left").replace("px",""),t=d.width()-540;(e=Math.abs(e)+180)>t&&(e=t),d.css("left",-e+"px")}))}}var o=$("#preview_box"),s=o.find(".view"),r=o.find(".prev"),l=o.find(".next"),d=o.find(".list"),c=o.find(".close"),u=o.find(".file_link > a"),p=o.find(".file_name");d.empty();var h,_=o.find(".ssc_prev"),m=o.find(".ssc_next"),f=$("#"+e+"_upload_body, #"+e+"_ex_body").find(".upload.image"),g=0,v=!0;f.click({id:e},function(e){if(f=$("#"+e.data.id+"_upload_body, #"+e.data.id+"_ex_body").find(".upload.image"),n(e.data.id),r.unbind().click(function(){return--g<0&&(g=0),f.eq(g).click(),a(g),!1}),l.unbind().click(function(){return++g>f.length-1&&(g=f.length-1),f.eq(g).click(),a(g),!1}),g=f.index(this),h=$(this).data("upload_id"),i(g),a(g),p.text($(this).find("span").eq(0).text()),console.log("upload_id",h),h)s.attr({src:"/show/"+h+"?resize=1280"}),u.eq(0).attr("href","/load/"+h).attr("target","_blank").text(alerts.DOWNLOAD+" - "+$(this).find("span").eq(1).text()),u.eq(1).attr("href","/get/"+h).attr("target","_blank").text(alerts.FULL_SIZE);else{var t=$(this).data("file_link"),c=$(this).data("preview"),_=$(this).data("rotate");s.attr({src:c+"?1600"+(_?","+_:"")}),u.eq(0).attr("href",t).attr("target","_blank").text(alerts.DOWNLOAD+" - "+$(this).find("span").eq(1).text()),u.eq(1).attr("href",c).attr("target","_blank").text(alerts.FULL_SIZE)}o.show(),d.find("div").removeClass("active"),d.find('div[data-npp="'+$(this).data("npp")+'"]').addClass("active")}),c.unbind().click(function(){o.hide()})}function formatTime(e){var t=e/60|0;return e-=60*t,t<10&&(t="0"+t),e<10&&(e="0"+e),t+":"+e}function setAudio(e){$("#"+e+"_upload_body, #"+e+"_ex_body").find(".upload.audio").length&&$.getScript("/js/soundmanager2/soundmanager2-nodebug-jsmin.js").done(function(e,t){var i,a,n,o=$(),s=$(),r=$(),l=($(),$()),d=$(),c=-1,u=0,p=0,h=0,_="",m=0;soundManager.setup({url:"/js/soundmanager2/",flashVersion:9,ontimeout:function(){},onready:function(){i=soundManager.createSound({id:"exSound"}),$._atexit=function(){try{i.stop(),i.destruct()}catch(e){}},$._pause=function(){i.pause(),l.removeClass("pause"),m=2},(o=$(".audio .play")).unbind().on("click",function(){function e(){o.removeClass("pause"),o.parent().find(".progress").unbind().find("div > div").css("width","0%"),o.parent().find(".time").text("00:00"),m=0}if(l=$(this),c!=o.index(l)){c=o.index(l),e(),(s=l.parent().find(".progress")).on("mousemove",function(e){a=$(this).offset(),n=e.pageX-a.left,d.text(formatTime(n*p/418|0)).css("left",n+"px")}).on("mouseenter",function(){$(this).find("i").fadeIn(100)}).on("mouseleave",function(){$(this).find("i").fadeOut(100)}).on("click",function(e){a=$(this).offset(),n=e.pageX-a.left,i.setPosition(1e3*(n*p/418|0))}),r=l.parent().find(".time"),d=l.parent().find(".progress > i"),s=s.find("div > div");var t=$(this).parent().data("upload_id");_=t?"/get/"+$(this).parent().data("upload_id"):$(this).parent().data("file_link"),m=1,l.addClass("pause"),i.stop(),i.play({url:_,multiShot:!1,onplay:function(){},onpause:function(){},onresume:function(){},onstop:function(){},onfinish:function(){e(),c=-1},whileplaying:function(){u=(0|this.position)/1e3|0,p=this.duration/1e3|0,h=(1e3*this.position/this.duration|0)/10,s.css("width",h+"%"),r.text("-"+formatTime(p-u))}})}else 1==m?(i.pause(),l.removeClass("pause"),m=2):2==m&&(i.resume(),l.addClass("pause"),m=1)})}})})}function updateFileList(e){var t=[];if(e.audio_list=[],e.image_list=[],e.pdf_list=[],e.video_list=[],e.upload_list)for(var i in e.upload_list){var a=e.upload_list[i];a.name.match(/\.(mp4)$/i)?e.video_list.push(a):a.name.match(/\.(mp3|ogg)$/i)?e.audio_list.push(a):a.name.match(/\.(jpg|jpeg|gif|png|bmp|tif|tiff)$/i)?e.image_list.push(a):a.name.match(/\.(pdf)$/i)?e.pdf_list.push(a):t.push(a)}e.upload_list=t}function getMsgFormData(e,t){var i=[],a=$("#"+e+"_msg");a.find(".adresable li").each(function(){var e=$(this).data("email")||$(this).text();validateEmail(e)&&i.push(e)});var n=a.find(".redactor-editor");void 0===t&&(n.find(".gmail_quote").removeClass("active"),n.find("i.quote").remove());var o=a.find(".msg_content"),s=$("<div>",{html:o.redactor("code.get")});s.find(".gmail_quote").eq(0).before('<div id="ex_attached_files"></div>'),s.find("img").each(function(){var e=$(this).data("sid");e&&($(this).attr("src","cid:"+e),console.log(e))});var r,l={to:i.join(", "),subject:$("#"+e+"_subject").val(),body:s.html()};return r=exMail.currentParams.aliases.length>1?l.from=$(".answer_from option:selected").val():$.user_email,exMail.user[0].name.length?l.from=exMail.user[0].name+" <"+r+">":l.from=r,l}function lineClick(e,t){$(e).data("msg_id")?$.getJSON("/j_thread_read/"+$(e).data("msg_id")).done(function(t){if(openMsg(t,e,0|t.msg_count,!0),!$(".im_mail_closed").length&&!$("#line_more").length){is_turn=1;var i=$(".turn_all_btn"),a=$.parseJSON(i.attr("data-tt"));i.find(".ib_tt").text(a[0])}}):$.getJSON("/j_thread_more/"+t_thread_id,{offset:1,limit:parseInt($("#more_count").text(),10)}).done(function(e){for(var i=0;i<e.length;i++)e[i].msg_time_full=timeConverter(0|e[i].msg_time),e[i].msg_time=timeConverter(0|e[i].msg_time,!0),e[i].avatar_data=getAvatart(e[i].from,getLoginColor(e[i].from));$("#line_more").replaceTmpl("t_row",e),setLineClicks(),1==t&&$("div.line").click()}).fail(function(){console.warn("Fail load: j_thread_more")})}function setLineClicks(){$("div.thread > .im_mail_closed, #line_more").unbind().click(function(){lineClick(this)})}function uploadClick(e){var t=$(this).parent().data("upload_id"),i=$(this).parent().data("file_link"),a=$(this).data("method");return console.log(i),a?(window.location=a+t,!1):i?(window.location=i,!1):(t&&(e&&e.altKey?window.location="/load/"+t:window.open("/get/"+t)),!1)}function deleteMsg(e){$.ajax({url:"/j_msg_delete/"+e,async:!1,type:"get",dataType:"json",success:function(t){LOCKED_DRAFT_CLICK=!1,1==t.result?($("#"+e+"_msg").remove(),t.msg_id&&(t_msg_id=t.msg_id),$("#buttons").show()):2==t.result?($("#"+e+"_msg").remove(),t.msg_id&&(t_msg_id=t.msg_id),window.history.back()):alert("Ошибка при удалении сообщения.")}}).fail(function(){alert("Ошибка при удалении сообщения.")})}function clearAirButton(){var e=$("#fix_wr1"),t=$(".acceptors"),i=$("#compose_text");$(".ib_mail_list_wr").off("scroll"),t.removeClass("acceptors_fix"),e.removeClass("btns_fix"),i.removeClass("offset_fix")}function deleteMsgClick(){var e=compose_id;$(".compose-control-btn").removeClass("compose-control-btn--active"),$(".redactor-toolbar-tooltip").remove(),$(".app-main-js").removeClass("app-thread-compose"),deleteMsg(e),boxInfo(),clearAirButton()}function sendMsgClick(e){if($(".compose-control-btn").removeClass("compose-control-btn--active"),window.isProgress)return $.note({text:alerts.WAIT_PROGRESS,cont:$("#alert_box"),fixed:!0}),window.autoSend=!0,$("#auto_send_reset").off("click").on("click",function(){window.autoSend=!1,$("#alert_box").hide(),$.note({text:alerts.CANSEL_AUTOSEND,cont:$("#alert_box")})}),!1;window.isProgress=!1,window.autoSend=!1,$("#att_mod").removeClass("att_open"),$("#alert_box").hide();var t=$(this).closest(".compose").data("msg_id"),i=getMsgFormData(t),a="j_compose_send/"+t;$.post("/"+a,i).then(maybeCaptcha(a,i)).then(function(e){e.err?alert(e.err.msg):($.note({text:alerts.NOTE_MAIL_SENDED,cont:$("#alert_box")}),Backbone.history.loadUrl("!sent/"+e.thread_id))}).fail(function(){alert("Error send message.")})}function deleteUploadClick(e){e.stopImmediatePropagation();var t=$(this).parent(),i=t.data("msg_id"),a=t.data("upload_id");a?$.getJSON("/j_upload_delete/"+a).done(function(e){e.result?(t.remove(),$("#"+i+"_upload_body > div.upload").length||$("#"+i+"_upload_body").hide()):alert("Ошибка при удалении файла.")}).fail(function(){alert("Ошибка при удалении файла.")}):(uploader[i].removeQueuedFile(t.data("file_id")),t.remove(),$("#"+i+"_upload_body > div.upload").length||$("#"+i+"_upload_body").hide())}function subjectChanged(e){var t=$(this).val(),i=t;t=t.length?t:"(без темы)",$("div#subject").text(t),document.title=t,""==i?$(this).parent().parent().removeClass("hide"):$(this).parent().parent().addClass("hide")}function onBlurExtMenu(){$(".thread .msg div.ext").removeClass("active")}function setMsgClicks(e){if($("#"+e+"_upload_body div.upload > i").click(uploadClick),$("#"+e+"_ex_body div.upload > i").click(uploadClick),$("#"+e+"_msg .im_sett_btn").ddOZ({handlerClass:"im_sett_btn_open"}),$("div#"+e+"_msg").data("is_compose")){$("div#"+e+"_upload_body").on("click",".delete",deleteUploadClick),void 0===uploader?$.getScript("/js/plupload.full.min.js").done(function(t,i){$.getScript("/js/uploader.js").done(function(t,i){newUploader(e)}).fail(function(e,t,i){})}).fail(function(e,t,i){}):newUploader(e),$("input#"+e+"_subject").on("input",subjectChanged);var t=$("#"+e+"_to");setTags(t,$(".compose")),t.val()&&((t=$("#"+e+"_subject")).length&&!t.val()||(t=$("#"+e+"_body"))),t.focus()}$("#"+e+"_delete_button").click(function(){exMail.TMP_CONTENT="",deleteMsgClick()}),$("#"+e+"_send_button").on("click eAutoSend",sendMsgClick);var i=$(".im_mail_body"),a=$(".redactor-editor");if(i.each(function(){var e=$(this).find(".gmail_quote").first();parseInt($.uConfig.quote)&&e.addClass("active"),0==e.find("i.quote").length&&e.prepend($("<i>",{class:"quote noselect"}))}),a.length>0){var n=a.find(".gmail_quote").first();n.find("i.quote").remove(),parseInt($.uConfig.quote)||n.prepend($("<i>",{class:"quote noselect"}))}var o=$(".thread .msg div.ext").unbind("click").click(function(){return o.removeClass("active"),$(this).addClass("active"),!1}),s=function(e,t){$.ajaxSetup({async:!1});var i=$(".compose"),a="";if("forward"==t?(t=!0,a="?type=forward"):"reply"==t?(t=!1,a="?type=reply"):(t=!1,a="?type=reply_all"),i.length&&deleteMsgClick(),LOCKED_DRAFT_CLICK)return!1;LOCKED_DRAFT_CLICK=!0,exMail.TMP_CONTENT="",$.getJSON("/j_thread_compose/"+e+a).done(function(e){if(e.msg_id){e.forward=t,openMsg(e,void 0,2,!1,!0);var i=$(".thread");i.scrollTop(i[0].scrollHeight)}LOCKED_DRAFT_CLICK=!1}),$.ajaxSetup({async:!0})};$(".thread .im_open_ctrl_bl .im_replay_toall_btn").unbind("click").click(function(){var e=$(this).closest(".msg").data("msg_id");return s(e,""),!1}),$(".im_sett_btn .js_print").unbind("click").click(function(){window.open("/#!print/msg/"+$(this).data("id"),"_blank").focus()}),$(".im_sett_btn .js_trash").unbind("click").click(function(){if(!confirm(alerts.DELET_CONFIRM))return 0;deleteMsg($(this).closest(".msg").data("msg_id")),$(this).closest("[data-dd]").removeClass("open_dd"),$(this).closest("[data-handler]").removeClass("im_sett_btn_open")}),$(".im_sett_btn .js_forward").unbind("click").click(function(){var e=$(this).closest(".msg").data("msg_id");return s(e,"forward"),$(this).closest("[data-dd]").removeClass("open_dd"),$(this).closest("[data-handler]").removeClass("im_sett_btn_open"),!1}),$(".im_sett_btn .js_reply_all").unbind("click").click(function(){var e=$(this).closest(".msg").data("msg_id");return s(e,""),$(this).closest("[data-dd]").removeClass("open_dd"),$(this).closest("[data-handler]").removeClass("im_sett_btn_open"),!1}),$(".im_sett_btn .js_reply").unbind("click").click(function(){var e=$(this).closest(".msg").data("msg_id");return s(e,"reply"),$(this).closest("[data-dd]").removeClass("open_dd"),$(this).closest("[data-handler]").removeClass("im_sett_btn_open"),!1}),$(document).unbind("click",onBlurExtMenu).click(onBlurExtMenu)}function validateEmail(e){return/(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/.test(e)}function setTags(e,t){function i(a,n,c){if(r=!1,isBlank(a))return 0;for(var u=a.split(/[,;]/),p=0;p<u.length;p++){var a=$.trim(u[p]),h=!1;if(e.parent().find(".adresable li span").each(function(){var e=/\S+@\S+|\{(?:\w+, *)+\w+\}@[\w.-]+/,t=e.exec($(this).text());if(t?t[0].replace("<","").replace(">",""):(t=e.exec($(this).data("email")))&&t[0].replace("<","").replace(">",""),$(this).text()==a||$(this).data("email")==a)return h=!0,!1}),!h){var _=$("<li/>",{class:"tag"}).append($("<span>",{text:n||a,"data-email":a}),$("<i>").click(d));validateEmail(u[p])||_.addClass("tag_wrong"),c?e.before(_):t.find(".adresable").append(_),_.dblclick(function(){i(e.val(),void 0,r);var t=$(this).find("span").eq(0).text();$(this).before(e),$(this).remove(),r=!0,setTimeout(function(){e.val(t),o.click(),e.trigger("update")},0)}),l()}}e.val(""),t.find(".adresable").sortable("refresh"),s.find(".to .adresable").append(e),o.click(),e.trigger("tag-add")}function a(){return"none"!==$(".ui-autocomplete").css("display")}function n(e){if(isBlank(e)||void 0===e)return!1;var t=detect_mail_note(e);console.log("dirtyMails",t),_.each(t,function(e){validateEmail(e)&&i(e)})}e.autoGrowInput({comfortZone:15,minWidth:50,maxWidth:2e4});var o=t.find(".inline_emails"),s=t.find(".acceptors"),r=!1;t.find(".adresable").sortable({cancel:".disabled"});var l=function(){0==e.parent().find(".tag").length?e.parent().parent().removeClass("hide"):e.parent().parent().addClass("hide")},d=function(){$(this).parent().remove(),l()},c=[];$.getJSON("/j_contact_list").done(function(t){$._user_contacts=t;var a=[];if($._user_group)for(var n=0;n<$._user_group.length;n++){var o=$._user_group[n],s=exMail.ui.contacts.getContactCount($._user_contacts,0|o[0]);if(s>0){var r=o[1]+" ["+s+"]";a.push({label:r,value:r,data:o})}}_.each(t,function(e,t){""!=e[1]?a.push({label:e[1]+" <"+e[0]+">",value:e[1]+" <"+e[0]+">",mass:e[3]}):a.push({label:e[0],value:e[1],mass:e[3]})}),$.extend($.ui.autocomplete.prototype,{_renderItem:function(t,i){var a=e.val(),n="",o="",s=i.label.split(" ");if(s.length>=2){if(2!=s.length){var r=s.pop(),l=s.join(" ");s[0]=l,s[1]=r}s[1]=s[1].replace("<","").replace(">","")}i.value2=s;var d=new RegExp("^("+$.ui.autocomplete.escapeRegex(a)+")","i");if(o=_.escape(i.value2[0]).replace(d,"<span class='find_res'>$1</span>"),void 0!==i.value2[1]){var c=new RegExp("("+$.ui.autocomplete.escapeRegex(a)+")","i");n=_.escape(i.value2[1]).replace(c,"<span class='find_res'>$1</span>")}return $("<li>",{"data-value":i.value}).data("item.autocomplete",i).append("<div>"+o+"</div>").append("<div>"+n+"</div>").appendTo(t)}}),e.autocomplete({source:function(e,t){var i=new RegExp(""+$.ui.autocomplete.escapeRegex(e.term),"i"),n=[];_.each(a,function(e,t){(i.test(e.value)||i.test(e.label))&&n.push({value:e.label,mass:e.mass,data:e.data})}),console.log(n),t(_.map(_.sortBy(n,"mass").reverse(),function(e,t){return e}))},minLength:1,autoFocus:!0,focus:function(e,t){if(t.item.data){var i=0|t.item.data[0];c=exMail.ui.contacts.filterContact($._user_contacts,i)}e.preventDefault()},open:function(e,t){var i=$(".ui-autocomplete"),a=$(window),n=i.position(),o=n.left+i.width()-a.width();if(o>0){var s=n.left-o;i.css({left:s})}},select:function(t,a){if(9==t.keyCode)return!1;if(a.item.data)for(var n=0|a.item.data[0],o=exMail.ui.contacts.filterContact($._user_contacts,n),s=0;s<o.length;++s){var r=o[s][1],l=o[s][0];i(r=""!=r?r+" <"+l+">":l,r)}else i(a.item.label,a.item.value);setTimeout(function(){e.val("")},0)},close:function(){}})}),e.keydown(function(e){if(8==e.which){if(!$(this).val())return $(this).parent().find("li.tag").last().remove(),e.preventDefault(),l(),!1}else(e.shiftKey&&(191===e.keyCode||52===e.keyCode)||32===e.keyCode||188===e.keyCode||13==e.which)&&(a()||13===e.keyCode||n($(this).val()))}).blur(function(){var e=detect_mail_note($(this).val());_.each(e,function(e){validateEmail(e)&&i(e,void 0,r)})}),i(e.val())}function detect_mail_note(e){if(void 0===e)return[];var t=e.split(/[;,]/),i=[];return $.each(t,function(e,t){!function(e){var t=e.replace(/((<|\))?[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}(>|\))?)/gi,function(e){return e+"="}).split("=");$.each(t,function(e,t){t&&i.push($.trim(t))})}(t)}),i}function t_init_thread2(e,t,i){t_thread_id=e,t_msg_id=0,t_action=t;var a=$("#mail_list").empty();a.tmpl("t_spiner");var n=$.getJSON("/j_thread_load/"+t_thread_id),o=$.ajax({url:"/j_box_name_list",data:{v:"refresh"},dataType:"json"}),s=$.ajax({url:"/j_alias_list",data:{v:"for_thread"},dataType:"json"});exMail.setMenu(0,{action:t}),$(".js-top-toolbar").empty(),$.when(n,o,s).done(function(t,a,n){function o(e,t,i){$.ajax({url:"/j_thread_mark/"+i,data:{box_id:t,is_mark:e},dataType:"json",success:function(t){console.log(t);var i=e?window.alerts.LABEL_ADDED:window.alerts.LABEL_REMOVED;$.note({text:i,cont:$("#alert_box")})}})}var s=t[0];exMail.utils.setTitle(s.subject),exMail.currentParams.labels=converLabelsData(a[0]),exMail.currentParams.aliases=n[0],s.labels=[];var r=[];if(s.labels=_.map(exMail.currentParams.labels,function(e,t){return e[2].checked=!1,_.contains(s.box_list,e[0])&&(e[2].checked=!0,r.push(e)),e}),s.labelsChecked=r,$("#mail_list").tmpl("t_thread",s).show(),t_msg_id=s.msg_id,s.msg_list){for(var l=0;l<s.msg_list.length;l++)s.msg_list[l].msg_time_full=timeConverter(0|s.msg_list[l].msg_time),s.msg_list[l].msg_time=timeConverter(0|s.msg_list[l].msg_time,!0);$("#buttons").beforeTmpl("t_row",s.msg_list),setLineClicks()}s.msg_count<=2&&setTimeout(function(){$(".turn_all_btn").hide()},10),s.msg.to.length<=1&&$("#reply_all_button").hide(),openMsg(s.msg,void 0,0|s.msg_count,!1),setUserAvatar();var d="";if(/^(f\d{3})$/i.test(t_action)){var c=t_action.split("f")[1];$(".js-top-toolbar").tmpl("t_thread_labels",{thread_id:e,labels:exMail.currentParams.labels,in_label:!0,action:c}),d="/j_box/"+c}else $(".js-top-toolbar").tmpl("t_thread_"+t_action,{thread_id:e,labels:exMail.currentParams.labels,in_label:!1,action:t_action}),d="/j_"+(i?"search":t_action);if($(".to_label").ddOZ({handlerClass:"to_label_handler",autoClose:!1}),$("#do_back").on("click",function(){$._atexit&&$._atexit();var e=exMail.currentParams.page?"/page/"+exMail.currentParams.page:"";exMail.currentParams.sarchQuery.length?exMail.router.navigate("!"+exMail.currentParams.action+"/s/"+exMail.currentParams.sarchQuery+e,{trigger:!0}):exMail.router.navigate("!"+exMail.currentParams.action+e,{trigger:!0})}),$(".to_label").find('input[type="checkbox"]').change(function(){var e=$(this).data("l_id"),t=$(this).parent().find("span").text(),i=$(this).data("color"),a=0;$(this).prop("checked")?(a=1,$(".labels-inline-list").prepend('<li data-l_id="'+e+'" class="labels-inline-list__item" style="background-color: #'+i+'" title=""><span>'+t+'</span><i class="labels-inline-list__remove-label"></i></li>')):$(".labels-inline-list__item[data-l_id="+e+"]").remove(),o(a,e,t_thread_id)}),$(".labels-inline-list").on("click",".labels-inline-list__remove-label",function(){var e=$(this).parent(),t=e.data("l_id");$(".to_label_dd input[data-l_id="+t+"]").prop("checked",!1),e.remove(),o(0,t,t_thread_id)}),parseInt(s.is_starred,10)){var u=$("#do_starred");u.addClass("ib_important_select_in"),u.attr("data-href","/j_thread_is_starred/"+e+"?is_starred=0")}$.ajax({url:d,type:"get",data:{p:0,per:200,s:exMail.currentParams.sarchQuery,box_id:searchOn[t_action]},dataType:"json",success:function(e){var t=0;$.each(e.thread_list,function(e,i){if(t_thread_id==i.thread_id)return t=e,!1});var i=e.thread_list[t?t-1:t].thread_id,a=e.thread_list[t==e.thread_list.length-1?t:t+1].thread_id;exMail.currentParams.sarchQuery.length?($(".ib_mail_prev").attr("href","#!"+t_action+"/"+i+"/"+exMail.currentParams.sarchQuery),$(".ib_mail_next").attr("href","#!"+t_action+"/"+a+"/"+exMail.currentParams.sarchQuery)):($(".ib_mail_prev").attr("href","#!"+t_action+"/"+i),$(".ib_mail_next").attr("href","#!"+t_action+"/"+a)),exMail.firstLoad&&(exMail.firstLoad=!1)}}),$("#do_spam").click(function(){$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:e,mark_id:1},dataType:"text",complete:function(){$.note({text:alerts.IS_SPAM_INMAIL,cont:$("#alert_box")}),exMail.router.navigate("!"+t_action,{trigger:!0})}})}),$("#do_move, #do_delete").on("click",function(){var e=$(this).data("href");return!(/j_thread_delete\/(\d+)/i.test(e)&&!confirm(alerts.REMOVE_FOREVER+"?"))&&($.ajax({url:e,type:"get",dataType:"text",complete:function(){window.history.back(),/j_thread_delete\/(\d+)/i.test(e)?$.note({text:alerts.THREAD_REMOVES,cont:$("#alert_box")}):/j_thread_move\/(\d+)$/i.test(e)?$.note({text:alerts.THREAD_NOT_SPAM,cont:$("#alert_box")}):$.note({text:alerts.THREAD_MOVE_TRASH,cont:$("#alert_box")})}}),!1)}),s.msg.is_compose||$("#buttons").show()}),a.unbind("click"),a.on("click","#reply_all_button,#reply_button,#forward_button",function(e){var t=!1,i="";if(0==this.id.indexOf("forward")?(t=!0,i="forward"):i=0==this.id.indexOf("reply_button")?"reply":"reply_all",$compose=$(".compose"),LOCKED_DRAFT_CLICK)return!1;LOCKED_DRAFT_CLICK=!0,$compose.length&&deleteMsgClick(),exMail.TMP_CONTENT.length&&(exMail.TMP_CONTENT=exMail.currentParams.$redactor.val(),console.log("exMail.TMP_CONTENT",exMail.TMP_CONTENT)),$.ajax({url:"/j_thread_compose/"+t_msg_id,type:"get",data:{type:i},success:function(e){e.msg_id&&($("#buttons").hide(),e.forward=t,openMsg(e,void 0,2,!1,!0),$(".redactor-editor").find(".ib_top_ctrl_bl").removeAttr("class").removeAttr("id"),t_msg_id=e.msg_id,$(".app-main-js").addClass("app-thread-compose"),LOCKED_DRAFT_CLICK=!1)}})}),a.on("click",".open_redactor",function(){$(".compose").toggleClass("open-redactor")}),$._atexit=function(){$(".compose").each(function(){var e=$(this).data("msg_id");$.ajax({type:"POST",url:"/j_compose_save/"+e,data:getMsgFormData(e),dataType:"json",async:!0})}),$._atexit=null},$(window).unbind("beforeunload").on("beforeunload",function(){$._atexit&&$._atexit()}),$(document).on("click","#do_starred",function(e){var t=$(this),i=1;t.hasClass("ib_important_select_in")?(i=0,t.removeClass("ib_important_select_in")):t.addClass("ib_important_select_in");var a=t.attr("data-href").split("?")[0]+"?is_starred="+i;t.attr("data-href",a),$.getJSON(a,function(e){}),e.stopImmediatePropagation()}),$(".js-top-toolbar").on("click",".im_unread_btn",function(){var e=$(this).data("id");e&&$.ajax({url:"/j_thread_is_new/"+e,async:!1,data:{is_new:1},dataType:"text",success:function(){exMail.router.navigate("!"+exMail.currentParams.action,{trigger:!0})}})})}function isElement(e){try{return e instanceof HTMLElement}catch(t){return"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument}}function f_upload(e){var t={upload_url:location.protocol+"//fs1."+location.host+"/upload",container:"",browse_button:"",drop_element:"",cb_ready:function(e,t){console.log(e,t)},cb_progress:function(){},cb_added:function(){},cb_before:function(e,t){e.settings.multipart_params.time=Math.round(Date.parse(t.lastModifiedDate)/1e3)},cb_error:function(e){console.log(e.message)},destroy:!1,file_data_name:"file",runtimes:"html5,flash,silverlight,browserplus",multipart_params:{},max_file_size:"2000mb",res_type:"json"};if(e=$.extend(!0,t,e),DestroyUploadImg(),e.destroy)return $("#"+e.container).empty(),0;var i=new plupload.Uploader({runtimes:e.runtimes,browse_button:e.browse_button,container:e.container,drop_element:e.drop_element,multi_selection:!0,file_data_name:e.file_data_name,required_features:"send_browser_cookies",url:e.upload_url,flash_swf_url:"/v1/js/pluploader/Moxie.swf",silverlight_xap_url:"/v1/js/pluploader/Moxie.xap",filters:{max_file_size:e.max_file_size},multipart_params:e.multipart_params});window._cur_uploader=i,i.bind("Init",function(e,t){}),i.init(),i.bind("FilesAdded",function(t,a){e.cb_added(a),t.refresh(),i.start()}),i.bind("UploadProgress",function(t,i){e.cb_progress(i)}),i.bind("BeforeUpload",function(t,i){e.cb_before(t,i)}),i.bind("Error",function(t,i){console.log(i),i.code==plupload.HTTP_ERROR?u.setProgressText(i.file,"Ошибка."):i.code==plupload.FILE_SIZE_ERROR&&alert(window.alerts.TO_BIG_FILE),e.cb_error(i),t.refresh()}),i.bind("FileUploaded",function(t,i,a){if(200==a.status){var n=a.response;"json"==e.res_type&&(n=$.parseJSON(n)),e.cb_ready(i,n)}else e.cb_error()}),i.removeQueuedFile=function(e){for(var t="string"==typeof e?e:e.id,i=this.files.length-1;i>=0;i--)if(this.files[i].id===t){var a=this.files.splice(i,1),n=!1;return a[0].status==plupload.UPLOADING&&this.state==plupload.STARTED&&(n=!0,this.stop()),this.trigger("FilesRemoved",a),a[0].destroy(),this.trigger("QueueChanged"),this.refresh(),n&&this.start(),a[0]}}}function DestroyUploadImg(){window._cur_uploader&&(window._cur_uploader.destroy(),window._cur_uploader=null)}function countReset(){$.ajax({url:"/j_new_count_reset",type:"post",dataType:"json",success:function(e){exMail.currentParams.newCount=0}})}function getUserName(){var e="";return $.ajax({url:exMail.apiUrls.settings,type:"post",async:!1,dataType:"json",xhrFields:{withCredentials:!0},success:function(t){e=t.name}}),e}function setToolbar(e,t){t_action=e;var i=t.all_count/t.per|0;t.all_count%t.per>0&&i++;var a=t.offset+t.per;a>t.all_count&&(a=t.all_count);var n=a/t.per|0;a%t.per>0&&n++;var o=$("div.browse"),s=($("div.toolbar"),{from:t.offset+1,to:a,all:t.all_count,prev:n>1,next:n<=i-1}),r=o.find(".ib_count_info > span");r.eq(0).text(s.from+"-"+s.to),r.eq(1).text(s.all),s.next&&o.find(".ib_next").click(function(){var e=$("#ib_search").val().trim();(e=e?encodeURIComponent(e):void 0)?exMail.router.navigate("!"+t_action+"/s/"+e+"/page/"+n,{trigger:!0}):exMail.router.navigate("!"+t_action+"/page/"+n,{trigger:!0})}),s.prev&&o.find(".ib_prev").click(function(){var e=$("#ib_search").val().trim();e=e?encodeURIComponent(e):void 0,n-2>0?e?(alert(1),exMail.router.navigate("!"+t_action+"/s/"+e+"/page/"+(n-2),{trigger:!0})):exMail.router.navigate("!"+t_action+"/page/"+(n-2),{trigger:!0}):e?exMail.router.navigate("!"+t_action+"/s/"+e,{trigger:!0}):exMail.router.navigate("!"+t_action,{trigger:!0})}),s.next||s.prev?o.show():o.hide(),/^(f\d{3})$/i.test(t_action)?$(".toolbar").tmpl("t_toolbar_labels",{labels:exMail.currentParams.labels,in_label:!0,action:t_action.split("f")[1]}):$(".toolbar").tmpl("t_toolbar_"+t_action,{labels:exMail.currentParams.labels,in_label:!1,action:t_action}),$(".ib_select_btn").ddOZ(),$(".to_label").ddOZ({handlerClass:"to_label_handler"})}function onBlurBottomLang(){$("#lang_box").removeClass("exmail_item_active")}function boxInfo(e){$.ajax({url:"/j_box_info",dataType:"json",success:function(t){if(t.box_info){var i=t.msg_size||0,a=t.file_size||0,n=t.box_size_limit||0,o=i+a,s=Math.round(100*o/n)||0;o=$.formatSize(o),n=$.formatSize(n),$(".space-info-block").tmpl("t_memory_info",{size:o,proc:s,max:n});var r=t.new_count||0;try{e&&exMail.currentParams.newCount!=r&&exMail.loadMailList({name:"inbox"}),exMail.currentParams.newCount!=r&&(exMail.currentParams.newCount=r||0,e||null===$._box_info||$.note({text:alerts.HAS_NEW_MAIL,cont:$("#alert_box")}));var l={1:"inbox",2:"sent",3:"drafts",4:"spam",5:"trash",6:"starred"},d=[1,2,3,4,5,6];_.each(t.box_info,function(e,t){if(t=parseInt(t),_.contains(d,parseInt(t))){var i=0|parseInt(e[1]);i=i>99?"99+":i,5!=t&&6!=t&&3!=t||(i=0|parseInt(e[0])),$("#j_"+l[t]).find("em").text(i||"")}if(e[1]>0){var a=$("#j_f"+t).find("em");a.text()!=e[1]&&a.text(e[1])}}),$._box_info=t}catch(e){console.warn(e.message)}}},error:function(e,t,i){"error"==t&&"Unauthorized"==i&&window.location.reload()}})}function setUserAvatar(){var e=getLoginColor($.user_email),t=getAvatart($.user_email,e);$(".im_photo_prev, .ib_user_photo, .my_photo_s").css("background",e+" url("+t+") center center no-repeat")}function getAvatart(e,t){try{t=t||"";var i="",a="",n=e.split("@");if(n&&n.length>0&&(e=n[0]),e.length>0&&(i=e.charAt(0).toUpperCase(),e.length>1&&(i+=e.charAt(1).toLowerCase())),a=i+t,_cache_avatar[a])return _cache_avatar[a];var o=document.getElementById("user_avatar"),s=o.getContext("2d");return o.width=32,o.height=32,t&&(s.fillStyle=t,s.fillRect(0,0,o.width,o.height)),s.font="14px 'arial'",s.textAlign="center",s.textBaseline="middle",s.fillStyle="#fff",s.fillText(i,o.width/2,o.height/2),_cache_avatar[a]=o.toDataURL()}catch(e){console.warn(e.message)}}function getLoginColor(e){var t=e.split("@");t&&t.length>0&&(e=t[0]);var i=crc32(e=e.toLowerCase()),a=100+(i>>8&255)%110,n=100+(255&i)%110;return"#"+(100+(i>>16&255)%110).toString(16)+a.toString(16)+n.toString(16)}function isBlank(e){return!e||/^\s*$/.test(e)}function initUserMailTt(){function e(){clearInterval(o),$(".user-tt-box").remove()}$(".js-user-mail-tt");var t=$("body"),i=_.template($("#t-user-mail-tt").html()),a=$(),n=null,o=null;exMail.router.on("route",e),$(".r-side").on("mouseenter",".js-user-mail-tt",function(e){var s=$(this);o=setTimeout(function(){clearInterval(n),a.remove();var r=s.data("user"),l=s.data("mail");t.append(i({userName:r,userMail:l,action:exMail.currentParams.action})),a=$(".user-tt-box");var d=e.clientX+5,c=e.clientY+5;$(document).height()-c<a.outerHeight()&&(c-=a.outerHeight()),a.css({top:c+"px",left:d+"px"}),a.fadeIn(250),a.on("mouseenter",function(){clearInterval(n)}).on("mouseleave",function(e){a.remove()}).on("click",".user-tt-box__control-text--write",function(){$._j_compose={to:[r+" <"+l+">"],name:r+" <"+l+">",set:!0},exMail.router.navigate("!inbox?compose=new",{trigger:!0})}),o=null},800)}).on("mouseleave",".js-user-mail-tt",function(e){o?clearInterval(o):n=setTimeout(function(){a.remove()},800)})}function linker(e){var t=/(^|\s+|\>)(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2}))|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?/gi;return e.replace(t,"$1 <a href='http://$2' target='_blank'>$2</a>")}function getTemplate(){parseInt(getCookie("tid"));return"/v1/exmail5/template/"+getLanguage()+"/template.html"}!function(){window.exMail.model={}}(),function(){exMail.model.newCompose=Backbone.Model.extend({url:"/j_compose"}),exMail.model.threadLoad=Backbone.Model.extend({initialize:function(e){this.url="/j_thread_load/"+e.threadId,console.log(this.url)}}),exMail.model.sendMsg=Backbone.Model.extend({initialize:function(e){this.url="/j_compose_send/"+e.msg_id}}),exMail.model.contactsLoad=Backbone.Model.extend({url:"/j_contact_list"}),exMail.model.loadGroup=Backbone.Model.extend({url:"/j_contact_group_list"})}(),function(){function e(e){return e=e.replace(/\+|\s|\(|\)/g,"")}var t=Backbone.Model.extend({defaults:{login:null,existingAccountName:null},initialize:function(e){var t=this;$.get("/j_index").then(function(i){t.set({login:i.login,existingAccountName:i.auth_login}),e()})},isAuthorized:function(){return null!==this.get("login")}});exMail.model.Account=t.extend({signin:function(t){return t.login=e(t.login),$.post("/j_login",t).then(maybeCaptcha("j_login",t,!0)).then(function(e){return jQuery.Deferred(function(t){1===e.result?t.resolve(e):t.reject(e)})})},signup:function(t){return t.phone=e(t.phone),t.use_cookie=1,t.stay_signed=1,$.post("/j_signup",t).then(maybeCaptcha("j_signup",t,!0)).then(function(e){return jQuery.Deferred(function(t){if(1===e.result)return t.resolve();t.reject(e)})})},restore:function(t,i){var a=this;return t.phone=e(t.phone),$.post("/j_recovery",t).then(maybeCaptcha("j_recovery",t,!0)).then(function(e){return jQuery.Deferred(function(n){if(1===e.result){if(!i)return n.resolve();a.signin({login:t.login,password:t.password,use_cookie:1,stay_signed:0}).then(function(e){if(1===e.result)return n.resolve({needAgreement:!1});n.reject(e)},function(e){n.reject(e)})}else n.reject(e)})})},logout:function(){return $.post("/j_logout")},setPhoneForSignUp:function(){return jQuery.Deferred(function(e){e.resolve()})}}),exMail.model.FexAccount=t.extend({signin:function(t){var i={login:e(t.login),password:t.password,stay_signed:t.stay_signed};return $.ajax({url:"https://fex.net/j_signin",method:"POST",data:i,xhrFields:{withCredentials:!0}}).then(maybeCaptcha("j_signin",i,!0)).then(function(e){return jQuery.Deferred(function(t){1===e.result?$.get("/j_index").then(function(e){e.existingAccountName=e.auth_login,e.needAgreement=!e.login,t.resolve(e)}):t.reject(e)})})},signup:function(t){var i=this;return t.phone=e(t.phone),$.ajax({method:"POST",url:"https://fex.net/j_signup",xhrFields:{withCredentials:!0},data:t}).then(maybeCaptcha("j_signup",t,!0)).then(function(e){return jQuery.Deferred(function(t){1===e.result?i.signInWithExistingAccount().then(function(e){if(1===e.result)return t.resolve(e);t.reject(e)},function(e){t.reject(e)}):t.reject(e)})})},restore:function(t,i){var a=this;t.phone=e(t.phone);var n={url:"https://fex.net/j_password_reset",method:"POST",xhrFields:{withCredentials:!0},data:t};return $.ajax(n).then(maybeCaptcha("j_password_reset",t,!0)).then(function(e){return jQuery.Deferred(function(n){if(1===e.result){if(!i)return n.resolve();a.signin({login:t.login,password:t.password,stay_signed:0}).then(function(e){e.existingAccountName?(a.set("existingAccountName",e.existingAccountName),n.resolve({needAgreement:!0})):n.resolve({needAgreement:!1})},function(e){n.reject(e)})}else n.reject(e)})})},signInWithExistingAccount:function(){return $.post("/j_signup_auth").then(function(e){return jQuery.Deferred(function(t){if(1===e.result)return t.resolve(e);t.reject(e)})})},logout:function(){return $.ajax({method:"POST",url:"https://fex.net/j_signout",xhrFields:{withCredentials:!0}})},setPhoneForSignUp:function(t){var i={phone:e(t)};return $.ajax({method:"POST",url:"https://fex.net/j_signup",xhrFields:{withCredentials:!0},data:i}).then(maybeCaptcha("j_signup",i,!0)).then(function(e){return jQuery.Deferred(function(t){if(1===e.result)return t.resolve(e);t.reject(e)})})}})}(),exMail.ui={sett:{},settingsView:null},exMail.views={},exMail.user=[],exMail.utils={setTitle:function(e){$("title").text(e||exMail.initData.domain.name)},needCaptcha:function(e){return 1===e.captcha&&e.err&&(1008===e.err.id||1101===e.err.id)},validateIntlPhone:function(e){var t=e.val(),i=e.intlTelInput("getSelectedCountryData").iso2;return intlTelInputUtils.isValidNumber(t,i)}},glob_dropbox=!1,exMail.isAuth=!1,exMail.exObjects={};var LOCKED_DRAFT_CLICK=!1,CORP_USER_ADD=1,CORP_USER_LIST=2,CORP_USER_PASSWORD=4,CORP_USER_DELETE=8;exMail.corpPromises=!!(CORP&CORP_USER_ADD&&CORP&CORP_USER_LIST&&CORP&CORP_USER_PASSWORD&&CORP&CORP_USER_DELETE),exMail.currentParams={groupId:void 0,action:"inbox",sarchQuery:"",threadId:null,newCount:0,chackedList:[],labels:[],aliases:[],prevAction:"inbox",mailMaxCountChars:20,cids:[]},exMail.confInptTel={preferredCountries:["ua","ru","by","cz"],nationalMode:!1},exMail.confInptTelWithPlaceholder={preferredCountries:["ua","ru","by","cz"],nationalMode:!1,customPlaceholder:function(e,t){return void 0!==t.dialCode?"+"+t.dialCode:e}},exMail.inputTelErrorsMessages=function(e){var t="";switch(e){case 2:t=window.alerts.TO_SHORT;break;case 3:t=window.alerts.TO_LONG;break;case 4:t=window.alerts.ONLY_NUMBERS;break;default:t=window.alerts.DEF_INVALID}return t},exMail.inputTelErrors=function(e){var t=exMail.inputTelErrorsMessages(e);$.note({text:t,cont:$("#alert_box")})},exMail.isAuth=!!LOGIN,exMail.routesData={},$(function(){var e=Backbone.Router.extend({routes:{"!restore(/)":"restore","!signup(/)":"signup","!corp(/)":"corp","!terms(/)":"terms","!rules(/)":"rules","!about(/)":"about","!promo(/)":"promo","!inbox/notFound(/)":"notFoundAlert","!contacts(/)":"contacts","!contacts/:email(/)":"contactOpen","!contacts/g/:group_id/:email(/)":"contactOpenGroup","!contacts/g/:group_id(/)":"openGroup","!contacts/new(/)":"contactNew","!history_logins(/)":"history_logins","!logout(/)":"logout","!ru/corp(/)":"corporate","!ru/corp/register(/)":"corporateRegister","*notFound":"notFound"},initialize:function(){var e=_.bind(this.initRoutes,this);exMail.Account=new exMail.domainSettings.accountModel(e)},initRoutes:function(){exMail.isAuth&&(this.route(/^!(inbox|drafts|starred|sent|spam|trash|(?:f\d{3}))(?:\/page\/(\d+))?\/?$/,"mailActions"),this.route(/^!(inbox|drafts|starred|sent|spam|trash|(?:f\d{3}))(?:\/(\d+))?(?:\/page\/(\d+))?\?compose=(new|\d+)$/,"compose"),this.route(/^!files(\/(d|r))?$/,"files"),this.route(/^!(inbox|drafts|starred|sent|spam|trash|(?:f\d{3}))\/(\d+)\/?$/,"threadOpen"),this.route(/^!(inbox|drafts|starred|sent|spam|trash)\/(\d+)\/(.+)\/?$/,"threadOpenWithSearch"),this.route(/^!(inbox|drafts|starred|sent|spam|trash)\/s\/([^\/\?]+)(?:\/page\/(\d+))?(?:\?compose=(new|\d+))?\/?$/,"searchMails"),this.route(/^!corp\/users(?:\/p(\d+))?(?:\/s\/([^\/]+))?\/?$/i,"corpUsers"),this.route(/^!settings(?:\/(alias|labels|import|security|profile))?\/?$/,"settingsAction"),this.route(/^!print\/(thread|msg)\/(\d+)\/?$/,"printVersion"),get_labels_list(),$(".inbox_wr").show()),this.route(/^!logout(?:\/(?:\+?(\d+)))$/,"logoutWithLogin"),Backbone.history.start({pushState:!1})},before:function(){LOCKED_DRAFT_CLICK=!1,exMail.TMP_CONTENT="";try{exMail.currentView.undelegateEvents()}catch(e){console.log(e.message)}var e=$(".app-main-js");e.removeClass("js-settings-open"),e.removeClass("app-thread-compose"),e.removeClass("app-box-scrollable"),$("#ib_user_item").find(".open_user_item").removeClass("open_user_item"),$("#ib_user_item").find(".open_dd").removeClass("open_dd"),document.documentElement.className=exMail.domainSettings.htmlClassName,$("body").removeClass("is-request-visible"),$("#app").empty(),$(".app-main-js").show()},printVersion:function(e,t){exMail.firstLoad=!1;try{exMail.views.print.undelegateEvents()}catch(e){console.log(e.message)}exMail.views.print=new exMail.ui.Print,exMail.views.print.render({entityType:e,id:t})},expressSignup:function(e){$(".inbox_wr").hide(),exMail.currentView=new exMail.ui.expressSignup,exMail.currentView.render(e),exMail.firstLoad=!1},settingsAction:function(e){exMail.utils.setTitle(window.titles.settings),$(".tools_item > a").removeClass("active"),$(".tools_item > .settings_ln").addClass("active"),exMail.firstLoad=!1,e=null==e?"common":e.toLowerCase(),"function"==typeof exMail.ui.sett[e]?(exMail.currentView=new exMail.ui.sett[e],exMail.currentView.render({action:e})):this.navigate("!inbox/notFound",{trigger:!0})},compose:function(e,t,i,a){null===t?this.render(e,i||0):this.threadOpen(e,t),exMail.ui.compose=new Compose({action:e,newThreadId:a,threadIdCurrentPage:t}),exMail.ui.compose.render(),console.log(e,t,i,a)},searchMails:function(e,t,i,a){console.log(e,t,i,a),i||(i=0),exMail.currentParams.sarchQuery=t,exMail.currentParams.page=i,console.log("exMail.currentParams.sarchQuery",exMail.currentParams.sarchQuery),t=decodeURIComponent(t),$("#ib_search").val(t),exMail.loadMailList({name:t_action,is_search:!0,page:i,search_text:t,box_id:searchOn[e],byAll:searchByAllMails}),a&&(exMail.ui.compose=new Compose({action:e,newThreadId:a}),exMail.ui.compose.render())},threadOpen:function(e,t){$(".tools_item > a").removeClass("active"),$(".tools_item > .mailbox_ln").addClass("active"),$("#att_mod_2gb").removeClass("att_open_2gb"),exMail.currentParams.prevAction=exMail.currentParams.action,exMail.currentParams.action=e,exMail.currentParams.threadId=t,t_init_thread2(t,e)},threadOpenWithSearch:function(e,t,i){$(".tools_item > a").removeClass("active"),$(".tools_item > .mailbox_ln").addClass("active"),$("#att_mod_2gb").removeClass("att_open_2gb"),exMail.currentParams.prevAction=exMail.currentParams.action,exMail.currentParams.action=e,exMail.currentParams.threadId=t,exMail.currentParams.sarchQuery=i,t_init_thread2(t,e,i)},notFound:function(){exMail.isAuth&&exMail.Account.isAuthorized()?this.navigate("!inbox",{trigger:!0}):(exMail.currentView=exMail.ui.getLogin(),exMail.currentView.render(),exMail.firstLoad=!1)},promo:function(){exMail.isAuth&&exMail.Account.isAuthorized()||!exMail.isMailFexNet?this.navigate("#!",{trigger:!0}):(exMail.currentView=new exMail.ui.promo,exMail.currentView.render())},notFoundAlert:function(){exMail.isAuth?($.note({text:alerts.PAGE_NOT_FOUND,cont:$("#alert_box")}),this.navigate("!inbox",{trigger:!0})):(exMail.currentView=exMail.ui.getLogin(),exMail.currentView.render({}),exMail.firstLoad=!1)},mailActions:function(e,t){null===t&&(t=0),exMail.currentParams.action==exMail.currentParams.prevAction||t||(exMail.currentParams.chackedList=[]),exMail.currentParams.prevAction=exMail.currentParams.action,console.warn("page",t),$("#ib_search").val(""),exMail.currentParams.sarchQuery="","block"===$("#ib_search_btn").css("display")&&($("#ib_search_btn").hide(),$("#ib_search").val("")),this.render(e,t)},files:function(e,t){null!==exMail.ui.files&&(exMail.currentParams.prevAction=exMail.currentParams.action,exMail.currentParams.action=t,exMail.ui.files.render(t))},contacts:function(){exMail.currentParams.groupId=void 0,$("title").text(window.titles[Backbone.history.fragment.substring(1)]),$(".tools_item > a").removeClass("active"),$(".tools_item > .contacts_ln").addClass("active"),$("#mail_list").show(),$(".js-top-toolbar").empty().show(),(new exMail.model.contactsLoad).fetch({success:function(e,t,i){for(var a=exMail.ui.contacts,o=0;o<t.length;++o)n=0|t[o][2],t[o].length>3?t[o][3]=a.getGroupList(n).join(", "):t[o].push(a.getGroupList(n).join(", "));$._user_contacts=t,exMail.setMenu(1,t),$("#mail_list").empty().tmpl("t_contact_list",{list:t}).addClass("ib_contact ib_mail_compact"),$("div.browse").hide(),$(".js-top-toolbar").tmpl("t_toolbar_contact_list",{groups:$._user_group}),$(".ib_select_btn,.ib_groups_btn").ddOZ({autoClose:!1}),t_init_contact(void 0)}})},contactOpen:function(e){$(".tools_item > a").removeClass("active"),$(".tools_item > .contacts_ln").addClass("active"),$("#mail_list").show(),$(".exmail_menu_list").show(),$(".exmail_menu_list").removeClass("sett_list"),$(".js-top-toolbar > .toolbar").show(),(new exMail.model.contactsLoad).fetch({success:function(t,i,a){var n=[];_.each(i,function(t){t[0]==e&&(n=t)}),i.groupId=exMail.currentParams.groupId,exMail.setMenu(1,i),t_init_contact_info(void 0,n[0],n[1],n[2])}})},contactNew:function(){$(".tools_item > a").removeClass("active"),$(".tools_item > .contacts_ln").addClass("active"),$("#mail_list").show(),$(".exmail_menu_list").show(),$(".exmail_menu_list").removeClass("sett_list"),t_init_contact_info(void 0,"","","0")},contactOpenGroup:function(e,t){this.contactOpen(t)},openGroup:function(e){exMail.currentParams.groupId=e,$("title").text(window.titles[Backbone.history.fragment.substring(1)]),$(".tools_item > a").removeClass("active"),$(".tools_item > .contacts_ln").addClass("active"),$(".exmail_menu_list").show(),$(".exmail_menu_list").removeClass("sett_list"),$(".js-top-toolbar > .toolbar").show(),(new exMail.model.contactsLoad).fetch({success:function(t,i,a){for(var o=exMail.ui.contacts,s=0;s<i.length;++s)n=0|i[s][2],i[s].length>3?i[s][3]=o.getGroupList(n).join(", "):i[s].push(o.getGroupList(n).join(", "));$._user_contacts=i,exMail.setMenu(1,i),$("#mail_list").empty().show().tmpl("t_contact_list",{list:i}).addClass("ib_contact ib_mail_compact"),$("div.browse").hide(),$(".toolbar").tmpl("t_toolbar_contact_list",{groups:$._user_group}),$(".ib_select_btn,.ib_groups_btn").ddOZ({autoClose:!1}),t_init_contact(void 0),exMail.ui.contactsGroup.render(e)}})},corporate:function(){if(!exMail.domainSettings.hasCorpRegister)return this.navigate("#!",{trigger:!0});exMail.currentView=new exMail.ui.corporate,exMail.currentView.render()},corporateRegister:function(){if(!exMail.domainSettings.hasCorpRegister)return this.navigate("#!",{trigger:!0});exMail.currentView=new exMail.ui.corporateReqister,exMail.currentView.render()},history_logins:function(){exMail.currentView=new exMail.ui.historyLogins,exMail.currentView.render()},corp:function(){exMail.corpPromises?null!==exMail.ui.corp&&exMail.ui.corp.renderCommon():this.notFound()},corpUsers:function(e,t){exMail.corpPromises?null!==exMail.ui.corp&&($(".tools_item > a").removeClass("active"),$(".tools_item > .corpusers_ln").addClass("active"),exMail.ui.corp.renderUsers(e,t)):this.notFound()},restore:function(){if(!exMail.authSettings.isPublicAuth)return this.navigate("#!",{trigger:!0});exMail.isAuth?this.navigate("!inbox",{trigger:!0}):(exMail.currentView=exMail.ui.getRestore(),exMail.currentView.render())},signup:function(){if(!exMail.authSettings.isPublicAuth)return this.navigate("#!",{trigger:!0});exMail.isAuth?this.navigate("!inbox",{trigger:!0}):(exMail.currentView=exMail.ui.getSignup(),exMail.currentView.render())},logout:function(){exMail.Account.logout().then(function(){window.location="/"})},logoutWithLogin:function(e){if(e){exMail.isAuth?exMail.Account.logout().then(function(){window.location.reload()}):(exMail.currentView=new exMail.ui.getLogin,exMail.currentView.render({login:e}),exMail.firstLoad=!1)}},terms:function(){exMail.currentView=new exMail.ui.contentPage,exMail.currentView.render({templateId:"fexmail-terms",title:exMail.titles.terms(),heading:"Политика конфиденциальности"})},rules:function(){exMail.currentView=new exMail.ui.contentPage,exMail.currentView.render({templateId:"fexmail-rules",title:exMail.titles.rules(),heading:"Условия использования"})},about:function(){exMail.currentView=new exMail.ui.contentPage,exMail.currentView.render({templateId:"fexmail-about",title:exMail.titles.about(),heading:"О проекте",hasApplicationBlock:exMail.domainSettings.footerAppBtnsVisible,className:"fex-about-page"})},render:function(e,t){$("title").text(window.titles[Backbone.history.fragment.substring(1)]),exMail.currentParams.action=e,/^(f\d{3})$/i.test(e)?$("#ib_search").hide():$("#ib_search").show();var i=e,a=$("#j_"+i);$(".tools_item > a").removeClass("active"),$(".tools_item > .mailbox_ln").addClass("active"),$._atexit&&$._atexit(),$("#mail_list").removeClass("ib_contact"),window.titles[i]?$("#ib_search").attr("placeholder",alerts.TEXT_SEARCH_IN+" "+window.titles[i]):$("#ib_search").attr("placeholder",alerts.TEXT_SEARCH_IN),exMail.loadMailList({_self:a,name:i,page:t}),$("#mail_list").show(),"1"==getMode()?$("#mail_list").addClass("ib_mail_compact"):$("#mail_list").removeClass("ib_mail_compact"),$("#mail_list").removeClass("ib_contact"),$._j_compose.set=!1}});exMail.router=new e,exMail.router.on("route",function(e,t){exMail.isAuth&&(boxInfo(),setTimeout(function(){$(".ib_mail_list_wr").scrollTop(0)},0)),t.notify&&$.note({text:t.notify.message,cont:$("#alert_box")})})});var my_settings={};exMail.isAuth&&(my_settings=getConfig());var cur_msg={};null!==my_settings&&void 0!==my_settings||(my_settings={});var defSettings={signature:{stat:0,text:""},lang:getLanguageFromCookie(),lang_list:{ua:"Украiнська",ru:"Русский",en:"English",lt:"latviešu"},mode:1,mode_popup:!0,quote:1,per_page:40,popups:{experemental_popup:1,phoneadd_popup_last_show:0},radio:0,import_mails:{email:"",archive:[]},changes_popup:1,tid:getTidFromCookie()};$.uConfig=$.extend(!0,defSettings,my_settings),$.uConfig.tid!=getTidFromCookie()&&(createCookie("test_exmail",1),parseInt(getCookie("test_exmail"))&&(createCookie("tid",$.uConfig.tid),window.location.reload(),createCookie("test_exmail",0,-1))),console.log("$.uConfig",$.uConfig);var signatGlobText=$.uConfig.signature.text,signatGlobVal=$.uConfig.signature.stat,glob_per_page=$.uConfig.per_page;String.prototype.isEmpty=function(){return 0===this.length||!this.trim()},$.htmlTmpl=function(e,t){var i=doT.template($("#"+e).html()),a="";if($.isArray(t))for(var n=0;n<t.length;n++)a+=i(t[n]);else a=i(t);return a},$.fn.tmpl=function(e,t){var i=$.htmlTmpl(e,t);return this.each(function(){$(this).html(i)})},$.fn.replaceTmpl=function(e,t){var i=$.htmlTmpl(e,t);return this.each(function(){$(this).replaceWith(i)})},$.fn.beforeTmpl=function(e,t){var i=$.htmlTmpl(e,t);return this.each(function(){$(this).before(i)})},$.fn.afterTmpl=function(e,t){var i=$.htmlTmpl(e,t);return this.each(function(){$(this).after(i)})},$.fn.appendTmpl=function(e,t){var i=$.htmlTmpl(e,t);return this.each(function(){$(this).append(i)})},$.htmlBody=function(e,t){var i=$("<div>").append(e.html);i.find("script,style,noscript,base,link,audio,video,iframe,frame,embed,noembed,object,applet,param").remove(),i.find("*").each(function(){var e=this;try{for(var t=0;t<e.attributes.length;){var i=e.attributes[t];!i||0!==i.name.toLowerCase().indexOf("on")&&"id"!==i.name.toLowerCase()?(i&&i.name.toLowerCase(),t++):e.removeAttribute(i.name)}}catch(e){console.log(e.message)}}),e.html=i.html(),$frame=$("<iframe>"),$frame.hide(),$frame.attr({sandbox:"allow-scripts allow-same-origin",class:"f_msg"}),$frame.on("load",{val:e},function(e){var i=iframeIsLoad($(this),e.data.val);t(i)}),$("iframe.f_msg").remove(),document.body.appendChild($frame.get(0))},$.formatSize=function(e){function t(e,t){return Math.round(e*Math.pow(10,t))/Math.pow(10,t)}if(e<1024)return e+" B";var i=["K","M","G","T","P"];for(var a in i){if((e/=1024)<100)return t(e,1)+" "+i[a]+"B";if(e<1024)return t(e,0)+" "+i[a]+"B"}return t(e,0)+" PB"},exMail.getCaptchaToken=function(e,t){for(var i="",a=0,n="a"==(t=t&&t.toLowerCase())?10:0,o="n"==t?10:62;a++<e;){var s=Math.random()*(o-n)+n<<0;i+=String.fromCharCode(s+=s>9?s<36?55:61:48)}return i},function(){var e=exMail.initData.domain.host,t=exMail.initData.domain.flags,i={PUBLIC_AUTH:1,EXTERNAL_AUTH:4},a={FEX:"mail.fex.net",EX:"mail.ex.ua",FMAIL:"fmail.net"},n=e===a.FEX,o=e===a.EX,s={isPublicAuth:(t&i.PUBLIC_AUTH)===i.PUBLIC_AUTH,isExternalAuth:(t&i.EXTERNAL_AUTH)===i.EXTERNAL_AUTH};n&&(s.isPublicAuth=!0),exMail.authSettings=s;var r={getSettingsUrl:function(){return"https://fex.net/j_settings"},getSaveSettingsUrl:function(){return"https://fex.net/j_settings_save"},getAccountModel:function(){return exMail.model.FexAccount},getSavePassword:function(){return"https://fex.net/j_password_change"},getCaptchaDomain:function(){return s.isExternalAuth&&n?"https://fex.net/":""}};if(exMail.apiUrls={settings:"/j_settings",saveSettings:"/j_settings_save",savePassword:"/j_password_save",captchaDomain:"/"},exMail.domainSettings={widgetsVisible:n||o,accountModel:s.isExternalAuth?r.getAccountModel():exMail.model.Account,hiddenMobileSection:!n,headerLeftNavVisible:n,footerAppBtnsVisible:n,supportEmail:function(){return n?"mail@fex.net":""}(),supportEmailCorp:function(){return n?"corp@fex.net":""}(),hasCorpRegister:function(){return e===a.FEX||e===a.FMAIL}(),isPhoneDisabled:function(){return n}(),backgroundPrefix:function(){return"-"+exMail.initData.domain.name.split(".")[0]}(),htmlClassName:exMail.initData.domain.name.replace(".","-")+"-domain",radioOrigin:"https://cast.fex.net/"},s.isExternalAuth&&(exMail.apiUrls=_.extend(exMail.apiUrls,{settings:r.getSettingsUrl(),saveSettings:r.getSaveSettingsUrl(),savePassword:r.getSavePassword(),captchaDomain:r.getCaptchaDomain()})),exMail.titles={terms:function(){return n?window.fexTitles.terms:"Политика конфиденциальности"},rules:function(){return n?window.fexTitles.rules:"Условия использования"},about:function(){return n?window.fexTitles.about:"О проекте"},index:function(){return n?window.fexTitles.index:""},restore:function(){return n?window.fexTitles.restore:"Восстановление пароля"},register:function(){return n?window.fexTitles.signup:"Регистрация"}},exMail.isMailFexNet=n,exMail.isMailExUa=o,exMail.getLogoClassName=function(){return"fex-logo--"+exMail.initData.domain.name.split(".")[0]},exMail.getCopyText=function(){return n||o?"":"INFOSYSTEMS, INC. 251 Little Falls Drive Street, Wilmington, DE, 19808-1674"},exMail.uploadUrl="https://fs1."+exMail.initData.domain.fs+"/upload","5"===$.uConfig.tid){var l=document.createElement("div");l.style.backgroundColor="red",l.style.position="fixed",l.style.top=0,l.style.right=0,l.style.left=0,l.style.fontSize="10px",l.textContent="Beta version",l.style.zIndex=1e3,document.body.appendChild(l)}}(),function(){var e={email:/^[^\s]+\@\w[\w\-]*(\.\w[\w\-]*)+$/,domain:/^((?:(?:(?:\w[\.\-\+]?)*)\w)+)((?:(?:(?:\w[\.\-\+]?){0,62})\w)+)\.(\w{2,6})$/};exMail.model.FormModel=Backbone.Model.extend({_validators:{required:function(e){return{msg:window.alerts.REQUIRED,valid:""!==e}},email:function(t){return{msg:window.alerts.ERR_INVALID_EMAIL,valid:e.email.test(t)}},emailFilled:function(e){return""===e?{msg:"",valid:!0}:this._validators.email(e)},domain:function(t){return{msg:window.alerts.DOMAIN_INVALID,valid:e.domain.test(t)}},domainWithProtocol:function(e){return e=removeTrailingSlash(e),e=removeProtocol(e),this._validators.domain(e)},phone:function(e){},password:function(e){return{msg:window.alerts.PASSWORD_TO_SHORT,valid:e.length>=8}},matchPassword:function(e){return{msg:window.alerts.ERR_PASS_COMPARE,valid:e===this.get("password")}},login:function(e){return{msg:window.alerts.LOGIN_TO_SHORT,valid:e.length>=6}},intlTelNumber:function(e){var t=this.get("iso"),i=intlTelInputUtils.getValidationError(e,t);return{msg:exMail.inputTelErrorsMessages(i),valid:intlTelInputUtils.isValidNumber(e,t)}}},isValidPhone:function(e){return this._validators.intlTelNumber.call(this,this.get(e||"phone")).valid},validators:{},validations:{},validate:function(e,t){t=t||{};var i=[],a=_.extend({},this._validators,this.validators),n=t.onlyThisKey?_.pick(this.validations,t.onlyThisKey):this.validations;if(_.each(n,function(e,n){var o=t.onlyThisKey?t.value:this.get(n),s=0,r=e.length;if(void 0!==o)for(;s<r;s++){var l=a[e[s]].call(this,o);if(!l.valid){i.push({field:n,msg:l.msg});break}}},this),0!==i.length)return i}}),exMail.ui.FormView=Backbone.View.extend({events:{"change [data-auto-bind]":"onChange","keyup [data-live-check]":"onKeyUp"},initialize:function(){},getFieldWrap:function(e){return this.$('[name="'+e+'"]').closest(".fex-form__group")},displayValidationErrors:function(){_.each(this.model.validationError,function(e){var t=this.$('[name="'+e.field+'"]');if(!1!==t.data("show-error")){var i=t.closest(".fex-form__group");i.addClass("has-error");var a=i.find(".fex-form__error");e.html?a.html(e.msg):a.text(e.msg)}},this)},hideValidationError:function(e){this.getFieldWrap(e).removeClass("has-error")},onChange:function(e){var t=this.getFieldValue(e.target),i=e.target.name;(t||this.model.has(i))&&(this.model.isValid({onlyThisKey:i,value:t}),this.model.set(i,t),this.model.validationError?(this.displayValidationErrors(),e.target.setAttribute("data-live-check","true")):this.hideValidationError(i))},onKeyUp:function(){event.target.hasAttribute("data-live-check")&&this.onChange(event)},getFieldValue:function(e){return"checkbox"===e.type?e.checked:e.value},setIso:function(){var e=this.$el.find('[name="intlPhone"]').intlTelInput("getSelectedCountryData").iso2;this.model.set("iso",e,{silent:!0})}})}(),function(){"use strict";var e=exMail.model.FormModel.extend({defaults:{login:"",password:"",existingAccountName:"",remember:!0,needAgreement:!1},validators:{},validations:{login:["required"],password:["required","password"]}}),t=exMail.ui.FormView.extend({tagName:"div",initialize:function(){this.tpl=doT.template($("#fexmail-login-form").html()),this.model=new e({existingAccountName:exMail.Account.get("existingAccountName")}),this.events=_.extend({},this.events,{"submit form":"submit","click .js-change-account":"changeAccount","click .js-signin-with-existing-account":"signInWithExistingAccount"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors),this.listenTo(this.model,"change:existingAccountName",this.render)},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this;exMail.Account.signin({back:"",login:this.model.get("login"),password:this.model.get("password"),use_cookie:1,stay_signed:this.model.get("remember")?1:0}).then(function(e){e.needAgreement?t.model.set({needAgreement:!0,existingAccountName:e.existingAccountName}):window.location.reload()},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}},changeAccount:function(){this.model.set("existingAccountName","")},signInWithExistingAccount:function(){exMail.Account.signInWithExistingAccount().then(function(){window.location.reload()},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}}),i=Backbone.View.extend({el:document.getElementById("app"),$phone:null,$password:null,$phoneStage:null,$passwordStage:null,events:{"click .js-to-desktop-version":"toDesktopVersion","click .js-header-register":"onRegistrationClick"},initialize:function(){},render:function(){var e=this.getUaInfo(),i=$(document.documentElement);if((isMobileForbidden()||exMail.domainSettings.hiddenMobileSection)&&(e.showMobileSection=!1),exMail.titles.index()&&exMail.utils.setTitle(exMail.titles.index()),exMail.isMailExUa||i.addClass("fex-sticky-footer"),i.addClass("fex-login-page"),$(".app-main-js").hide(),this.$el.addClass("fex-home"),this.$el.appendTmpl("fexmail-header",{showLeftNav:exMail.domainSettings.headerLeftNavVisible}),this.$el.appendTmpl("fexmail-login",_.extend({},e,{showCorporateClients:"mail.fex.net"===exMail.initData.domain.host||"fmail.net"===exMail.initData.domain.host,url:"fmail.net"===exMail.initData.domain.host?"/#!ru/corp/register":"/#!ru/corp"})),this.$el.appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmail,hasApplicationBlock:exMail.domainSettings.footerAppBtnsVisible,hasDesktopLink:!0,hideAppButtonsOnMobile:!0}),!e.showMobileSection){var a=new t;this.$(".js-login-form").append(a.render().el)}},getUaInfo:function(){var e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?{showMobileSection:!1}:/android/i.test(e)?{mobileOs:"android",showMobileSection:/mobile/i.test(e)}:/iPad|iPhone|iPod/.test(e)&&!window.MSStream?{mobileOs:"ios",showMobileSection:/iPhone/.test(e)}:{showMobileSection:!1}},toDesktopVersion:function(){createCookie("isMobileForbidden",1,3),window.location.reload()},onRegistrationClick:function(){sendFexGa({eventCategory:"registration",eventAction:"step_1"})}});exMail.ui.getLogin=function(){return new i},exMail.ui.MainLoginForm=t}();var $documentElement=$(document.documentElement),SignUpFormModel=exMail.model.FormModel.extend({defaults:{phone:""},validations:{phone:["required","intlTelNumber"]}}),SignUpFormView=exMail.ui.FormView.extend({tagName:"div",className:"promo-sign-up",initialize:function(){this.tpl=doT.template($("#fexmail-promo-signup").html()),this.events=_.extend({},this.events,{"submit form":"submit"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){this.$el.html(this.tpl(this.model.toJSON()));var e=this.$('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this;exMail.Account.setPhoneForSignUp(this.model.get("phone")).then(function(){exMail.routesData.fromPromoPage=!0,exMail.routesData.phone=t.model.get("phone"),exMail.router.navigate("!signup",{trigger:!0})},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}}}),Promo=Backbone.View.extend({el:document.getElementById("app"),events:{"click .js-show-signIn-form":"showSignInForm"},initialize:function(){this.signUpFormModel=new SignUpFormModel,this.signUpFormView=new SignUpFormView({model:this.signUpFormModel}),this.signInFormView=new exMail.ui.MainLoginForm,this._addAnalyticsEvents()},render:function(){$documentElement.addClass("fex-login-page"),$(".app-main-js").hide(),this.$el.addClass("fex-home"),this.$el.appendTmpl("fexmail-header",{showLeftNav:exMail.domainSettings.headerLeftNavVisible,hasAuthButton:!0}),this.$el.appendTmpl("fexmail-promo",{url:"#!ru/corp"}),this.$formContainer=this.$(".js-form-container"),this.$formContainer.append(this.signUpFormView.render().el),this.$el.appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmail,hasApplicationBlock:exMail.domainSettings.footerAppBtnsVisible,hasDesktopLink:!0,hideAppButtonsOnMobile:!0})},showSignInForm:function(){this.$formContainer.empty(),this.$formContainer.append(this.signInFormView.render().el)},_addAnalyticsEvents:function(){this.$el.on("click",'.fex-header__navLink[href="https://fex.net"]',function(){sendFexGa({eventCategory:"landing",eventAction:"fex_file"})}).on("click",".js-header-auth",function(){sendFexGa({eventCategory:"landing",eventAction:"login_header"})}).on("click",".js-submit-register",function(){sendFexGa({eventCategory:"registration",eventAction:"step_1"})}).on("click",".js-show-signIn-form",function(){sendFexGa({eventCategory:"landing",eventAction:"login_text"})}).on("click",".fex-promo__btn",function(){sendFexGa({eventCategory:"landing",eventAction:"business_reg"})}).on("click",".js-android-app",function(){sendFexGa({eventCategory:"landing",eventAction:"android_app"})}).on("click",".js-ios-app",function(){sendFexGa({eventCategory:"landing",eventAction:"ios_app"})})}});exMail.ui.promo=Promo,function(){"use strict";var e=exMail.model.FormModel.extend({defaults:{phone:""},validations:{phone:["required","intlTelNumber"]}}),t=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-register__form",attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-register-phone").html()),this.events=_.extend({},this.events,{submit:"submit"}),this.delegateEvents(),this.listenTo(this.model,"change:phone",this.setIso),this.listenTo(this.model,"change:phone",this.checkPhoneIsValid),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){this.$el.html(this.tpl());var e=this.$('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this;exMail.Account.setPhoneForSignUp(this.model.get("phone")).then(function(){t.trigger("showNextStep",t.model.get("phone"))},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}},checkPhoneIsValid:function(){this.$(".fex-register__submit")[0].disabled=!this.model.isValidPhone()}}),i=exMail.model.FormModel.extend({defaults:{phone:"",iso:"",timeout:60,expanded:!1,disabled:!0},validations:{phone:["intlTelNumber"]},phoneChanged:function(){return this.get("phone")!==this.get("previousPhone")}}),a=exMail.ui.FormView.extend({tagName:"div",initialize:function(){this.tpl=doT.template($("#fexmail-register-form-code").html()),this.events=_.extend({},this.events,{"click .js-resend-code":"resendCode","click .js-expand-link":"expand"}),this.delegateEvents(),this.listenTo(this.model,"change:phone",this.setIso),this.listenTo(this.model,"change:phone",this.maybeStopInterval),this.listenTo(this.model,"change:phone",this.checkPhoneIsValid),this.listenTo(this.model,"change:expanded",this.render),this.listenTo(this.model,"change:timeout",this.onTimeoutChanged),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){this.$el.html(this.tpl(this.model.toJSON()));var e=this.$('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},resendCode:function(e){if(e.preventDefault(),sendFexGa({eventCategory:"registration",eventAction:"step_2_SMS"}),this.model.isValid()){var t=this,i=this.model.get("phone");exMail.Account.setPhoneForSignUp(i).then(function(){t.startTimeout(i)},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}},expand:function(){this.model.set("expanded",!this.model.get("expanded"))},onTimeoutChanged:function(){var e=this.model.get("timeout");e?this.$(".js-code-timeout").text(e):this.stopTimeout()},startTimeout:function(e){var t=this;this.model.set({timeout:this.model.defaults.timeout,phone:e,disabled:!0,previousPhone:e}),this.intervalId=setInterval(function(){t.model.set("timeout",t.model.get("timeout")-1)},1e3),this.render()},stopTimeout:function(){this.model.set({timeout:0,disabled:!1},{silent:!0}),clearInterval(this.intervalId),this.render()},maybeStopInterval:function(){this.model.isValidPhone()&&this.model.phoneChanged()&&(this.stopTimeout(),this.$('[name="phone"]').focus())},checkPhoneIsValid:function(){var e=this.$(".js-resend-code")[0];e&&(e.disabled=!this.model.isValidPhone())}}),n=exMail.model.FormModel.extend({defaults:{login:"",password:"",password2:"",name:"",captcha_token:"",captcha_value:"",imageUrl:"",phone:""},validations:{login:["required","login"],phone:["required","intlTelNumber"],password:["required","password"],password2:["required","password","matchPassword"],captcha_value:["required"]},reloadCaptcha:function(e){var t=exMail.getCaptchaToken(32);this.set({captcha_token:t,captcha_value:"",imageUrl:"/captcha?captcha_token="+t},{silent:e})},getSignupData:function(){return{login:this.get("login"),password:this.get("password"),password2:this.get("password2"),captcha_token:this.get("captcha_token"),captcha_value:this.get("captcha_value"),name:this.get("name"),phone:this.get("phone")}}}),o=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-register__form",attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-register-form").html()),this.events=_.extend({},this.events,{submit:"submit","click .js-toggle-password":"togglePassword","click .js-captcha-reload":"reloadCaptcha"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors),this.listenTo(this.model,"change:captcha_token",this.render),this.listenTo(this.model,"change:phone",this.setIso),this.listenTo(this.model,"change:phone",this.checkPhoneIsValid)},render:function(){this.$el.html(this.tpl(this.model.toJSON()));var e=this.$('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},show:function(){return this.model.reloadCaptcha(!0),this.render().el},submit:function(e){var t=this;e.preventDefault(),this.model.isValid()&&exMail.Account.signup(this.model.getSignupData()).then(function(){window.location.reload()},function(e){1115===e.err.id&&t.reloadCaptcha(),$.note({text:e.err.msg,cont:$("#alert_box")})})},reloadCaptcha:function(){this.model.reloadCaptcha(!1)},togglePassword:function(e){var t=$(e.target).closest(".fex-form__group").find(".fex-form__control")[0];t.type="password"===t.type?"text":"password"},checkPhoneIsValid:function(){this.$(".fex-register__submit")[0].disabled=!this.model.isValidPhone()}}),s=exMail.model.FormModel.extend({defaults:{login:"",password:"",email:"",code:""},validations:{login:["required","login"],password:["required","password"],email:["emailFilled"],code:["required"]}}),r=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-register__form",attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-register-form-fex").html()),this.events=_.extend({},this.events,{submit:"submit","click .js-toggle-password":"togglePassword"}),this.delegateEvents(),this.resendCodeModel=new i,this.resendCodeView=new a({model:this.resendCodeModel}),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this.$(".js-resend-code").html(this.resendCodeView.render().el),this},show:function(){return this.render(),this.resendCodeView.startTimeout(this.model.get("phone")),this.el},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this.model.toJSON();t.phone=this.resendCodeModel.get("phone"),exMail.Account.signup(t).then(function(){exMail.isMailFexNet?(sendFexGa({eventCategory:"registration",eventAction:"step_2_ok",hitCallback:function(){window.location.reload()}}),setTimeout(function(){window.location.reload()},1e3)):window.location.reload()},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}},togglePassword:function(e){var t=$(e.target).closest(".fex-form__group").find(".fex-form__control")[0];t.type="password"===t.type?"text":"password"}}),l=Backbone.View.extend({el:document.getElementById("app"),initialize:function(){this.phoneModel=new e,this.phoneView=new t({model:this.phoneModel}),exMail.isMailFexNet?(this.formModel=new s,this.formView=new r({model:this.formModel})):(this.formModel=new n,this.formView=new o({model:this.formModel})),this.fromPromoPage=exMail.routesData.fromPromoPage,exMail.routesData.fromPromoPage=!1,this.fromPromoPage&&(this.formModel.set("phone",exMail.routesData.phone),exMail.routesData.phone=null),this.listenTo(this.phoneView,"showNextStep",this.showNextStep)},render:function(){var e=exMail.titles.register();exMail.utils.setTitle(e),$(".app-main-js").hide(),$(document.documentElement).addClass("fex-sticky-footer fex-signup-page"),this.$el.appendTmpl("fexmail-header",{showLeftNav:exMail.domainSettings.headerLeftNavVisible}).appendTmpl("fexmail-register").appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmail}).addClass("fex-home");var t=null;t=exMail.isMailFexNet?this.fromPromoPage?this.formView.show():this.phoneView.render().el:this.formView.show(),this.$(".js-register-form").html(t)},showNextStep:function(e){this.formModel.set("phone",e),this.$(".js-register-form").html(this.formView.show())}});exMail.ui.getSignup=function(){return new l}}(),function(){"use strict";var e=exMail.model.FormModel.extend({defaults:{phone:"",login:""},validations:{phone:["required","intlTelNumber"],login:["required","login"]}}),t=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-register__form fex-register__form--restore",attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-restore-form-first-step").html()),this.events=_.extend({},this.events,{submit:"submit"}),this.listenTo(this.model,"change:phone",this.setIso),this.listenTo(this.model,"change:phone",this.checkPhoneIsValid),this.listenTo(this.model,"invalid",this.displayValidationErrors),this.delegateEvents()},render:function(){this.$el.html(this.tpl(this.model.toJSON()));var e=this.$('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this;exMail.Account.restore(this.model.toJSON(),!1).then(function(){t.model.trigger("submited")},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}},checkPhoneIsValid:function(){this.$(".fex-register__submit")[0].disabled=!this.model.isValidPhone()}}),i=exMail.model.FormModel.extend({defaults:{phone:"",login:"",code:"",password:"",password2:"",ticks:60},validations:{code:["required"],password:["required","password"],password2:["required","password","matchPassword"]},toRestoreJSON:function(){return{login:this.get("login"),phone:this.get("phone"),code:this.get("code"),password:this.get("password")}}}),a=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-register__form fex-register__form--restore",attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-restore-form-second-step").html()),this.events=_.extend({},this.events,{submit:"submit","click .js-toggle-password":"togglePassword","click .js-resend-code":"resendCode"}),this.listenTo(this.model,"invalid",this.displayValidationErrors),this.listenTo(this.model,"change:ticks",this.renderTicks),this.delegateEvents()},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this.$('[name="phone"]').intlTelInput(exMail.confInptTelWithPlaceholder),this.$ticks=this.$(".js-resend-timeout-ticks"),this},submit:function(e){e.preventDefault(),this.model.isValid()&&exMail.Account.restore(this.model.toRestoreJSON(),!0).then(function(e){e.needAgreement?exMail.router.navigate("#!",{trigger:!0}):window.location.reload()},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})},togglePassword:function(e){var t=$(e.target).closest(".fex-form__group").find(".fex-form__control")[0];t.type="password"===t.type?"text":"password"},startTimeout:function(){var e=this;this.model.set("ticks",60,{silent:!0}),this.intervalId=setInterval(function(){e.model.set("ticks",e.model.get("ticks")-1)},1e3),this.render()},renderTicks:function(){if(this.model.get("ticks"))return this.$ticks.text(this.model.get("ticks"));clearInterval(this.intervalId),this.render()},resendCode:function(){if(!(this.model.get("ticks")>0)){var e=this,t={login:this.model.get("login"),phone:this.model.get("phone")};exMail.Account.restore(t,!1).then(function(){e.startTimeout()},function(e){$.note({text:e.err.msg,cont:$("#alert_box")})})}}}),n=Backbone.View.extend({el:document.getElementById("app"),events:{},initialize:function(){this.firstStepModel=new e,this.secondStepModel=new i,this.firstStepView=new t({model:this.firstStepModel}),this.secondStepView=new a({model:this.secondStepModel}),this.listenTo(this.firstStepModel,"submited",this.showSecondStep)},render:function(){var e=exMail.titles.restore();exMail.utils.setTitle(e),this.$el.addClass("fex-home"),$(".app-main-js").hide(),$(document.documentElement).addClass("fex-sticky-footer fex-restore-page"),this.$el.appendTmpl("fexmail-header",{showLeftNav:exMail.domainSettings.headerLeftNavVisible}).appendTmpl("fexmail-restore",{}).appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmail}),this.$(".js-restore-form").html(this.firstStepView.render().el)},showSecondStep:function(){this.secondStepModel.set({phone:this.firstStepModel.get("phone"),login:this.firstStepModel.get("login")}),this.$(".js-restore-form").html(this.secondStepView.render().el),this.secondStepView.startTimeout()}});exMail.ui.getRestore=function(){return new n}}(),function(){"use strict";var e=Backbone.View.extend({el:$("body"),timeOut:null,events:{"click .corp_rm":"removeUser","click .add_corp_user":"addUser","click .corp_close_popup":"closePopup","click .corp_save_user":"saveUser","click .corp_reset":"resetPass",'keyup input[name="corp_search"]':"corpSearch"},corpSearch:function(e){clearTimeout(this.timeOut);var t=$(e.target),i=this;this.timeOut=setTimeout(function(){var e="";t.val().trim().length&&(e=t.val()),i.getUsers(1,e)},300)},resetPass:function(e){var t=$(e.target),i=t.parent().parent().data("login");$.ajax({url:"/j_user_password_reset",dataType:"json",data:{login:i},success:function(e){e.result?t.parent().before(" <span>[Новый пароль: <b>"+e.password+"<b/>]</span>"):alert("Ошибка сброса пароля")}})},saveUser:function(){var e=this,t=this.$el.find('input[name="corp_login"]').val(),i=this.$el.find('input[name="corp_f_name"]').val(),a=this.$el.find('input[name="corp_phone"]').val();if(t.isEmpty())return alert("Заполните поле логина"),!1;$.ajax({url:"/j_user_add",dataType:"json",data:{login:t,name:i,phone:a},success:function(t){t.result?(e.$el.find(".corp_add_bl").hide(),e.$el.find(".corp_success_bl").show().find(".corp_pass").text(t.password)):alert("Данный логин уже занят либо является невалидным")}})},addUser:function(){$("#popup_mode").show();var e=$("body").find(".corp_poup");e.length?e.show():($("body").appendTmpl("t_corp_poup"),e=$("body").find(".corp_poup"))},closePopup:function(){$("body").find(".corp_poup").remove(),$("#popup_mode").hide(),Backbone.history.loadUrl(Backbone.history.fragment)},removeUser:function(e){var t=this,i=$(e.target),a=i.parent().parent().data("login");if(!confirm("Подтвердите удаление "+a))return!1;$.ajax({url:"/j_user_delete",type:"get",dataType:"json",data:{login:a},success:function(e){i.parent().parent().remove(),console.log(e),t.$el.find(".corp_all_count").text(parseInt(t.$el.find(".corp_all_count").text())-1)}})},getUsers:function(e,t){var i=this,a=e|=0;a<=1?a=0:a-=1;var n={p:a,per:60};t&&(n.s=t),$.ajax({url:"/j_user_list",type:"get",dataType:"json",data:n,success:function(t){i._renderUsers(t);var a=e-1<=1?"":"/p"+(e-1),n=e?"/p"+(e+1):"/p"+(e+2);e<=1&&t.all_count<=t.count?i.$el.find(".ib_prevnext_bl").hide():i.$el.find(".ib_prevnext_bl").show(),i.$el.find(".corp_offset").text((e?60*e-60:1)+" - "+(e?60*(e-1)+(0|t.count):60)),i.$el.find(".corp_all_count").text(0|t.all_count),i.$el.find(".ib_mail_prev").attr("href","#!corp/users"+a),t.user_list.length<60?i.$el.find(".ib_mail_next").attr("href","#!corp/users/p"+e):i.$el.find(".ib_mail_next").attr("href","#!corp/users"+n),exMail.firstLoad&&(exMail.firstLoad=!1,$loading.style.display="none")}})},_renderUsers:function(e){$("#mail_list").empty().show().appendTmpl("t_corp_user_item",{users:e.user_list})},renderCommon:function(){this.render(),$("#mail_list").show().empty().text("render common")},renderUsers:function(e,t){this.render(),this.getUsers(e,t)},render:function(){exMail.utils.setTitle("Управаление корпоративной почтой"),exMail.setMenu(4,{})}});exMail.ui.corp=new e}(),exMail.ui.historyLogins=Backbone.View.extend({el:".r-side",render:function(){exMail.utils.setTitle(window.titles[Backbone.history.fragment.substring(1)]),exMail.setMenu(6,{}),$("#ib_search_contact, #ib_search").hide().val(""),$(".tools_item > a").removeClass("active"),$(".browse, #settings-wrap, .js-top-toolbar > .toolbar, #files_wrap").hide(),$(".js-top-toolbar").empty().show();var e=$("<ul/>",{class:"ib_mail_list ib_history_list"}),t=this.$el.find("#mail_list");t.empty(),t.find(".thread").remove(),t.append(e),$.getJSON("/j_login_history",function(t){for(var i=[],a=0;a<t.length;a++){t[a][4]=timeConverter(0|t[a][4]),t[a][1]=long2ip(0|t[a][1]);var n=$("<li/>",{html:"<span>"+t[a][4]+"</span><span>"+t[a][1]+"</span><span>"+t[a][2]+"</span><span title='"+t[a][3]+"'>"+t[a][3]+"</span>",class:"main-list-item"});i.push(n)}e.append(i),exMail.firstLoad&&(exMail.firstLoad=!1)})}}),function(){function e(e){$.ajax({url:"/j_user_upload_list"+(void 0==e?"/1":""),data:{p:h,per:f},success:function(t){var i=$("#files_list");if(t.all_count>40){m=t.all_count,_=t.offset;var a=$(".browse");a.show().tmpl("t_f_browse",t),a.find(".ib_count_info > span:first-child").text((t.offset?t.offset:1)+"-"+(_+f>m?m:_+f))}if(t.typeMy=void 0==e?1:0,i.empty().tmpl("t_files_list",t),g=!0,$("#files_list>li .play").length){try{p.stop(),p.destruct()}catch(e){}s()}$("#files_list>li .im_play").length&&n(),$("#files_list>li .v_play").length&&o(),exMail.firstLoad&&(exMail.firstLoad=!1)}})}function t(e,t){void 0==e&&(e=0);var i=$(".att_files_wr").children("ul");$.ajax({url:"/j_user_upload_list"+(void 0==t?"/1":""),data:{p:e,per:40},async:!1,success:function(e){i.appendTmpl("t_files_list_in_mail",e),c=Math.ceil(e.all_count/40);try{p.stop(),p.destruct()}catch(e){}s(!0),n(!0),o(!0)}})}function i(e){return $("<div>").tmpl("t_files_new_item",{id:e.id,name:e.name,size:e.origSize,type:e.type,typeMy:1}).children("li")}function a(t){$("#left_menu").children().hide(),$(".js-top-toolbar > .toolbar").empty(),$("#mail_list, .browse, #settings-wrap, #f_write_btn").hide(),$(".js-top-toolbar, #files_wrap").show(),exMail.setMenu(3,{type:t}),$(".ib_select_btn").ddOZ(),null===t||"r"===t?e(!0):e(),$(".ib_mail_check").click(function(){return $(this).hasClass("all")?(checkboxes(1),$("#f_write_btn").hide()):(checkboxes(0),$("#f_write_btn").show()),!1});var a=$(".ib_select_btn .ib_filter_item");a.click(function(){var e=a.index(this);console.log("index",e),$("#f_write_btn")[e?"hide":"show"](),checkboxes(e)}),f_upload({upload_url:exMail.uploadUrl,container:"f_holder",browse_button:"j_upload_file",drop_element:"j_upload_file",cb_ready:function(e,t){if($("#"+e.id).find("b").remove(),$("#"+e.id).find(".in_q").remove(),$("#"+e.id).attr("data-upload-id",t),$("#"+e.id).find(".f_download").attr("href","javascript:;").show(),$("#"+e.id).find("em").show(),$("#files_list>li .play").length){try{p.stop(),p.destruct()}catch(e){}s()}$("#files_list>li .im_play").length&&n(),$("#files_list>li .v_play").length&&o()},cb_progress:function(e){$("#"+e.id).find(".in_q").remove(),$("#"+e.id).find("b").text(e.percent+"%")},cb_added:function(t){"r"!==exMail.currentParams.action&&null!==exMail.currentParams.action||(exMail.router.navigate("!files/d"),e(),$(".js-l-files-list li").removeClass("js-l-file-active").removeClass("active"),$(".js-l-files-list>li[data-type=1]").addClass("js-l-file-active").addClass("active"));var a=[];$.each(t,function(e,t){var n=i(t);n.find(".f_rm").css("display","block"),a.push(n)}),$("#files_list").prepend(a)},cb_error:function(e){console.log(e.message)}})}function n(e){function t(e){r.add(l).show(),0==e&&r.hide(),e==m.length-1&&l.hide()}function i(e){if(!g)return e<0&&(e=0),e>m.length-1&&(e=m.length-1),e<6?d.css("left","0px"):e>m.length-5?d.css("left",-60*(m.length-5-4)+"px"):d.css("left",-60*(e-4)+"px"),e}function a(){var e=[];m.each(function(t,i){var a=$(this).parent().attr("data-upload-id");a&&e.push($("<div>").attr("data-npp",t).css({background:"url(/show/"+a+"?resize=80) 50% 50% no-repeat","background-size":"cover"}).click(function(){$(i).click()})),$(this).attr("data-npp",t)}),d.empty().append(e),d.css("width",60*m.length+"px").css("left","0px"),m.length<=9?(h.add(_).off("click").hide(),d.parent().width(60*m.length-10),g=!0):(h.show(),_.show(),d.parent().width(530),g=!1,h.off("click").click(function(){var e=0|d.css("left").replace("px","");(e=Math.abs(e)-180)<0&&(e=0),d.css("left",-e+"px")}),_.off("click").click(function(){var e=0|d.css("left").replace("px",""),t=d.width()-540;(e=Math.abs(e)+180)>t&&(e=t),d.css("left",-e+"px")}))}var n,o=$("#preview_box"),s=o.find(".view"),r=o.find(".prev"),l=o.find(".next"),d=o.find(".list"),c=o.find(".close"),u=o.find(".file_link > a"),p=o.find(".file_name"),h=o.find(".ssc_prev"),_=o.find(".ssc_next"),m=[],f=0;void 0==e&&(e=!1);var g=!0;(m=e?$(".att_files_wr>ul>li .im_play"):$("#files_list>li .im_play")).click({id:0},function(e){a(e.data.id),r.unbind().click(function(){return--f<0&&(f=0),m.eq(f).click(),i(f),!1}),l.unbind().click(function(){return++f>m.length-1&&(f=m.length-1),m.eq(f).click(),i(f),!1}),f=m.index(this),n=$(this).parent().data("upload-id"),t(f),i(f),p.text($(this).find("span").eq(0).text()),n&&(s.attr({src:"/show/"+n+"?resize=1280"}),u.eq(0).attr("href","/load/"+n).attr("target","_blank").text(alerts.DOWNLOAD+" - "+$(this).parent().find(".f_size").text()),u.eq(1).attr("href","/get/"+n).attr("target","_blank").text(alerts.FULL_SIZE)),o.show(),d.find("div").removeClass("active"),d.find('div[data-npp="'+$(this).data("npp")+'"]').addClass("active")}),c.unbind().click(function(){o.hide(),$("#preview_box").find(".list").empty()})}function o(e){function t(e){s.add(r).show(),0==e&&s.hide(),e==f.length-1&&r.hide()}function i(e){return e<0&&(e=0),e>f.length-1&&(e=f.length-1),e<6?u.css("left","0px"):e>f.length-5?u.css("left",-60*(f.length-5-4)+"px"):u.css("left",-60*(e-4)+"px"),e}function a(){var e=[];f.each(function(t,i){e.push($("<div>").attr("data-npp",t).css({background:"#000 url(/i/movie.png) 50% 50% no-repeat"}).click(function(){$(i).click()})),$(this).attr("data-npp",t)}),u.empty().append(e),u.css("width",60*f.length+"px").css("left","0px"),f.length<=9?(_.add(m).off("click").hide(),u.parent().width(60*f.length-10)):(_.show(),m.show(),u.parent().width(530),_.off("click").click(function(){var e=0|u.css("left").replace("px","");(e=Math.abs(e)-180)<0&&(e=0),u.css("left",-e+"px")}),m.off("click").click(function(){var e=0|u.css("left").replace("px",""),t=u.width()-540;(e=Math.abs(e)+180)>t&&(e=t),u.css("left",-e+"px")}))}var n,o=$("#video_box"),s=o.find(".prev"),r=o.find(".next"),l=o.find(".close"),d=o.find("video").addClass("video-js vjs-default-skin"),c=$("#player_window"),u=o.find(".list"),p=o.find(".file_download"),h=o.find(".file_name"),_=o.find(".ssc_prev"),m=o.find(".ssc_next"),f=[],g=0;void 0==e&&(e=!1),(f=e?$(".att_files_wr>ul>li .v_play"):$("#files_list>li .v_play")).unbind().click({id:0},function(e){a(e.data.id),g=f.index($(this).parent()),n=$(this).parent().data("upload-id"),t(g),i(g),s.unbind().click(function(){return--g<0&&(g=0),f.eq(g).click(),i(g),!1}),r.unbind().click(function(){return++g>f.length-1&&(g=f.length-1),f.eq(g).click(),i(g),!1}),h.text($(this).parent().find(".f_name").text()),n&&(c.empty().hide(),d.show(),exMail.videojs?$(exMail.videojs.el()).show():exMail.videojs=videojs(d.get(0),{width:"100%",height:"100%"},function(){this.foxPlugin()}),exMail.videojs.src({type:"video/mp4",src:"/get/"+n}),p.eq(0).attr("href","/load/"+n).attr("target","_blank").html(translate("Загрузить - ")+" <span>"+$(this).parent().find(".f_size").text()+"</span>")),u.find("div").removeClass("active"),u.find('div[data-npp="'+$(this).parent().data("npp")+'"]').addClass("active"),o.show(),$._pause&&$._pause()}),l.unbind().click(function(){"object"==typeof exMail.videojs&&(exMail.videojs.pause(),$(exMail.videojs.el()).hide(),console.info("VideoJs stoped")),c.empty().hide(),o.hide()})}function s(e){void 0==e&&(e=!1);var t=[];(t=e?$(".att_files_wr>ul>li .play"):$("#files_list>li .play")).length&&$.getScript("/v1/exmail3/js_build/lib/soundmanager2/soundmanager2-nodebug-jsmin.js").done(function(e,i){var a,n,o=$(),s=$(),r=$(),l=($(),$()),d=$(),c=-1,u="",h=0;soundManager.setup({url:"/v1/dev_deploy/libs/soundmanager/",flashVersion:9,ontimeout:function(){},onready:function(){p=soundManager.createSound({id:"exSound"}),$._atexit=function(){try{p.stop(),p.destruct()}catch(e){}},$._pause=function(){p.pause(),l.removeClass("pause"),h=2},(o=t).unbind().on("click",function(){function e(){o.removeClass("pause"),o.parent().find(".progress").unbind().find("div > div").css("width","0%"),o.parent().find(".time").text("00:00"),h=0}if(l=$(this),c!=o.index(l)){c=o.index(l),e(),(s=l.parent().find(".progress")).on("mousemove",function(e){a=$(this).offset(),n=e.pageX-a.left,d.text(formatTime(0*n/418|0)).css("left",n+"px")}).on("mouseenter",function(){$(this).find("i").fadeIn(100)}).on("mouseleave",function(){$(this).find("i").fadeOut(100)}).on("click",function(e){a=$(this).offset(),n=e.pageX-a.left,p.setPosition(1e3*(0*n/418|0))}),r=l.parent().find(".time"),d=l.parent().find(".progress > i"),s=s.find("div > div");var t=$(this).parent().data("upload-id");t&&(u="/get/"+t),h=1,l.addClass("pause"),p.stop(),p.play({url:u,multiShot:!1,onplay:function(){},onpause:function(){},onresume:function(){},onstop:function(){},onfinish:function(){e(),c=-1},whileplaying:function(){}})}else 1==h?(p.pause(),l.removeClass("pause"),h=2):2==h&&(p.resume(),l.addClass("pause"),h=1)})}})})}var r=Backbone.View.extend({el:$("#settings-wrap"),render:function(e){exMail.utils.setTitle(window.titles[Backbone.history.fragment.substring(1)]),$("#ib_search_contact, #ib_search").hide().val(""),$("#ib_search_btn, #ib_search_btn2").hide(),$(".tools_item > a").removeClass("active"),$("#att_mod").removeClass("att_open"),$(".tools_item > .files_ln").addClass("active"),ur_p_files=0,_=0,m=0,f=40,g=!0,a(e)}});$(document).on("click","#f_write_btn",function(){$("#files_list>.selected").each(function(e,t){global_files_arr.push({upload_id:$(this).attr("data-upload-id"),name:$(this).find(".f_name").text()})}),exMail.router.navigate("!inbox?compose=new",{trigger:!0})}),$(document).on("click",".tools_item > a",function(){$(this).hasClass("files_ln")||$(this).parent().hasClass("ib_user_item")||($("#files_wrap").hide(),$("#f_write_btn").hide())}),$(document).on("click",'#files_list > li input[type="checkbox"]',function(){$(this).is(":checked")?$(this).parent().parent().addClass("selected"):$(this).parent().parent().removeClass("selected"),$("#files_list>.selected").length?$("#f_write_btn").show():$("#f_write_btn").hide(),$anchor=$(this).parent()}),$(document).on("click","#files_list .f_name",function(){$(this).parent().find("em").click()}),$(document).on("click",".f_rm",function(){if(!confirm(window.alerts.NOTE_RM_FILE))return 0;var e=$(this).parent(),t=e.attr("data-upload-id");t?$.getJSON("/j_upload_delete/"+t).done(function(t){t.result?e.remove():alert("Ошибка при удалении файла.")}).fail(function(){alert("Ошибка при удалении файла.")}):(window._cur_uploader.removeQueuedFile(e.attr("id")),e.remove())}),$(document).on("click","#file_list_btn",function(){$("#att_mod").toggleClass("att_open"),$(this).toggleClass("file_l_open"),$(".att_m_list>li[data-type=1]").click()}),$(document).on("click",".attach_from_list_btn",function(){var e=$(this).parent().attr("data-upload-id");if(e){var t=[{name:$(this).parent().find(".f_name").text(),upload_id:e,size:$(this).parent().find(".f_size").text()}],i=_copy_files(t_msg_id,t);$("#"+t_msg_id+"_upload_body").append($("<div>",{id:"upload_"+i[0],"data-upload_id":i[0],class:"upload","data-file_id":i[0],"data-msg_id":t_msg_id}).append($("<div>",{class:"delete"}).click(deleteUploadClick).append($("<i>"))).append($("<div>",{class:"name loaded",text:t[0].name,"data-method":"/load/"}).click(getFile)).append($("<div>",{class:"size",text:t[0].size}).click(uploadClick))).show(),$(this).hide().parent().children(".deatt_btn").show().attr("data-upload_id",i[0])}}),$(document).on("click",".deatt_btn",function(){$('div[data-upload_id="'+$(this).attr("data-upload_id")+'"]').find(".delete").click(),$(this).hide().parent().children(".attach_from_list_btn").show()}),$(function(){function e(e,t){if(void 0===e)return!1;var i=null;return $.ajax({url:"http://ex.ua/"+e+(void 0===t?"":"/"+t),dataType:"text",type:"get",async:!1,success:function(e){i=e}}),i}function t(t){var a=e("i_storge_fs"),n=1;if(1!=(a=a.split(","))[0])return console.warn("Error: i_storge_fs"),!1;n=a[1],console.log("Fs:",n),console.log("Max size: ",$.formatSize(a[2]));var s=$("#ex_list");void 0!==t&&i(o),f_upload({upload_url:"http://fs"+n+".www.ex.ua/r_upload",container:"ex_holder",browse_button:"ex_upload_btn",file_data_name:"Filedata",multipart_params:{key:o,action_id:2,dpr:window.devicePixelRatio||1},drop_element:$(".att_modal_wr_2gb").get(0),cb_ready:function(e,t){$("#"+e.id).removeClass("ex_new"),$("#"+e.id).attr("data-file-id",t.split(",")[0])},cb_progress:function(e){$("#"+e.id).find(".ex_progress").css("width",e.percent+"%")},cb_added:function(e){$(".first_2gb_bl").hide(),$("#ex_list").show(),$.each(e,function(e,t){var i=$("<li>",{id:t.id,html:'<span class="ex_name">'+t.name+"</span>","data-name":t.name,"data-type":t.type,class:"ex_new"});i.append("<em></em><i>"+$.formatSize(t.size)+'</i><div class="ex_progress"></div>'),s.append(i)})},cb_error:function(e){console.log(e.message)},max_file_size:"100Gb",res_type:"text"})}function i(e){var t=$(".msg_content");if(!e)return!1;var i=$("<a>",{title:alerts.EDIT_EX_OBJECT,class:"ex_obj ex_obj_open",href:"http://www.ex.ua/"+e,text:"www.ex.ua/"+e,"data-key":e});n&&(n+=2),t.redactor("caret.setOffset",n),t.redactor("insert.html",$("<div>").append(i).html()+"&nbsp;")}function a(e){var t=$("#ex_list");$(".first_2gb_bl").hide(),t.show(),$.each(e,function(e,i){if(i.length){var a=i.split(",",5),n=$("<li>",{html:'<span class="ex_name">'+a[4]+"</span>","data-name":a[4],"data-file-id":a[0]});t.append(n.append("<em></em><i>"+$.formatSize(a[3])+"</i>"))}})}$("#att_close").on("click",function(){$(this).parent().parent().toggleClass("att_open"),$("#file_list_btn").toggleClass("file_l_open")}),$("#att_mod_2gb").draggable({handle:"#att_handle_2gb"});var n=0;$(document).on("keydown click blur",".redactor-editor",function(){n=$(".msg_content").redactor("caret.getOffset")});var o=null;$(document).on("click",".ex_obj",function(i){if($(this).hasClass("ex_obj_open"))return $("#att_mod_2gb").removeClass("att_open_2gb"),$(this).removeClass("ex_obj_open"),!1;if($("#att_mod_2gb").hasClass("att_open_2gb")||$("#att_mod_2gb").addClass("att_open_2gb"),$(".ex_obj").removeClass("ex_obj_open"),$(this).addClass("ex_obj_open"),o=$(this).data("key")){var n=e("i_file_list",o);$("#att_handle_2gb span").text(o),$("#ex_list").empty(),n.length?a(n=n.split("\n")):($(".first_2gb_bl").show(),$("#ex_list").hide()),t()}else console.warn("Error: i_create_storage");i.preventDefault()}),$(document).on("click","#ex_list>li>em",function(){if($(this).parent().hasClass("ex_new"))return window._cur_uploader.removeQueuedFile($(this).parent().attr("id")),$(this).parent().remove(),!1;var t=$(this).parent().data("file-id"),i=e("i_delete_storage_upload",o+"/"+t);1==(i=i.split(","))[0]&&(console.log("ok, deleted "+t),$(this).parent().remove())})});var l=0,d=1,c=2;$(document).on("click",".att_m_list>li",function(){$(".att_m_list>li").removeClass("f_active"),$(this).addClass("f_active");var e=parseInt($(this).attr("data-type"),10);l=0,$(".att_files_wr>ul").empty(),$(".att_files_wr").scrollTop(0),e?(d=1,t(l,void 0)):(d=0,t(l,!0)),l++}),$("#do_back, #do_spam, #do_move").on("click",function(){$("#att_mod").removeClass("att_open")}),$(".att_files_wr").scroll(function(){if(l>=c)return 0;$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&(d?(d=1,t(l++,void 0)):(d=0,t(l++,!0)))});var u=0;$(document).on("click",".ib_f_prev, .ib_f_next",function(){if(!g)return 0;"next"===$(this).attr("data-trend")?h<(m-m%f)/f&&(_=++h*f,g=!1,u?e():e(!0)):h>0&&(_=--h*f,_=m,g=!1,u?e():e(!0))}),$(document).on("click",".js-l-files-list li",function(){u=parseInt($(this).attr("data-type"),10),h=0,_=0,m=0,f=40,g=!0,u?exMail.router.navigate("!files/d",{trigger:!0}):exMail.router.navigate("!files/r",{trigger:!0}),console.log(u)});var p,h=0,_=0,m=0,f=40,g=!0;$(document).on("click","#files_list .f_download",function(){window.open("/load/"+$(this).parent().attr("data-upload-id"))}),exMail.ui.files=new r}(),function(){"use strict";if(!exMail.isAuth)return!1;var e=Backbone.View.extend({el:$("<div>"),getGroupList:function(e){for(var t=0,i=0,a=[];t<$._user_group.length;++t)(i=0|$._user_group[t][0])>30||i<0||0!=(1<<i&e)&&a.push($._user_group[t][1]);return a},getContactCount:function(e,t){for(var i=0,a=0,n=0;i<e.length;++i){n=0|e[i][2];t>30||t<0||0!=(1<<t&n)&&++a}return a},filterContact:function(e,t){var i=0,a=[],n=0;for(t|=0;i<e.length;++i){n=0|e[i][2];t>30||t<0?console.log("continue"):0!=(1<<t&n)&&a.push(e[i])}return a},setGroup:function(e,t,i){$.ajax({url:"/j_contact_change",data:{email:e,name:t,group_mask:i},dataType:"JSON",type:"GET",async:!1}).done(function(e){console.log(e)})},refreshContactList:function(e){var t=this,i=0;$.getJSON("/j_contact_list").done(function(e){for(i=0;i<e.length;++i)n=0|e[i][2],e[i].length>3?e[i][3]=t.getGroupList(n).join(", "):e[i].push(t.getGroupList(n).join(", "));$._user_contacts=e;var a=$(".js-group-active").data("group");exMail.setMenu(1,e),$(".js-group").removeClass("js-group-active").removeClass("active"),$('.js-group[data-group="'+a+'"]').addClass("js-group-active").addClass("active").click()})},render:function(){}}),t=Backbone.View.extend({el:$("<div>"),render:function(e){var t=e,i=$('.js-group[data-group="'+t+'"]');if($(".l-menu li").removeClass("js-group-active").removeClass("active"),i.addClass("js-group-active").addClass("active"),void 0!=t){var a=exMail.ui.contacts.filterContact($._user_contacts,t),o=exMail.ui.contacts.getContactCount($._user_contacts,t);o>0?i.find(".js-count").text(o):i.find(".js-count").empty(),$("#mail_list").empty().tmpl("t_contact_list",{list:a});var s=$($("#t_add_contact_note").html());$("#mail_list > .ib_mail_list > li").length?s.remove():$("#mail_list > .ib_mail_list").append(s),$(".js-top-toolbar").tmpl("t_toolbar_contact_list01",{groups:$._user_group,group:t})}else $("#mail_list").empty().tmpl("t_contact_list",{list:$._user_contacts}),$(".js-top-toolbar").tmpl("t_toolbar_contact_list",{groups:$._user_group,group:t});$(".ib_select_btn, .ib_groups_btn, .ib_group_btn, .ib_add_to_group_btn").ddOZ({autoClose:!1}),$(".ib_add_to_group_btn").click(function(){$(this).find("input").focus()});var r=null;$(".ib_add_to_group_btn").find("button").click(function(){if(r){var e=0|r[2];e|=1<<t,exMail.ui.contacts.setGroup(r[0],r[1],e),r[2]=e;for(var i=$._user_contacts,a=0;a<i.length;++a)n=0|i[a][2],i[a].length>3?i[a][3]=exMail.ui.contacts.getGroupList(n).join(", "):i[a].push(exMail.ui.contacts.getGroupList(n).join(", "))}});for(var l=[],d=0;d<$._user_contacts.length;d++)""!=$._user_contacts[d][1]?l.push({label:$._user_contacts[d][1]+" <"+$._user_contacts[d][0]+">",value:$._user_contacts[d][1]+" <"+$._user_contacts[d][0]+">",data:$._user_contacts[d]}):l.push({label:$._user_contacts[d][0],value:$._user_contacts[d][0],data:$._user_contacts[d]});$(".ib_add_to_group_btn").find("input").autocomplete({source:l,select:function(e,t){r=t.item.data,$(".ib_add_to_group_btn").find("button").click(),Backbone.history.loadUrl(Backbone.history.fragment)},open:function(e,t){}}),$("#add_cont_direct").on("click",function(){var e=$(".ib_add_to_group_btn").find("input").val(),t=!1;if(_.each($._user_contacts,function(i){if(e==i[0])return console.log(i[0]),t=!0,!1}),t)return $.note({text:alerts.EMAIL_ISSET,cont:$("#alert_box")}),!1;if(e.isEmpty())return $.note({text:alerts.ERR_EMPTY_EMAIL,cont:$("#alert_box")}),!1;if(!validateEmail(e))return $.note({text:alerts.ERR_INVALID_EMAIL,cont:$("#alert_box")}),!1;var i=$(".js-group-active"),a=0;a|=1<<i.data("group")|0,$.ajax({url:"/j_contact_change",type:"GET",dataType:"JSON",data:{email:e,name:"",group_mask:a}}).done(function(t){$._user_contacts.push([e,name,a,i.find("span").text()]),Backbone.history.loadUrl(Backbone.history.fragment)})}),$(".ib_add_to_group_btn").find("input").keyup(function(e){13==(e.keyCode?e.keyCode:e.which)&&$("#add_cont_direct").trigger("click")}),$(".ib_group_btn .ib_filter_item").click(function(){var e=$(this).data("group");if("remove"==$(this).data("act"))confirm(alerts.REMOVE_GROUP_Q)&&$.ajax({url:"/j_contact_group_change/"+e,type:"GET",dataType:"JSON"}).done(function(t){if(1==t.result){var i=$._user_contacts;for(d=0;d<i.length;++d){var a=0|i[d][2];0!=(a&1<<e)&&(a&=~(1<<e),exMail.ui.contacts.setGroup(i[d][0],i[d][1],a))}$.getJSON("/j_contact_group_list").done(function(e){$._user_group=e,exMail.router.navigate("!contacts",{trigger:!0})})}});else{var t=prompt(alerts.GROUP_NAME,$('.js-group[data-group="'+e+'"]').find("span").text());null!=t&&""!=t&&$.ajax({url:"/j_contact_group_change/"+e,type:"GET",dataType:"JSON",data:{name:t}}).done(function(e){1==e.result&&$.getJSON("/j_contact_group_list").done(function(e){$._user_group=e,Backbone.history.loadUrl(Backbone.history.fragment)})})}}),t_init_contact(t)}});$._user_group=[],$._user_contacts=[],(new exMail.model.loadGroup).fetch({success:function(e,t,i){$._user_group=t}}),$(document).on("click","#ib_search_btn2",function(){$("#ib_search_contact").val(""),$(this).hide(),Backbone.history.loadUrl(Backbone.history.fragment),searchByAllMails=!1}),$(document).on("keyup","#ib_search_contact",function(){var e=$(this).val();if(""!=e){e=e.toLowerCase();for(var t=$._user_contacts,i=[],a=0;a<t.length;++a)-1==t[a][0].toLowerCase().indexOf(e)&&-1==t[a][1].toLowerCase().indexOf(e)||i.push(t[a]);$("#ib_search_btn2").show(),$("#mail_list").empty().tmpl("t_contact_list",{list:i}).addClass("ib_contact ib_mail_compact"),$(".l-menu li").removeClass("js-group-active").removeClass("active")}else exMail.router.navigate("!contacts",{trigger:!0})}),$(document).on("click",".js-group",function(e){var t=$(this).data("group");void 0!=t&&"all"!=t?exMail.router.navigate("!contacts/g/"+t,{trigger:!0}):(exMail.router.navigate("!contacts",{trigger:!0}),exMail.currentParams.groupId=void 0)}),$(document).on("click","#j_new_contact",function(){exMail.router.navigate("!contacts/new",{trigger:!0})}),$(document).on("click",".js-add-group",function(e){$("#settings-wrap").hide();var t=prompt(alerts.GROUP_NAME);if(null!=t&&""!=t){var i=0,a=0,n=[],o=-1;for($(".exmail_menu_list");a<30;++a)n.push(0);for(;i<$._user_group.length;++i)(a=0|$._user_group[i][0])>=0&&a<30&&(n[a]=1);for(a=0;a<30;++a)if(0==n[a]){o=a;break}-1!=o?$.ajax({url:"/j_contact_group_change/"+o,type:"GET",dataType:"JSON",data:{name:t}}).done(function(e){1==e.result&&$.getJSON("/j_contact_group_list").done(function(e){$._user_group=e,exMail.router.navigate("!contacts/g/"+o,{trigger:!0})})}):console.log("Error add group")}else exMail.router.navigate("!contacts",{trigger:!0})}),exMail.ui.contacts=new e,exMail.ui.contactsGroup=new t}(),function(){"use strict";exMail.ui.settPro=Backbone.View.extend({render:function(){}})}(),function(){"use strict";exMail.ui.expressSignup=Backbone.View.extend({events:{"click button[data-exp-create]":"createClick","click button[data-exp-confirm]":"confirmPhone","click #captcha_refresh":"refreshCaptcha"},el:$(".container"),confirmPhone:function(){var e=this,t=this.$el.find("input[name=exp_code]").val();if(!t.length)return e.$el.find("input[name=exp_code]").addClass("reg_inpt_err"),e.$el.find(".exp_err").show().text(window.SERVER_ERRORS[1125].msg),!1;$.ajax({url:"/j_signup_phone",type:"get",dataType:"json",data:{phone:e.phone,code:t,captcha_token:this.$captcha_token.val(),captcha_value:this.$captcha.val()},success:function(t){if(console.info(t),t.captcha?e.genCaptcha():e.$el.find(".exp_kp").hide(),t.result){t.use_cookie=1,function(e){$.ajax({url:"/j_login",type:"post",dataType:"json",data:e,success:function(e){console.log(e),e.result&&(window.location="/")}})}(t),e.$el.find(".exp_err").hide()}else if(t.err){switch(e.$el.find("input[name=exp_code], input[name=captcha_value]").removeClass("reg_inpt_err"),t.err.id){case 1125:e.$el.find("input[name=exp_code]").after(e.$el.find(".exp_err")),e.$el.find("input[name=exp_code]").addClass("reg_inpt_err");break;case 1101:e.$el.find(".exp_kp").after(e.$el.find(".exp_err")),e.$el.find("input[name=captcha_value]").addClass("reg_inpt_err");break;default:e.$el.find(".login_bl").append(e.$el.find(".exp_err"))}e.$el.find(".exp_err").show().text(window.SERVER_ERRORS[t.err.id].msg)}else e.$el.find(".exp_err").hide()}})},createClick:function(){this.phone=this.$phone.intlTelInput("getNumber"),this.phone.length&&exMail.router.navigate("!express_signup/"+this.phone,{trigger:!1}),this.create()},create:function(){var e=this,t=this.phone,i=this.$phone.intlTelInput("getValidationError");if(!this.$phone.intlTelInput("isValidNumber"))return exMail.inputTelErrors(i),this.$phone.focus(),!1;$.ajax({url:"/j_signup_phone",type:"get",dataType:"json",data:{phone:t,captcha_token:this.$captcha_token.val(),captcha_value:this.$captcha.val()},success:function(i){if(console.info(i),i.captcha?e.genCaptcha():e.$el.find(".exp_kp").hide(),i.result){e.$el.find(".exp_phone_bl").hide(),e.$el.find(".exp_kp_wr").replaceWith(e.$el.find(".exp_kp"));var a=e.phone.replace(/\D/g,"")+"@"+exMail.initData.domain.name;e.$el.find(".exp_dis_phone").val(a),e.$el.find(".exp_create_num").text(a),LOGIN&&e.$el.find(".exp_my_cur").text($.user_email),e.$el.find(".exp_confirm_bl").show(),e.$el.find(".exp_err").hide()}else i.err?1134==parseInt(i.err.id)?(e.$el.find(".exp_num_exist_bl").show().find("a").attr("href","#!logout/"+t),e.$el.find(".exp_err").hide(),e.$el.find("input[name=exp_phone]").addClass("reg_inpt_err"),LOGIN?(e.$el.find(".warn_logout_first").show(),e.$el.find(".exp_cur_acc").text($.user_email)):e.$el.find(".warn_logout_first").hide()):(e.$el.find(".exp_err").show().text(window.SERVER_ERRORS[i.err.id].msg),e.$el.find(".exp_num_exist_bl").hide(),e.$el.find("input[name=exp_phone]").removeClass("reg_inpt_err"),e.$el.find(".warn_logout_first").hide()):e.$el.find(".exp_err").hide()}})},render:function(e){try{exMail.utils.setTitle(window.alerts.EXPRESS_HEAD),this.$el.empty(),this.$el.appendTmpl("t_express_bl"),this.$el.find(".ib_widgets_bl").tmpl("t_wg_bl"),this.$el.find(".exp_kp").tmpl("t_login_captcha_img"),this.$el.find(".auth-footer").tmpl("t_bottom_in");var t=this.$el.find(".lang_bl"),i=getLanguageFromCookie();this.$phone=this.$el.find("input[name=exp_phone]"),this.$captcha=this.$el.find("input[name=captcha_value]"),this.$captcha_token=this.$el.find("input[name=captcha_token]"),t.find(".lang_btn .lang_span").text(t.find('li[data-lang="'+i+'"]').text()),this.$el.find(".lang_wr").ddOZ(),SHOW_CAPTCHA&&this.genCaptcha(),this.$phone.intlTelInput(exMail.confInptTel),e&&(this.phone="+"+e.replace(/\D/g,""),this.$phone.val(this.phone),setTimeout(this.create.bind(this),1e3))}catch(e){console.log(e.message)}},genCaptcha:function(){var e=this.make_token(),t=this.$el.find(".exp_kp");t.find("#captcha").attr("src","/captcha?captcha_token="+e+"&"+Math.random()),t.find('input[name="captcha_token"]').val(e),t.find('input[name="captcha_value"]').val(""),t.show()},refreshCaptcha:function(){this.genCaptcha()},make_token:function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}})}(),function(){exMail.ui.Print=Backbone.View.extend({el:$(".container"),initialize:function(){$(".inbox_wr").hide(),this.deferreds=[]},_renderThread:function(){var e=this;$.getJSON("/j_thread_index/"+this.curId).done(function(t){var i=t.length;_.each(t,function(t,i){var a=$.getJSON("/j_thread_read/"+t);e.deferreds.push(a)}),$.when.apply($,e.deferreds).done(function(){var t=$.makeArray(arguments);e.$el.empty(),e.$el.appendTmpl("t_print_version_head"),1==i?"success"===t[1]&&e._renderMsg(t[0]):_.each(t,function(t,i){"success"===t[1]&&e._renderMsg(t[0])}),setTimeout("window.print();",2e3)})})},_renderMsg:function(e){$.htmlBody(e,this.setEntity.bind(this))},_renderMsgOne:function(){var e=this;$.getJSON("/j_thread_read/"+this.curId).done(function(t){e.$el.empty(),e.$el.appendTmpl("t_print_version_head"),e._renderMsg(t),setTimeout("window.print();",2e3)})},setEntity:function(e){var t=e.msg;t.html=e.html,t.to_prepare=_.map(t.to,function(e,i){return'<span class="js-user-mail-tt" data-user="'+t.to_name[i]+'" data-mail="'+e+'">'+(t.to_name[i]?t.to_name[i]:e)+"</span>"}),t.msg_time_full=timeConverter(0|t.msg_time),t.msg_time=timeConverter(0|t.msg_time,!0),t.avatar_data=getAvatart(t.from,getLoginColor(t.from)),updateFileList(t);var i=$.htmlTmpl("t_read",t),a=$(i);a.find(".gr_bg").hide(),a.find(".im_mail_body").find('div[dir="ltr"]').removeAttr("id").removeAttr("class"),this.$el.append(a)},render:function(e){$("body").addClass("print-version-container"),clearInterval($.boxInterval),this.curId=e.id,this.$el.empty().append("<b>Loading...</b>"),"thread"==e.entityType?this._renderThread():"msg"==e.entityType&&this._renderMsgOne()}})}(),function(){"use strict";exMail.ui.contentPage=Backbone.View.extend({el:document.getElementById("app"),initialize:function(){},render:function(e){var t=$(document.documentElement);exMail.utils.setTitle(e.title),t.addClass((e.className," "+e.className)),this.$el.addClass("fex-home"),$(".app-main-js").hide(),this.$el.appendTmpl("fexmail-header",{showLeftNav:exMail.domainSettings.headerLeftNavVisible}),this.$el.appendTmpl(e.templateId,{heading:e.heading}),this.$el.appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmail,hasApplicationBlock:e.hasApplicationBlock})}})}(),function(){function e(e){return""!==e}function t(){return this.$phoneInput.intlTelInput("isValidNumber")}function i(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(e)}var a=[{name:"fio",validator:e},{name:"phone",validator:t},{name:"email",validator:i},{name:"companyName",validator:e},{name:"payment",validator:e}],n=Backbone.Model.extend({}),o=Backbone.View.extend({tagName:"div",className:"biz-request-modal",events:{"click .fex-form__group":"removeErrorOnClick","click .js-submit-btn":"submit","click #js-error-alert":"closeAlert",'change input[name="payment"]':"changePayment"},model:new n,initialize:function(){this.tpl=doT.template($("#fexmail-corp-request-modal").html())},render:function(){return exMail.utils.setTitle(window.fexTitles.corp),this.$el.html(this.tpl(this.model.toJSON())),this.submitBtn=this.$el.find(".js-submit-btn"),this.form=this.$el.find('form[name="request"]')[0],this.$phoneInput=this.$el.find('input[name="phone"]'),this.errorAlert=this.$el.find("#js-error-alert"),this.$phoneInput.intlTelInput(exMail.confInptTel),this},toggleModal:function(){$(document.body).hasClass("is-request-visible")&&this.closeAlert(),$(document.body).toggleClass("is-request-visible"),$(document.body).removeClass("is-thanks-visible"),this.clearFormFields()},changePayment:function(e){this.$el.find(".biz-request__radio").removeClass("biz-request__radio--active"),$(e.target).closest(".biz-request__radio").addClass("biz-request__radio--active")},clearFormFields:function(){a.forEach(function(e){var t=this.form[e.name];if(t.length&&(t=t[0]),"radio"===t.type){this.$el.find(".biz-request__radio--active").removeClass("biz-request__radio--active");var i=document.querySelectorAll('[name="'+e.name+'"]');(i=Array.prototype.slice.call(i)).forEach(function(e){var t=e.hasAttribute("checked");e.checked=t,t&&$(e).closest(".biz-request__radio").addClass("biz-request__radio--active")})}else t.value=""},this),this.$el.find(".has-error").removeClass("has-error"),this.$el.find(".biz-request__input--error").removeClass("biz-request__input--error")},closeAlert:function(){this.errorAlert.removeClass("biz-request-alert--is-visible")},showThanksMessage:function(){$(document.body).addClass("is-thanks-visible"),this.clearFormFields(),this.submitBtn.disabled=!1},showError:function(e){var t=this.form[e].length?this.form[e][0]:this.form[e],i=$(t).closest(".fex-form__group")[0];$(i).addClass("has-error"),$(t).addClass("biz-request__input--error"),i.setAttribute("data-toggle","remove-error")},removeErrorOnClick:function(e){var t=$(e.target).closest('[data-toggle="remove-error"]')[0];t&&!e.target.readOnly&&($(t).removeClass("has-error"),t.removeAttribute("data-toggle"),$(e.target).removeClass("biz-request__input--error"))},submit:function(e){function t(){this.status>=200&&this.status<300?r.showThanksMessage():i.call(this,arguments)}function i(){r.errorAlert.addClass("biz-request-alert--is-visible"),r.submitBtn.disabled=!1}if(e.preventDefault(),!e.target.disabled){var n=!1,o={};if(a.forEach(function(e){var t=this.form[e.name].value;e.validator.call(this,t)?o[e.name]=t:(this.showError(e.name),n=!0)},this),!n){this.submitBtn.disabled=!0;var s=new XMLHttpRequest,r=this;s.open("GET","https://fex.net/j_junk_save?json="+JSON.stringify(o)),s.onload=t,s.onerror=i,s.send()}}}});exMail.ui.corporate=Backbone.View.extend({el:document.getElementById("app"),events:{"click .js-toggle-request-modal":"toggleModal"},initialize:function(){},render:function(){exMail.utils.setTitle("Корпоративная почта на вашем домене"),$(".app-main-js").hide(),$(document.documentElement).addClass("fex-cor-page"),this.$el.appendTmpl("fexmail-corp-request",{}),this.request=new o,this.$el.append(this.request.render().el),this.$el.appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmailCorp})},toggleModal:function(){this.request.toggleModal()}})}(),function(){var e=exMail.model.FormModel.extend({defaults:{companyName:"",email:""},validations:{companyName:["required"],email:["required","email"]}}),t=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-form--wide",tpl:null,attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-corp-register-form-first").html()),this.events=_.extend({},this.events,{submit:"submit"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this},submit:function(e){e.preventDefault(),this.model.isValid()&&this.model.trigger("complete")}}),i=exMail.model.FormModel.extend({defaults:{phone:"",logo:"",companyName:""},validations:{phone:["required","intlTelNumber"]}}),a=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-form--wide",tpl:null,attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-corp-register-form-second").html()),this.events=_.extend({},this.events,{submit:"submit"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){this.$el.html(this.tpl(this.model.toJSON()));var e=this.$el.find('[name="phone"]');return e.intlTelInput(exMail.confInptTelWithPlaceholder),e.on("countrychange",function(){$(this).trigger("change")}),this},submit:function(e){e.preventDefault(),this.model.isValid()&&this.model.trigger("complete")}}),n=exMail.model.FormModel.extend({defaults:{domain:"",domainWasEntered:!1},validations:{domain:["required","domainWithProtocol"],approveType:["required"]},getTypeId:function(){switch(this.get("approveType")){case"html":return 1;case"meta":return 2}},getDomain:function(){var e=this.get("domain");return e=removeTrailingSlash(e),e=removeProtocol(e),removeWww(e)},getApproveToken:function(){var e=this,t="/j_domain_validate?domain="+this.getDomain()+"&type_id="+this.getTypeId();return jQuery.Deferred(function(i){$.get(t).then(function(t){1===t.result?(e.set("token",t.token,{silent:!0}),i.resolve()):i.reject(t)})})},approve:function(){function e(e){return function(a){clearTimeout(i),t.set("approving",!1),e(a)}}var t=this,i=setTimeout(function(){t.set("approving",!0)},250);return jQuery.Deferred(function(a){var n=e(a.reject);t.getApproveToken().then(function(){$.get("/j_domain_validate_status?domain="+t.getDomain()).then(function(e){clearTimeout(i);var n={approving:!1};if(1===e.result&&1===e.status_id)return a.resolve();n.approveError=!0,t.set(n)},n)},n)})},isValidDomain:function(){return this._validators.domainWithProtocol.call(this,this.get("domain")).valid}}),o=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-form--wide",tpl:null,attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-corp-register-form-third").html()),this.events=_.extend({},this.events,{submit:"submit","click .js-approve-dropdown .fex-dropdown__btn":"toggleApproveDropdown","click [data-approve-type]":"setApproveType"}),this.form=this.el,this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors),this.listenTo(this.model,"change:domain",this.onDomainChange),this.listenTo(this.model,"change:approveType",this.render),this.listenTo(this.model,"change:token",this.render),this.listenTo(this.model,"change:approving",this.render),this.listenTo(this.model,"change:approveError",this.render)},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this.$approveDropdown=this.$(".js-approve-dropdown"),this},onDomainChange:function(){!this.model.get("domainWasEntered")&&this.model.isValidDomain()&&(this.model.set("domainWasEntered",!0,{silent:!0}),this.render())},submit:function(e){if(e.preventDefault(),this.model.isValid()){var t=this;this.model.approve().then(function(){t.model.trigger("complete")},function(e){if(e.err){var t=e.err?e.err.msg:SERVER_ERRORS[1002];$.note({text:t,cont:$("#alert_box"),fixed:!0})}})}},toggleApproveDropdown:function(){this.$approveDropdown.find(".fex-dropdown__btn").hasClass("fex-dropdown__btn--disabled")||this.$approveDropdown.toggleClass("is-visible",!this.$approveDropdown.hasClass("is-visible"))},setApproveType:function(){var e=$(event.target),t=e.data("approve-type"),i=this;if(this.form.approveType.value=t,t===this.model.get("approveType"))return this.toggleApproveDropdown();this.model.set({approveType:t,approveText:e.text()},{silent:!0}),this.model.getApproveToken().then(function(){i.render()},function(e){var t=e.err?e.err.msg:SERVER_ERRORS[1002];$.note({text:t,cont:$("#alert_box"),fixed:!0}),i.model.set({approveType:"",approveText:""},{silent:!0}),i.toggleApproveDropdown()})}}),s=exMail.model.FormModel.extend({defaults:{name:"",surname:"",login:"",password:"",passwordRepeat:""},validations:{name:["required"],surname:["required"],login:["required","login"],password:["required","password"],passwordRepeat:["required","matchPassword"]},createMail:function(){var e=this;return jQuery.Deferred(function(t){var i={domain:e.get("domain"),login:e.get("login"),name:e.get("name"),phone:e.get("phone"),password:e.get("password"),title:e.get("companyName"),email:e.get("email")};$.post("/j_domain_add",i).then(maybeCaptcha("j_domain_add",i)).then(function(i){var a={login:e.get("login")+"@"+e.get("domain"),password:e.get("password"),use_cookie:1,stay_signed:0};$.post("/j_login",a).then(maybeCaptcha("j_login",a,!0)).then(function(){if(1===i.result)return e.trigger("complete");t.reject()})})})}}),r=exMail.ui.FormView.extend({tagName:"form",className:"fex-form fex-form--wide",tpl:null,attributes:{novalidate:!0},initialize:function(){this.tpl=doT.template($("#fexmail-corp-register-form-fourth").html()),this.events=_.extend({},this.events,{submit:"submit"}),this.delegateEvents(),this.listenTo(this.model,"invalid",this.displayValidationErrors)},render:function(){return this.$el.html(this.tpl(this.model.toJSON())),this},submit:function(e){e.preventDefault(),this.model.isValid()&&this.model.createMail().then(null,function(){$.note({text:SERVER_ERRORS[1002],cont:$("#alert_box"),fixed:!0})})}});exMail.ui.corporateReqister=Backbone.View.extend({el:document.getElementById("app"),initialize:function(){this.firstStepModel=new e,this.secondStepModel=new i,this.thirdStepModel=new n,this.fourthStepModel=new s,this.listenTo(this.firstStepModel,"complete",this.showSecondStep),this.listenTo(this.secondStepModel,"complete",this.showThirdStep),this.listenTo(this.thirdStepModel,"complete",this.showFourthStep),this.listenTo(this.fourthStepModel,"complete",this.showFinalStep)},render:function(){exMail.utils.setTitle("Создание корпоративной почты"),this.$el.addClass("fex-home"),$(".app-main-js").hide(),$(document.documentElement).addClass("fex-sticky-footer"),this.$el.appendTmpl("fexmail-corp-register",{}),this.$el.appendTmpl("fexmail-footer",{supportMail:exMail.domainSettings.supportEmailCorp}),this.$progress=this.$(".js-progress-bar"),this.$formContainer=this.$(".js-corporate-register");var e=new t({model:this.firstStepModel});this.$formContainer.append(e.render().el)},showSecondStep:function(){this.$progress.find('[data-step="first"]').addClass("biz-progress__item--current"),this.$progress.show(),this.secondStepModel.set("companyName",this.firstStepModel.get("companyName"));var e=new a({model:this.secondStepModel});this.$formContainer.html(e.render().el)},showThirdStep:function(){this.$progress.find("[data-step]").removeClass("biz-progress__item--current"),this.$progress.find('[data-step="first"]').addClass("biz-progress__item--done"),this.$progress.find('[data-step="second"]').addClass("biz-progress__item--current"),this.$progress.show(),this.thirdStepModel.set("companyName",this.secondStepModel.get("companyName")),this.thirdStepModel.set("phone",this.secondStepModel.get("phone"));var e=new o({model:this.thirdStepModel});this.$formContainer.html(e.render().el)},showFourthStep:function(){this.$progress.find("[data-step]").removeClass("biz-progress__item--current"),this.$progress.find('[data-step="first"]').addClass("biz-progress__item--done"),this.$progress.find('[data-step="second"]').addClass("biz-progress__item--done"),this.$progress.find('[data-step="third"]').addClass("biz-progress__item--current"),this.fourthStepModel.set("companyName",this.thirdStepModel.get("companyName")),this.fourthStepModel.set("phone",this.thirdStepModel.get("phone")),this.fourthStepModel.set("domain",this.thirdStepModel.getDomain()),this.fourthStepModel.set("email",this.firstStepModel.get("email"));var e=new r({model:this.fourthStepModel});this.$formContainer.html(e.render().el)},showFinalStep:function(){this.$progress.hide();var e=doT.template($("#fexmail-corp-register-form-final").html())({login:this.fourthStepModel.get("login"),domain:this.fourthStepModel.get("domain")});this.$formContainer.html(e)}}),$(document).on("click",function(e){$(e.target).closest(".js-approve-dropdown").length||$(".js-approve-dropdown").removeClass("is-visible")})}(),function(){"use strict";exMail.ui.sett.destroy=Backbone.View.extend({events:{"click div[data-destroy-accaunt]":"destroyAccaunt","click #captcha_refresh":"refreshCaptcha","click i[data-close-remove-accaunt]":"closePopup"},initialize:function(){$(".modal").empty(),$(".modal").appendTmpl("poup_entity"),this.setElement($(".js-destroy-modal-window")),this.render()},destroyAccaunt:function(){if(!confirm("Подтвердите удаление аккаунта "+LOGIN))return!1;var e=this,t=this.$password.val();$.ajax({url:"/j_login_reset",success:function(e){console.log("reset from all")}}),$.ajax({url:"/j_self_delete",type:"post",dataType:"json",data:{password:t,captcha_value:e.$captcha.val(),captcha_token:e.$captcha_token.val(),use_cookie:!1},success:function(t){console.log(t),t.captcha?e.genCaptcha():e.$el.find(".destroy_kp").hide(),t.result||t.err&&e.$el.find(".s2_warn").text(window.SERVER_ERRORS[t.err.id].msg)},error:function(e,t,i){console.log(t,i),"Unauthorized"==i&&(createCookie("token",""),window.location="/")}})},closePopup:function(){$(".modal").hide(),this.remove()},render:function(){$(".modal").show(),this.$el.find(".entity_content_bl").appendTmpl("t_sett_destroy"),this.$el.find(".destroy_kp").appendTmpl("t_login_captcha_img"),this.$el.find(".modal__title").text(window.alerts.REMOVE_ACCAUNT_TITLE),this.$password=this.$el.find("input[name=password]"),this.$captcha=this.$el.find("input[name=captcha_value]"),this.$captcha_token=this.$el.find("input[name=captcha_token]"),this.genCaptcha()},genCaptcha:function(){var e=this.make_token(),t=this.$el.find(".destroy_kp");t.find("#captcha").attr("src","/captcha?captcha_token="+e+"&"+Math.random()),t.find('input[name="captcha_token"]').val(e),t.find('input[name="captcha_value"]').val(""),t.show()},refreshCaptcha:function(){this.genCaptcha()},make_token:function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}})}(),function(){"use strict";exMail.ui.sett.alias=Backbone.View.extend({el:$("#mail_list"),events:{"click div[data-add-phone]":"addPhone","click div[data-add-login]":"addLogin","click div[data-rm-alias]":"removeAlias"},initialize:function(){Backbone.on("verif-need-render",$.proxy(this._render_list,this))},removeAlias:function(e){var t=$(e.target).attr("data-rm-alias"),i=this;if(!confirm(alerts.CONFIRM_REMOVE+" "+t))return!1;$.ajax({url:"/j_alias_delete",dataType:"json",data:{login:t},success:function(e){e.result&&i._render_list()}})},addLogin:function(){new exMail.ui.sett.simpleLoginPopup},addPhone:function(){this.$corp_poup=new exMail.ui.sett.aliasPopup},_render_list:function(){var e=this;$.ajax({url:"/j_alias_list",dataType:"json",success:function(t){if(t.length){var i=0;_.each(t,function(e,t){!/\d+/.test(e[0])&&i++}),e.$el.empty().show().appendTmpl("t_sett_alias",{count:i}),e.$el.find("#verif_phones").empty().tmpl("t_verif_phones",{alias:t}),exMail.currentParams.aliases=t}}})},render:function(e){exMail.setMenu(5,{action:e.action}),this._render_list()}})}(),function(){"use strict";exMail.ui.sett.aliasPopup=Backbone.View.extend({events:{"click .modal__close":"closePopup","click .js-close-aliase-modal":"closePopup","click #captcha_refresh":"refreshCaptcha",'click div[data-confirm="phone"]':"confirmPhone",'click div[data-confirm-code="phone"]':"confirmCode"},initialize:function(){$(".modal").empty(),$(".modal").appendTmpl("t_verif_popup"),this.setElement($(".js-aliases-modal-window")),this.render()},confirmPhone:function(){var e=this;if(!this.$phone.intlTelInput("isValidNumber")){var t=this.$phone.intlTelInput("getValidationError"),i=this.$phone.intlTelInput("getNumberType");if(t)return exMail.inputTelErrors(t),this.$phone.focus(),!1;if(i!=intlTelInputUtils.numberType.MOBILE)return exMail.inputTelErrors(5),this.$phone.focus(),!1}$.ajax({url:"/j_alias_phone_add",dataType:"json",data:{phone:e.$phone.intlTelInput("getNumber"),captcha_token:e.$el.find('input[name="captcha_token"]').val()||"",captcha_value:e.$el.find('input[name="captcha_value"]').val()||""},success:function(t){console.log(t),t.captcha?e.genCaptcha():e.$el.find("#kp_verif").hide(),t.result?(e.$el.find(".verif_add_bl, .verif_mess").hide(),e.$el.find(".verif_confirm_bl").show(),e.$el.find("#kp_verif_confirm").replaceWith(e.$el.find("#kp_verif"))):t.err&&e.$el.find(".verif_mess").show().text(window.SERVER_ERRORS[t.err.id].msg)}})},confirmCode:function(){var e=this,t=this.$el.find("[name=verif_phone]").val(),i=this.$el.find("[name=verif_code]").val();$.ajax({url:"/j_alias_phone_add",dataType:"json",data:{phone:t,code:i,captcha_token:e.$el.find('input[name="captcha_token"]').val()||"",captcha_value:e.$el.find('input[name="captcha_value"]').val()||""},success:function(t){console.log(t),t.captcha?e.genCaptcha():e.$el.find("#kp_verif").hide(),t.result?(e.$el.find(".verif_confirm_bl").hide(),e.$el.find(".verif_success_bl").show()):t.err&&e.$el.find(".verif_mess").show().text(window.SERVER_ERRORS[t.err.id].msg)}})},closePopup:function(){this.$el.hide(),$(".modal").hide(),Backbone.trigger("verif-need-render"),this.remove()},render:function(){$(".modal").show(),this.$el.show(),this.$el.find("#kp_verif").tmpl("t_login_captcha_img"),this.$el.find(".verif_mess").hide(),this.$phone=this.$el.find("[name=verif_phone]"),this.$phone.intlTelInput(exMail.confInptTel)},genCaptcha:function(){var e=this.make_token(),t=this.$el.find("#kp_verif");t.find("#captcha").attr("src","/captcha?captcha_token="+e+"&"+Math.random()),t.find('input[name="captcha_token"]').val(e),t.find('input[name="captcha_value"]').val(""),t.show()},refreshCaptcha:function(){this.genCaptcha()},make_token:function(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<32;i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}})}(),function(){"use strict";exMail.ui.sett.labels=Backbone.View.extend({el:$("#mail_list"),events:{"keyup input[data-l_id]":"renameLabel","click .js-rm-label":"removeLabel","click #add_label":"addLabel","click .label-peeker__select-control":"openPeeker","click .label-peeker__list-item":"selectPeekerColor","click button[data-save-settings]":"saveChanges","click button[data-sett-cansel]":"cansel"},initialize:function(){this.save_name_interval=null,this.labels=null,this.$lastPeeker=$(),this.changedData={}},cansel:function(){Backbone.history.loadUrl(Backbone.history.fragment)},saveChanges:function(){$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")}),this.saveData()},openPeeker:function(e){var t=$(e.currentTarget).parent();this.$lastPeeker.get(0)!=t.get(0)&&this.$lastPeeker.removeClass("label-peeker--open"),this.$lastPeeker=t,t.hasClass("label-peeker--open")?t.removeClass("label-peeker--open"):(t.addClass("label-peeker--open"),this.$el.find(".label-peeker__dropdown").appendTo(t))},selectPeekerColor:function(e){var t=$(e.currentTarget),i=t.data("color"),a=t.closest(".label-peeker");a.find(".label-peeker__select-color").css("background-color","#"+i),a.attr("data-color",i);var n=a.data("l_id"),o=this.getLabelById(n);this.changedData[n+"l"]={name:o[1],id:n,data:{color:i}}},addLabel:function(){var e=this,t=prompt(alerts.FOLDER_NAME+":")||"";if(t.isEmpty())console.log("Empty name");else{var i=exMail.ui.sett.labels.getNewId();if(null===i)return alert("Вы создали максимальное кол-во ярлыков."),!1;$.ajax({url:"/j_box_name_change/"+i,dataType:"json",data:{name:t,data:JSON.stringify({color:"6c7a89"})},success:function(a){a.result?(e.$el.find("#lbl_tbl").show().appendTmpl("t_label_item",{labels:[[i,t,{color:"6c7a89"}]]}),Backbone.trigger("label-refresh")):console.warn("Can not create")}})}},removeLabel:function(e){var t=this;if(!confirm(alerts.DELET_CONFIRM_LABEL))return!1;var i=$(e.target).data("l_id"),a=$(e.target).parent().parent();$.ajax({url:"/j_box_name_change/"+i,dataType:"json",success:function(e){e.result?(a.remove(),t.$el.find(".label_item").length||t.$el.find("#lbl_tbl").hide(),Backbone.history.loadUrl(Backbone.history.fragment)):console.warn("Not removed")}})},renameLabel:function(e){var t=$(e.target).data("l_id"),i=$(e.target).val()||"";clearTimeout(this.save_name_interval),this.save_name_interval=setTimeout(function(){if(!t||i.isEmpty())return!1;var e=this.getLabelById(t);this.changedData[t+"l"]={name:i,id:t,data:{color:e[2].color}}}.bind(this),400)},getLabelById:function(e){var t=null;return _.each(exMail.currentParams.labels,function(i,a){if(i[0]==e)return t=i,!1}),t},saveData:function(){if(_.size(this.changedData)){var e=this,t=[];_.each(this.changedData,function(e,i){var a=$.ajax({url:"/j_box_name_change/"+e.id,dataType:"json",data:{name:e.name,data:JSON.stringify(e.data)}});t.push(a)}),$.when.apply($,t).then(function(t){console.log(t),e.changedData={},Backbone.trigger("label-refresh")})}},_render_labels:function(){var e=this;$.ajax({url:"/j_box_name_list",dataType:"json",success:function(t){exMail.currentParams.labels=t||[],exMail.currentParams.labels=_.map(exMail.currentParams.labels,function(e,t){var i,a={color:"6c7a89"};try{void 0!=(i=JSON.parse(e[2])).color&&(a=i)}catch(e){console.log(e.message)}return e[2]=a,e}),exMail.currentParams.labels.length?e.$el.find("#lbl_tbl").show().appendTmpl("t_label_item",{labels:t}):e.$el.find("#lbl_tbl").hide()}})},render:function(e){exMail.setMenu(5,{action:e.action}),this.$el.empty().show().appendTmpl("t_sett_labels"),this.$el.appendTmpl("t_peeker_body"),this._render_labels(),this.$el.appendTmpl("t_sett_save_btns")}},{get labelsIdInterval(){for(var e=[],t=101;t<=199;t++)e.push(t);return e},getNewId:function(){var e=exMail.currentParams.labels;if(!e.length)return 101;var t=[];_.each(e,function(e,i){t.push(parseInt(e[0]))}),this.labelsIdInterval;var i=_.difference(this.labelsIdInterval,t);return i.length?_.first(i):null}})}(),function(){"use strict";exMail.ui.sett.import=Backbone.View.extend({el:$("#mail_list"),events:{"click #start_import_btn":"startImport","click #stop_import":"stopImport"},initialize:function(){this.lock_stats=[0,1,2,3,4,5,6,7,100],this.stop_interval=[101,102,104],this.importInterval=null},get_import_stat:function(e){var t={};return $.ajax({url:"/j_import_status",dataType:"json",async:!e,success:function(e){t=e}}),t},stopImport:function(){this.stop_import(),clearInterval(this.importInterval),this.$el.find("#stop_import").hide()},stop_import:function(){$.ajax({url:"/j_import_stop",dataType:"json",success:function(e){console.log(e)}})},startImport:function(){var e={},t=this.$el.find("#import_email"),i=this.$el.find("#import_pass"),a=this.$el.find("#days_derect"),n=this.$el.find("#days_sel option:selected");if(!validateEmail(t.val()))return alert("Невалидный эмейл"),!1;if(e.email=t.val(),!i.val().length)return alert("Заполните поле с паролем"),!1;e.password=i.val(),a.val().length?(e.days=parseInt(a.val()),!e.days&&n.val()&&(e.days=n.val())):n.val()&&(e.days=n.val());var o=this.get_import_stat(!0).status_id;if(_.contains(this.lock_stats,parseInt(o)))return alert("Дождитесь смены текущего состояния импорта, для совершения этого действия"),!1;$.uConfig.import_mails.email=e.email,setConfig($.uConfig),$.ajax({url:"/j_import_start",data:e,dataType:"json",success:function(e){console.log(e)}}),this.importInterval=setInterval(this.updateStats.bind(this),3e3),this.$el.find("#stop_import").show()},updateStats:function(){this.$el.find(".import_from").text($.uConfig.import_mails.email);var e=this;$.ajax({url:"/j_import_status",dataType:"json",success:function(t){t.status_id=parseInt(t.status_id),t.msg_count=parseInt(t.msg_count),t.count=parseInt(t.count);var i=e.$el.find("#status_import b");if(102==t.status_id){i.addClass("import_err");var a=/answer(?:\=|\/)(\d+)/gi.exec(t.error);if(a){var n=$("<span>",{html:alerts.TWOSTAP_AUTH});n.find("a").attr("href","http://support.google.com/mail/accounts/bin/answer.py?answer="+a[1]),i.html(n)}else i.text(alerts.ERROR_SOME_FAIL)}else i.removeClass("import_err"),i.text((stats_translate[t.status_id]||"ready")+" "+(102==t.status_id?t.error:""));if((7==t.status_id||101==t.status_id)&&t.count&&t.msg_count){var o=t.count/t.msg_count*100;e.$el.find(".import_progress span").text(Math.round(o)+"% "+t.count+" из "+t.msg_count)}_.contains(e.stop_interval,t.status_id)&&(clearInterval(e.importInterval),e.$el.find("#stop_import").hide())}})},render:function(e){exMail.setMenu(5,{action:e.action}),this.$el.empty().show().appendTmpl("t_sett_import"),$.uConfig.import_mails.email.length&&validateEmail($.uConfig.import_mails.email)&&this.$el.find("#import_email").val($.uConfig.import_mails.email);var t=this.get_import_stat(!0);_.contains(this.lock_stats,parseInt(t.status_id))?(this.importInterval=setInterval(this.updateStats.bind(this),1e3),this.$el.find("#stop_import").show()):(this.updateStats(),this.$el.find("#stop_import").hide())}})}(),function(){"use strict";exMail.ui.sett.security=Backbone.View.extend({el:$("#mail_list"),events:{"click div[data-remove-accaunt-go]":"destroyAccauntGo","click button[data-save-settings]":"saveNewPassword","click button[data-sett-cansel]":"cansel","keyup input":"onInputKeyup"},cansel:function(){Backbone.history.loadUrl(Backbone.history.fragment)},destroyAccauntGo:function(){new exMail.ui.sett.destroy},onInputKeyup:function(e){13===e.keyCode&&this.saveNewPassword()},saveNewPassword:function(){var e=this.$el.find("input[name=password_restore_old]"),t=this.$el.find("input[name=password_restore]"),i=this.$el.find("input[name=password_restore2]");this.$el.find(".sett_error").text(""),this.$el.find(".settings-block__input").removeClass("settings-block__input--error"),t.val()==i.val()&&t.val().length>5&&e.val().length>5?$.ajax({url:exMail.apiUrls.savePassword,type:"post",xhrFields:{withCredentials:!0},data:{password_old:e.val(),password:t.val()},dataType:"JSON",success:function(a){1==a.result?(e.val(""),t.val(""),i.val(""),$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")})):a.err&&e.next().text(a.err.msg)}}):(t.val().length<8&&(t.focus().addClass("settings-block__input--error"),t.next().text(alerts.MORE_8)),t.val()!=i.val()&&(i.focus().addClass("settings-block__input--error"),i.next().text(alerts.ERR_PASS_COMPARE)),e.val().length<8&&(e.focus().addClass("settings-block__input--error"),e.next().text(alerts.MORE_8)))},render:function(e){exMail.setMenu(5,{action:e.action}),this.$el.empty().show().appendTmpl("t_sett_security"),this.$el.appendTmpl("t_sett_save_btns")}})}(),function(){"use strict";exMail.ui.sett.common=Backbone.View.extend({el:$("#mail_list"),events:{"click .smart-note--left":"toggleTooltip","click button[data-save-settings]":"saveSett","keyup .signature_area":"keyupSignature","click button[data-sett-cansel]":"cansel"},toggleTooltip:function(e){$(e.currentTarget).toggleClass("smart-note--open")},cansel:function(){Backbone.history.loadUrl(Backbone.history.fragment)},keyupSignature:function(e){var t=$(e.target).val();t.length<=500&&this.$el.find("#left_sum").text(500-t.length)},saveSett:function(){this.newPer=this.$el.find("#im_sel_per option:selected").val(),this.newMode=this.$el.find("#im_sel_compact option:selected").val(),this.newSignatureRadio=this.$el.find('input[name="signature"]:checked').val(),this.newSignatureVal=this.$el.find(".signature_area").val(),this.newQuote=this.$el.find("#quote-sel option:selected").val(),$.uConfig.per_page=this.newPer,$.uConfig.mode=this.newMode,$.uConfig.quote=this.newQuote,$.uConfig.signature.stat=this.newSignatureRadio,$.uConfig.signature.text=this.newSignatureVal,setConfig($.uConfig),$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")})},render:function(e){exMail.setMenu(5,{action:e.action}),this.$el.empty().show().appendTmpl("t_sett_common"),this.$el.appendTmpl("t_sett_save_btns"),this.curSettings={lang:getLanguage(),per:$.uConfig.per_page,mode:$.uConfig.mode,quote:$.uConfig.quote,tid:getCookie("tid")||""},this.$el.find("#im_sel_per").val(this.curSettings.per),this.$el.find("#im_sel_compact").val(this.curSettings.mode),this.$el.find('input[name="signature"][value="'+$.uConfig.signature.stat+'"]').prop("checked",!0),this.$el.find(".signature_area").val($.uConfig.signature.text),this.$el.find("#left_sum").text(500-$.uConfig.signature.text.length),this.$el.find("#im_sel_compact").val(this.curSettings.mode),this.$el.find("#sel_dev_mode").val(this.curSettings.tid),this.$el.find("#quote-sel").val(this.curSettings.quote),this.$el.find("#im_sel_per, #im_sel_compact, #sel_dev_mode, #quote-sel").styler()}})}(),function(){"use strict";exMail.ui.sett.profile=Backbone.View.extend({el:$("#mail_list"),events:{"click .smart-note--left":"toggleTooltip","click button[data-save-settings]":"saveSett","click button[data-sett-cansel]":"cansel","keyup #sett_name":"saveSettOnKeyup","click .js-btn-avatar-remove":"rmAvatar"},initialize:function(){this.prevPhone=null},rmAvatar:function(){var e=this;$.ajax({url:"/j_avatar_delete",dataType:"json",success:function(t){1==t.result?e.$ava.css("background-image","url(/avatar/"+$.user_email+"?resize=80&time="+(new Date).getTime()+")"):alert("Error remove avatar")}})},toggleTooltip:function(e){$(e.currentTarget).toggleClass("smart-note--open")},cansel:function(){Backbone.history.loadUrl(Backbone.history.fragment)},saveSettOnKeyup:function(e){13===e.keyCode&&this.saveSett()},saveSett:function(){var e,t=this,i=t.$el.find("#sett_name").val();if(!exMail.domainSettings.isPhoneDisabled&&(e=this.$phone.intlTelInput("getNumber"),!this.$phone.intlTelInput("isValidNumber"))){var a=this.$phone.intlTelInput("getValidationError"),n=this.$phone.intlTelInput("getNumberType");if(a)return exMail.inputTelErrors(a),this.$phone.focus(),4==a&&t.$phone.intlTelInput("setNumber",this.prevPhone),!1;if(n!=intlTelInputUtils.numberType.MOBILE)return exMail.inputTelErrors(5),this.$phone.focus(),!1}$.ajax({url:exMail.apiUrls.saveSettings,type:"post",data:{name:i,email:this.email,phone:e},dataType:"JSON",xhrFields:{withCredentials:!0},success:function(e){1==e.result?(t.$el.find(".in_user_as span").text(i),exMail.user[0].name=i,$(".menu-name-block").text(i),$.note({text:alerts.SETTINGS_PASS_ALERT,cont:$("#alert_box")})):$.note({text:window.SERVER_ERRORS[e.err.id].msg,cont:$("#alert_box")})}})},render:function(e){var t=this;exMail.setMenu(5,{action:e.action}),this.$el.empty().show().appendTmpl("t_sett_profile"),this.$el.appendTmpl("t_sett_save_btns"),this.$phone=t.$el.find("#sett_phone"),exMail.domainSettings.isPhoneDisabled||this.$phone.intlTelInput(exMail.confInptTel),$.ajax({url:exMail.apiUrls.settings,type:"post",async:!1,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){t.$el.find("#sett_name").val(e.name),t.prevPhone=e.phone,t.$phone.val("+"+e.phone),t.email=e.email}});var i=this.$el.find(".avatar-upload-progress");this.$ava=i.parent(),f_upload(e={upload_url:exMail.uploadUrl,container:"f_holder",browse_button:"upload-avatar-btn",multipart_params:{box_id:2},cb_ready:function(e,t){i.parent().css("background-image","url(/avatar/"+$.user_email+"?resize=80&time="+(new Date).getTime()+")"),$(".menu__photo-block").css("background-image","url(/avatar/"+$.user_email+"?resize=80&time="+(new Date).getTime()+")"),i.hide()},cb_progress:function(e){i.css("width",e.percent+"%")},cb_added:function(e){i.show()},cb_error:function(e){alert(e.message)}})}})}(),function(){"use strict";exMail.ui.sett.simpleLoginPopup=Backbone.View.extend({events:{"click .modal__close[data-close-remove-accaunt]":"closePopup","click div[data-add-simple]":"addAlias"},initialize:function(){$(".modal").empty(),$(".modal").appendTmpl("poup_entity"),this.setElement($(".js-destroy-modal-window")),this.render()},addAlias:function(){var e=this.$el.find("input[name=simple_alias]").val(),t=this;$.ajax({url:"/j_alias_add",dataType:"json",data:{login:e},success:function(e){e.result?t.closePopup():e.err&&t.$el.find(".alias_simple_note").show().html(window.SERVER_ERRORS[e.err.id].msg)}})},closePopup:function(){$(".modal").hide(),this.remove(),Backbone.trigger("verif-need-render")},render:function(){$(".modal").show(),this.$el.find(".entity_content_bl").empty().appendTmpl("t_sett_simple_alias"),this.$el.find(".modal__title").text(window.alerts.ADDED_ALIAS_BL)}})}();var Compose=Backbone.View.extend({tagName:"section",className:"compose_wrap",events:{"click .close":"close","click .expand":"expand","click .open_redactor":"openRedactor","keyup .cps_subject input":"subjectAct","click .js-popup-send-btn":"sendMail","eAutoSend .js-popup-send-btn":"sendMail","click .cps_rm_draft":"removeDraft","dblclick .cps_head":"expand","mouseenter .cps_attach":"attachFileClick","mouseout .cps_attach":"outAttach","click .js-compose-down-btn":"upDown"},initialize:function(e){this.options=e,this.dataMsg={},this.dataMsg.isNew=!0,this.interval=null,$(".compose_wrap").remove(),"new"!==this.options.newThreadId&&(this.getThread(),this.dataMsg.isNew=!1),this.dragenterCount=0,this.$el.on("dragenter",{bb:this},this._dragenter)},outAttach:function(e){$(e.target).removeClass("att_opas")},_dragenter:function(e){var t=e.data.bb;if(!t.dragenterCount){t.dragenterCount++;$(e.target);null!==t.dataMsg.thread_id&&null!==t.dataMsg.msg_id||t.create()}},close:function(e){this.$el.remove();var t=Backbone.history.fragment.split("?")[0];exMail.router.navigate(t),$("#popup_mode").hide()},expand:function(){this.$el.removeClass("compose-down"),$("#popup_mode")[this.$el.hasClass("cps_expanded")?"hide":"show"](),this.$el.toggleClass("cps_expanded")},openRedactor:function(e){this.$el.toggleClass("open-redactor")},create:function(e){var t=this,i=(new exMail.model.newCompose).fetch({async:!1});$.when(i).done(function(i){var a=i;1==a.result&&(exMail.router.navigate(Backbone.history.fragment.split("?")[0]+"?compose="+a.thread_id),t.dataMsg.thread_id=a.thread_id,t.options.newThreadId=a.thread_id,t.dataMsg.msg_id=a.msg_id,t.$el.find(".cps_upload_body").attr("id",a.msg_id+"_upload_body"),t.$el.find(".js-popup-send-btn").attr("data-msg_id",a.msg_id),t.$el.find(".cps_attach").attr("id",a.msg_id+"_upload_button"),t.$el.find(".cps_btns_bl").attr("id",a.msg_id+"_upload_container"),e&&(t.$el.find("[name=to]").val(e),$._j_compose.to=[],$._j_compose.name=""),t.initUploadBtn(),t.saveMail())})},_copy_files:function(e,t){var i=[];return $.each(t,function(t,a){$.ajax({url:"/j_upload_copy/"+a.upload_id,type:"get",async:!1,data:{msg_id:e,name:a.name},dataType:"json",success:function(e){var t=parseInt(e.upload_id,10);t?(console.log("ok",t),i.push(t)):console.warn("Err copy:",t)}})}),global_files_arr=[],i},getThread:function(){var e=this;new exMail.model.threadLoad({threadId:this.options.newThreadId}).fetch({async:!1,success:function(t,i,a){i.msg.is_compose&&(e.dataMsg=i)}})},_render:function(e){var t=this;this.dataMsg.isNew&&(this.dataMsg={isNew:this.dataMsg.isNew,msg:{msg_id:null,upload_list:[],file_count:"0",subject:"",html:"",file_size:"0",to:[],to_name:[]},msg_id:null,msg_count:"1",subject:"",thread_id:null});var i=this.dataMsg.msg;if(!global_files_arr.length&&this.options.acceptor?this.dataMsg.acceptor=this.options.acceptor:this.dataMsg.acceptor="",this.$el.tmpl("t_new",this.dataMsg),exMail.currentParams.aliases.length>1){var a=this.$el.find(".answer_from_popup");this.dataMsg.isNew?a.val($.user_email):a.val(i.from)}else this.$el.find(".js-answer-as-block").hide();$._j_compose.name.length&&this.dataMsg.isNew&&this.create($._j_compose.name);var n=this.$el.find(".cps_wrap"),o=this.$el.find(".cps_upload_body"),s=this.$el;$("body").append(this.$el),this.$el.find(".cps_redactor").redactor({toolbarExternal:this.$el.find(".cps_redactor_toolbar"),replaceDivs:!1,formatting:!1,cleanOnPaste:!1,plugins:["clearFormatting","fontsize"],source:!1,is_new_msg:!0,italicTag:"i",placeholder:window.mailSettings.mess_placeholder,dropdownShownCallback:function(e){var t=e.button,i=e.dropdown,a=t.offset().top;i.css("top",a-i.innerHeight()+"px")},initCallback:function(){this.$w=$(window),null===t.dataMsg.thread_id||null===t.dataMsg.msg_id?parseInt($.uConfig.signature.stat)&&this.code.set("<br><br><br><div></div>-- \n<div class='signature'>"+nl2br($.uConfig.signature.text)+"</div>"):($code=$("<div>",{html:i.html}),$code.find(".gmail_quote").removeAttr("contenteditable"),this.code.set($code.html()));var e=this.$w.height()-320;s.height()>=e?(s.addClass("compose_fix"),t.$el.find(".to").addClass("to_fix")):(s.removeClass("compose_fix"),t.$el.find(".to").removeClass("to_fix"))},keydownCallback:function(e){var i=this.selection.getCurrent(),a=this,r=this.$w.height()-320;if(this.$editor.height()+o.height()>=r?(s.addClass("compose_fix"),t.$el.find(".to").addClass("to_fix")):(s.removeClass("compose_fix"),t.$el.find(".to").removeClass("to_fix")),(e.ctrlKey||e.metaKey)&&function(e,i){setTimeout(function(){e.$editor.height()+o.height()>=i?(s.addClass("compose_fix"),t.$el.find(".to").addClass("to_fix")):(s.removeClass("compose_fix"),t.$el.find(".to").removeClass("to_fix"))},100)}(a,r),t.isElement(i)&&13==e.keyCode){var l=$(i).position().top,d=n.scrollTop(),c=n.height(),u=41;t.$el.hasClass("open-redactor")&&(u=90),console.log(u),(l<d||l+u>d+c)&&n.scrollTop(n.scrollTop()+20)}null===t.dataMsg.thread_id||null===t.dataMsg.msg_id?t.create():t.saveMail(),e.ctrlKey&&13==e.keyCode&&t.sendMail()},_keyupCallback:function(e){return function(e){setTimeout(function(){var i=e.selection.getBlock();if(t.isElement(i)){console.log(i);var a=$(i),o=a.position().top,s=n.scrollTop(),r=n.height();if(o<s||o+20>s+r||a.height()>r){var l=o-(r+s)+s;n.scrollTop(l+a.height()),console.log(i)}}},300)}(this),e}}),o.on("added_file",function(){console.log("added");var e=$(window).height()-320;s.height()>=e?(s.addClass("compose_fix"),t.$el.find(".to").addClass("to_fix")):(s.removeClass("compose_fix"),t.$el.find(".to").removeClass("to_fix"))}),null!==t.dataMsg.thread_id&&null!==t.dataMsg.msg_id&&(t.initUploadBtn(),t.$el.find("#"+t.dataMsg.msg_id+"_upload_body .upload .name").click(uploadClick),t.$el.find("div#"+t.dataMsg.msg_id+"_upload_body").on("click",".delete",deleteUploadClick));var r=this.$el.find("[name=to]");r.on("tag-add",function(){null===t.dataMsg.thread_id||null===t.dataMsg.msg_id?t.create():t.saveMail()}),r.focus(function(){t.$el.find(".inline_emails").hide()}).blur(function(){var e=[];if(t.$el.find(".adresable li").each(function(){e.push($(this).find("[data-email]").attr("data-email"))}),!e.length)return 0;t.$el.find(".to").hide(),t.$el.find(".inline_emails").show().text(e.join(", "))}).focus(),this.$el.find(".inline_emails").on("click",function(){t.$el.find(".to").show(),$(this).hide(),r.focus()}),setTags(r,this.$el),global_files_arr.length&&(this.create(),this._copy_files(t.dataMsg.msg_id,global_files_arr),Backbone.history.loadUrl(Backbone.history.fragment))},isElement:function(e){try{return e instanceof HTMLElement}catch(t){return"object"==typeof e&&1===e.nodeType&&"object"==typeof e.style&&"object"==typeof e.ownerDocument}},subjectAct:function(e){null===this.dataMsg.thread_id||null===this.dataMsg.msg_id?this.create():this.saveMail()},attachFileClick:function(e){$(e.target).addClass("att_opas"),null!==this.dataMsg.thread_id&&null!==this.dataMsg.msg_id||this.create()},sendMail:function(e){if(window.isProgress)return $.note({text:alerts.WAIT_PROGRESS,cont:$("#alert_box"),fixed:!0}),window.autoSend=!0,$("#auto_send_reset").off("click").on("click",function(){window.autoSend=!1,$("#alert_box").hide(),$.note({text:alerts.CANSEL_AUTOSEND,cont:$("#alert_box")})}),!1;var t=this,i=t.getMsgFormData();if(!i.len)return $.note({text:alerts.ERR_EMPTY_EMAIL,cont:$("#alert_box")}),this.$el.find("[name=to]").focus(),!1;$("#popup_mode").hide();var a="j_compose_send/"+t.dataMsg.msg_id;$.post("/"+a,i).then(maybeCaptcha(a,i)).then(function(e){e.err?alert(e.err.msg):(clearTimeout(t.interval),t.$el.remove(),console.warn(t.options.threadIdCurrentPage,e.thread_id),t.options.threadIdCurrentPage==e.thread_id?$.note({text:alerts.NOTE_MAIL_SENDED+' <a href="javascript:;" onClick=Backbone.history.loadUrl("!sent/'+e.thread_id+'")>'+dictionary.SEE+"</a>",cont:$("#alert_box")}):$.note({text:alerts.NOTE_MAIL_SENDED+" <a href='#!sent/"+e.thread_id+"'>"+dictionary.SEE+"</a>",cont:$("#alert_box")}),exMail.router.navigate(Backbone.history.fragment.split("?")[0]),t.undelegateEvents())}).fail(function(){alert("Error send message.")})},saveMail:function(){var e=this;clearTimeout(this.interval),e.$el.find(".draft_save").hide(),this.interval=setTimeout(function(){$.ajax({type:"POST",url:"/j_compose_save/"+e.dataMsg.msg_id,data:e.getMsgFormData(),dataType:"json"}),e.$el.find(".draft_save").fadeIn(200)},800)},getMsgFormData:function(){var e=[];this.$el.find(".adresable li").each(function(){var t=$(this).data("email")||$(this).text();validateEmail(t)&&e.push(t)});var t,i=this.$el.find(".cps_redactor"),a=$("<div>",{html:i.redactor("code.get")}).append('<div id="ex_attached_files"></div>'),n={to:e.join(", "),len:e.length,subject:this.$el.find(".cps_subject input").val(),body:a.html()};return t=exMail.currentParams.aliases.length>1?this.$el.find(".answer_from_popup option:selected").val():$.user_email,exMail.user[0].name.length?n.from=exMail.user[0].name+" <"+t+">":n.from=t,console.info("msgData.from",n.from),n},removeDraft:function(e){var t=this;if(clearTimeout(this.interval),$("#popup_mode").hide(),this.$el.find(".cps_redactor").redactor("core.destroy"),null===t.dataMsg.msg_id)return exMail.router.navigate(Backbone.history.fragment.split("?")[0]),t.$el.remove(),0;$.ajax({url:"/j_msg_delete/"+t.dataMsg.msg_id,async:!1,type:"get",dataType:"json",success:function(e){1==e.result||2==e.result?("drafts"===exMail.currentParams.action?exMail.router.navigate("!drafts",{trigger:!0}):(exMail.router.navigate(Backbone.history.fragment.split("?")[0],{trigger:!1}),boxInfo()),t.$el.remove(),t.undelegateEvents()):console.warn("ERROR: Can not remove draft")}}).fail(function(){console.warn("ERROR: Can not remove draft")})},initUploadBtn:function(){void 0!==uploader?(console.log("initUploadBtn",this.dataMsg.msg_id),newUploader(this.dataMsg.msg_id,!0)):console.warn("Fail load pluploader")},upDown:function(e){this.$el.removeClass("cps_expanded"),$("#popup_mode").hide(),this.$el.toggleClass("compose-down")},render:function(){var e=this;$.ajax({url:"/j_alias_list",data:{v:"for_thread_popup"},dataType:"json"}).done(function(t){exMail.currentParams.aliases=t,e._render()})}});!function(){"use strict";exMail.ui.experementalPupup=Backbone.View.extend({events:{"click .modal__close":"closePopup","click .js-experemental-agree":"agree","click .js-experemental-disable":"disable"},initialize:function(){$(".modal").empty(),$(".modal").appendTmpl("t-experemental-popup"),this.setElement($(".js-experemental-modal-window")),this.render()},disable:function(){$.uConfig.popups.experemental_popup=0,$.uConfig.tid=3,setConfig($.uConfig),createCookie("tid",$.uConfig.tid,99),window.location.reload()},agree:function(){$.uConfig.popups.experemental_popup=0,setConfig($.uConfig),this.closePopup()},closePopup:function(){$(".modal").hide(),this.remove()},render:function(){$(".modal").show(),this.$el.find(".modal__title").text(window.alerts.EXP_POPUP_TITLE)}})}(),function(){"use strict";exMail.ui.phoneAddAlertPopup=Backbone.View.extend({events:{"click .modal__close":"later","click .js-phoneadd-agree":"agree","click .js-phoneadd-later":"later"},initialize:function(){$(".modal").empty(),$(".modal").appendTmpl("t-phoneadd-popup"),this.setElement($(".js-phoneadd-modal-window")),this.render()},later:function(){this.closePopup(!0)},_later:function(){$.uConfig.popups.phoneadd_popup_last_show=Math.floor((new Date).getTime()/1e3),setConfig($.uConfig)},agree:function(){this.closePopup(),exMail.router.navigate("!settings/profile",{trigger:!0})},closePopup:function(e){e&&this._later(),$(".modal").hide(),this.remove()},render:function(){$(".modal").show(),this.$el.find(".modal__title").text(window.alerts.PHONEADD_TITLE)}})}();var uploader={};$(document).on("ready",function(){"use strict";$(".ib_mail_list_bl");$("#ib_search").on("focus",function(){$("#ib_search_dd").fadeIn(255)}).focusout(function(){$("#ib_search_dd").fadeOut(255)}),$("#ib_user_item").ddOZ({handlerClass:"open_user_item",autoClose:!1}),$(".im_sett_btn").ddOZ({handlerClass:"im_sett_btn_open"}),$(".ib_important").on("click",function(){$(this).toggleClass("ib_important_select")})}),function(e){"use strict";e.fn.ddOZ=function(t){var i=e.extend({handlerClass:"ddoz_handler",autoClose:!0,openClass:"open_dd"},t),a=this;this.each(function(){function t(){s.removeClass(i.openClass),n.removeClass(i.handlerClass)}var n=null,o=e(this),s=o.find("[data-dd]");s.is("[data-dd]")||(s=o.parent().find("[data-dd]")),(n=o.is("[data-handler]")?o:o.find("[data-handler]")).on("click",function(r){r.stopPropagation(),n.toggleClass(i.handlerClass),a.not(o).each(function(){e(this).find("[data-dd]").removeClass(i.openClass),o.is("[data-handler]")?e(this).removeClass(i.handlerClass):e(this).find("[data-handler]").removeClass(i.handlerClass)}),s.hasClass(i.openClass)?(s.removeClass(i.openClass),e(document).off("click",t)):(s.addClass(i.openClass),e(document).on("click",t))}),e(document).on("click",t),i.autoClose||s.on("click",function(e){e.stopPropagation()})})}}(jQuery);var t_action="inbox",cancel_list=[],has_unread=0,t_thread_id=0,t_msg_id=0,t_action="inbox",t_msg_from_last="1",is_turn=0,intervalInThread=null,compose_id=null;exMail.TMP_CONTENT="",$(document).keyup(function(e){var t=e.keyCode?e.keyCode:e.which;27==t?$("#video_box .close, #preview_box .close").click():39==t?"block"==$("#video_box").css("display")?$("#video_box .next").click():"block"==$("#preview_box").css("display")&&$("#preview_box .next").click():37==t&&("block"==$("#video_box").css("display")?$("#video_box .prev").click():"block"==$("#preview_box").css("display")&&$("#preview_box .prev").click())}),window.onbeforeunload=function(){if(window.isProgress||window.autoSend)return alerts.WARNING_UNLOAD},$(document).keydown(function(e){e.ctrlKey&&13==e.keyCode&&/^!(inbox|drafts|starred|sent|spam|trash)\/(\d+)$/.test(Backbone.history.fragment)&&$(".redactor-box").length&&$(".im_send_btn").click()}),$(document).on("click",".im_mail_top_bl",function(){var e=$(this).parent();e.toggleClass("im_mail_open"),e.toggleClass("im_mail_closed")});var editor_content_tmp="";$(document).on("click",".turn_all_btn",function(){var e=$.parseJSON($(this).attr("data-tt")),t=$(this).find(".ib_tt");is_turn?(is_turn=0,editor_content_tmp=$(".editor").html(),t_init_thread2($(this).data("id"),t_action),setTimeout(function(){$(".editor").empty().html(editor_content_tmp)},1e3),setTimeout(function(){$(".turn_all_btn").find(".ib_tt").text(e[1])},1e3)):(is_turn=1,$("#line_more").click(),setTimeout(function(){$(".im_mail_closed").click()},500),t.text(e[0])),$(".turn_all_btn").toggleClass("turn_off")}),window.isProgress=!1,window.autoSend=!1;var setConfigFlag=!1,is_per=!1,is_skin=!1,glob_skin={},global_files_arr=[],searchByAllMails=!1,_cache_avatar={},searchOn={none:0,inbox:1,sent:2,drafts:3,spam:4,trash:5,starred:6};if(loadTemplate(),exMail.isAuth){$.ajax({url:exMail.apiUrls.settings,type:"post",async:!1,dataType:"json",xhrFields:{withCredentials:!0},success:function(e){exMail.user[0]={name:e.name,phone:e.phone}}}),videojs.options.flash.swf="lib/video-js/video-js.swf";var $top_menu=$("#top_menu").tmpl("t_top_menu"),$files_wrap=$("#files_wrap").appendTmpl("t_files_wrap");$files_wrap.prependTo(".ib_mail_list_wr"),$("#preview_box").appendTmpl("t_close_preview"),$("body").append($("#t_marck").html()),exMail.domainSettings.widgetsVisible&&$(".ib_widgets_bl").tmpl("t_wg_bl"),$.host_email=getHost(window.location.host),$.user_email=LOGIN+"@"+$.host_email,$.user_name=getUserName(),$(".menu-name-block").text($.user_name||$.user_email),$(".menu__photo-block").css("background-image","url(/avatar/"+$.user_email+"?resize=80&time="+(new Date).getTime()+")"),Backbone.on("label-refresh",function(){$.ajax({url:"/j_box_name_list",data:{v:"refresh"},dataType:"json",success:function(e){exMail.currentParams.labels=converLabelsData(e),Backbone.trigger("label-refresh-end")}})});var difPopupAddPhone=Math.floor((new Date).getTime()/1e3)-$.uConfig.popups.phoneadd_popup_last_show,monthSeconds=2592e3;exMail.user[0].phone}$.ajaxSetup({error:function(e,t,i){}});var $search_inpt=$("#ib_search");$(function(){initUserMailTt(),$._search_tm=null,$search_inpt.keyup(function(e){var t=e.keyCode?e.keyCode:e.which,i=$(this).val();console.log("text",i),i=encodeURIComponent(i),27==t||""==i?(clearTimeout($._search_tm),exMail.router.navigate("!"+t_action,{trigger:!0}),$("#ib_search_btn").hide()):($("#ib_search_btn").show(),console.log("searchOn.t_action",searchOn[t_action],t_action),clearTimeout($._search_tm),$._search_tm=window.setTimeout(function(){exMail.router.navigate("!"+t_action+"/s/"+i,{trigger:!0})},1e3))}),$search_inpt.on("focusout",function(){$(this).val().isEmpty()&&$("#ib_search_btn").click()}),$("#ib_search_btn").on("click",function(){$search_inpt.val("").keyup(),$(this).hide()}),$(document).on("click",".rm_cancel_inmail, .return_thread",function(){$.ajax({url:"/j_thread_list_move",type:"get",data:{thread_list:exMail.currentParams.threadId},dataType:"text",success:function(e){Backbone.history.navigate("!inbox/"+exMail.currentParams.threadId,{trigger:!0})}})})}),$(document).on("click","span[data-action]",function(){var e=$(this).data("action");searchByAllMails="none"==e,exMail.loadMailList({name:t_action,is_search:!0,search_text:$search_inpt.val(),box_id:searchOn[e],byAll:searchByAllMails})}),$._j_compose={to:[],name:"",set:!1};var side=$(".l-side"),mainSide=$(".app-main-js");side.on("click",".menu-labels-js",function(){side.toggleClass("l-labels-open"),mainSide.toggleClass("r-labels-open")}),side.on("click",".l-minify-btn",function(){side.toggleClass("l-minify"),mainSide.toggleClass("r-minify")}),$(document).on("click",".compose-js",function(){exMail.router.navigate(Backbone.history.fragment.split("?")[0]+"?compose=new",{replace:!0});var e=/^!(inbox|drafts|starred|sent|spam|trash|(?:f\d{3}))(?:\/(\d+))?(?:\/page\/(\d+))?\?compose=(new|\d+)$/.exec(Backbone.history.fragment),t={action:"inbox",newThreadId:"new"};e&&(t.threadIdCurrentPage=e[2]),exMail.ui.compose=new Compose(t),exMail.ui.compose.render()}),$(".ib_box_r_bl").on("click","a",function(e){var t=$(this).attr("href");if(/^mailto:/i.test(t)){e.preventDefault();var i=t.split(":")[1];return exMail.ui.compose=new Compose({action:"inbox",newThreadId:"new",acceptor:i}),exMail.ui.compose.render(),!1}}),$(document).on("mousedown",".ib_mail_list .check",function(e){if(e.shiftKey){console.log("$anchor",$anchor);var t=$(".ib_mail_list .check");if(null!=$anchor){var i=Array.prototype.indexOf.call(t.get(),$anchor.get(0)),a=Array.prototype.indexOf.call(t.get(),$(this).get(0));if(a!=i)if(a<i)if($(this).parent().hasClass("selected"))for(n=a+1;n<=i;n++)t.eq(n).parent().removeClass("selected"),t.eq(n).find("input").prop("checked",!1);else for(n=a+1;n<=i;n++)t.eq(n).parent().addClass("selected"),t.eq(n).find("input").prop("checked",!0);else if($(this).parent().hasClass("selected"))for(n=a-1;n>=i;n--)t.eq(n).parent().removeClass("selected"),t.eq(n).find("input").prop("checked",!1);else for(var n=a-1;n>=i;n--)t.eq(n).parent().addClass("selected"),t.eq(n).find("input").prop("checked",!0)}$anchor=$(this),$(".ib_mail_list .check i").removeClass("anchor"),$anchor.find("i").addClass("anchor")}}),$(document).on("click",".js-l-back-btn",function(){/^#!corp/.test(window.location.hash)&&($(".ib_widgets_bl > .files").removeClass("act_ln"),$(".ib_widgets_bl > .files").eq(0).addClass("act_ln")),window.history.back()}),$("#lang_box").find("span.value").text(getLanguageName(getLanguage())),$("#lang_box").click(function(){return $(this).addClass("exmail_item_active"),!1}),$("#lang_box").find("a").click(function(){var e=getLanguage(),t=$(this).attr("data-lang");if(e==t)return $("#lang_box").removeClass("exmail_item_active"),!1;createCookie("lang",t,99)}),$(document).unbind("click",onBlurBottomLang).click(onBlurBottomLang),$._box_info=null,$(function(){function e(t){$(".lbl_item").removeClass("lbl_open"),$(document).off("click",e),t.data.el.toggleClass("lbl_open")}function t(e){if(e.dataTransfer.types)for(var t=0;t<e.dataTransfer.types.length;t++)if("Files"==e.dataTransfer.types[t])return!0;return!1}if("ontouchstart"in document.documentElement||$("body").addClass("no_touch"),ERROR&&$.note({text:ERROR.msg,cont:$("#alert_box")}),!exMail.isAuth)return $("title").text(window.location.host),!1;$.uConfig.tid&&3!=$.uConfig.tid&&$(".ib_logo").addClass("dev_mode").attr("title","EXMAIL. Экспериментальный режим"),/^#!corp/.test(window.location.hash)&&($(".ib_widgets_bl > .files").removeClass("act_ln"),$(".ib_widgets_bl > .corp_ln").addClass("act_ln")),$(".ib_widgets_bl > .files").on("click",function(){$(".ib_widgets_bl > .files").removeClass("act_ln"),$(this).addClass("act_ln")}),$(document).on("click",".lbl_visible_bl>i",function(t){t.stopPropagation();var i=this;$(".lbl_visible_bl>i").each(function(e,t){t!==i&&$(this).parent().parent().removeClass("lbl_open")}),$(i).parent().parent().toggleClass("lbl_open"),$(document).on("click",{el:$(this)},e)}),Backbone.on("label-refresh-end",function(){Backbone.history.loadUrl(Backbone.history.fragment)}),countReset(),$(document).on("click","li.new",function(){countReset()});var i=$(".tools_list");i.find(".ib_user_name").text($.user_email),i.find(".in_user_as span").text($.user_name||$.user_email),setUserAvatar(),$(document).on("click",".redactor-editor i.quote",function(){return $(this).parent().addClass("active"),$(this).parent().attr("contenteditable","true"),$(this).hide(),!1}),$(document).on("click",".im_mail i.quote",function(){return $(this).parent().toggleClass("active"),!1}),$._ajax_tm=null,$._ajax_alert=!1,$.boxInterval=window.setInterval(function(){"#!inbox"==window.location.hash?boxInfo(1):boxInfo()},1e4);var a=getMode(),n=($.uConfig.mode_popup,$("#mail_list"));"1"==a&&n.addClass("ib_mail_compact"),$(".mode_btn_bl > button").on("click",function(){"1"==$(this).attr("data-mode")?n.addClass("ib_mail_compact"):n.removeClass("ib_mail_compact"),$("#popup_mode").hide(),$("body").removeClass("blur"),$.uConfig.mode_popup=!1,setConfig($.uConfig)}),$(".ib_mail_list_wr").on("scroll",function(){is_top_mail_listWr($(this))}),$(".ib_mail_list_wr").on("scroll"),window.is_top_mail_listWr=function(e){e.scrollTop()?$(".js-top-toolbar").addClass("ib_top_ctrl_bl_ntop"):$(".js-top-toolbar").removeClass("ib_top_ctrl_bl_ntop")},$(".ib_mail_list_wr").scroll(),document.addEventListener("dragover",function(e){e.preventDefault()},!1);var o=0;if($(document).on("dragenter",function(e){o++,t(e.originalEvent)&&$(".drag_area").fadeIn(255)}),$(document).on("dragleave",function(){0===--o&&$(".drag_area").fadeOut(255)}),$(document).on("drop",function(e){o=0,$(".drag_area").fadeOut(255),e.preventDefault()}),exMail.isAuth){var s=$(".ib_wg_entity"),r=[{name:"JamFM",url:exMail.domainSettings.radioOrigin+"JamFM"},{name:"NRJ",url:exMail.domainSettings.radioOrigin+"NRJ"},{name:"Bussines FM Kiev",url:exMail.domainSettings.radioOrigin+"bfm_h"},{name:"DJ FM",url:exMail.domainSettings.radioOrigin+"djfm_h"},{name:"Radio Renessans Ukraine",url:exMail.domainSettings.radioOrigin+"jazz_h"},{name:"PowerFM Ukraine",url:exMail.domainSettings.radioOrigin+"power_h"},{name:"Shanson",url:exMail.domainSettings.radioOrigin+"shanson_h"}];$radio_view=s.tmpl("t_radio_wg",{radios:r,cur:$.uConfig.radio}),$(".radio_btn_dd").ddOZ({handlerClass:"radio_open",autoClose:!1,openClass:"open_dd_slow"});var l=$("<audio>",{id:"audio_radio"}),d=l.get(0),c=!1;$radios_node_list=$(".radio_dd_wr li"),$radios_node_list.on("click",function(){var e={name:$(this).text(),url:$(this).data("stream")};$.uConfig.radio=parseInt($radios_node_list.index($(this))),setConfig($.uConfig),c=!0,$(".radio_dd_wr li").removeClass("r_active"),$(this).addClass("r_active"),$radio_view.find("span").text(e.name),l.attr("src",e.url),$radio_view.find(".play_wr i").hide(),$radio_view.find(".load1").css("display","inline-block");var t=setInterval(function(){d.readyState>=2&&(clearInterval(t),d.play(),$radio_view.find(".load1").hide(),$radio_view.find(".play_wr i").css("display","inline-block"),$radio_view.find(".bs_radio").addClass("bs_radio_active"))},50)});var u;$radio_view.mouseleave(function(){var e=$(this).find(".radio_dd_wr");if(e.hasClass("open_dd_slow")){var t=$(this);u=setInterval(function(){t.find(".radio_btn_dd").removeClass("radio_open"),e.removeClass("open_dd_slow")},1500)}}).mouseenter(function(){clearInterval(u)}),d.addEventListener("error",function(e){switch(e.target.error.code){case e.target.error.MEDIA_ERR_ABORTED:console.log("You aborted the video playback.");break;case e.target.error.MEDIA_ERR_NETWORK:console.log("Случился сбой в интернет соединении.");break;case e.target.error.MEDIA_ERR_DECODE:console.log("The audio playback was aborted due to a corruption problem or because the video used features your browser did not support.");break;case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.log("The video audio not be loaded, either because the server or network failed or because the format is not supported.");break;default:console.log("An unknown error occurred.")}},!0);$radio_view.on("click",".play_wr > i",function(){$(this);c?$radio_view.find(".bs_radio").hasClass("bs_radio_active")?($radio_view.find(".bs_radio").removeClass("bs_radio_active"),d.pause()):($radio_view.find(".bs_radio").addClass("bs_radio_active"),d.play()):$radios_node_list.eq($.uConfig.radio).click()})}$(".exmail_item, .tools_ln, #sett_profile").on("click",function(e){window.isProgress&&(confirm("Письмо не будет отправлено?")?(window.isProgress=!1,window.autoSend=!1):e.stopImmediatePropagation())}),$(".js-top-toolbar").on("click",".print_btn",function(){window.open("/#!print/thread/"+$(this).data("id"),"_blank").focus()});var p,h=$(".tools_list").width(),_=$(".bar_items");$(window).resize(function(){clearInterval(p),p=setTimeout(function(){$(window).width()-520<h?(_.prependTo(".ib_user_settings_list"),_.addClass("ib_user_settings_item").removeClass("tools_item").find("a").removeClass("active")):(_.prependTo(".tools_list"),_.removeClass("ib_user_settings_item").addClass("tools_item"))},50);var e=$(document).find(".compose_wrap");$(window).height()<500&&e.length?e.addClass("compose_fix"):$(window).height()-320>e.height()&&e.removeClass("compose_fix")}),$(window).resize(),$("#alert_box").on("click",function(){$(this).hide()}),$(document).on("click","#direct_create_label",function(){var e=prompt(alerts.FOLDER_NAME+":")||"";if(e.isEmpty())console.log("Empty name");else{var t=exMail.ui.sett.labels.getNewId();if(null===t)return alert("Вы создали максимальное кол-во ярлыков."),!1;$.ajax({url:"/j_box_name_change/"+t,dataType:"json",data:{name:e,data:JSON.stringify({color:"6c7a89"})},success:function(e){e.result?Backbone.trigger("label-refresh"):console.warn("Can not create")}})}})});var noteInterval=null;!function(e){"use strict";e.note=function(t){var i=e.extend({text:"notification",cont:null,fixed:!1,handler:void 0,nameEvent:"",eventElement:null,spin:!1},t);if(null===i.cont)return 0;i.cont.hide(),i.cont.empty();var a=e("<div/>",{class:"note_bl",html:i.text});if(i.handler&&a.find(i.eventElement).on(i.nameEvent,i.handler),i.spin)var n=e("#t-smile-spin").html();i.cont.append(a.append(n)).fadeIn(300),i.fixed||(clearTimeout(noteInterval),noteInterval=setTimeout(function(){i.cont.fadeOut(100)},7e3))}}(jQuery),exMail.setMenu=function(e,t){"use strict";if(0===e)$("#settings-wrap, #files_wrap").hide(),t.labels=exMail.currentParams.labels,console.log(exMail.currentParams.labels),$(".l-side").tmpl("t_left_menu",t),$(".l-labels-list > a").draggable({revert:!0,helper:"clone",delay:70,revertDuration:100}),/^(f\d{3})$/i.test(t.action)&&$(".l-side").find(".menu-labels-js").addClass("active"),$("#j_"+t.action).addClass("active"),$("#j_compose, #ib_search").show(),$("#ib_search_contact, #ib_search_btn2, #j_upload_file").hide();else if(1==e)this.cleanSideClasses(),$._user_group=_.map($._user_group,function(e,i){var a=0|e[0],n=exMail.ui.contacts.getContactCount(t,a);return e.length>2?e[2]=n:e.push(n),e}),$(".l-side").tmpl("t_contact_menu",{groups:$._user_group,all:t.length}),t.groupId=void 0!==t.groupId?t.groupId:"all",$('.js-group[data-group="'+t.groupId+'"]').addClass("active").addClass("js-group-active"),$("#settings-wrap, #files_wrap").hide(),$("#ib_search, #ib_search_btn, #j_upload_file").hide(),$("#ib_search_contact").show();else if(4==e)exMail.cleanSideClasses(),$("#ib_search_contact, #ib_search").hide().val(""),$("#ib_search_btn, #ib_search_btn2, #files_wrap, #settings-wrap").hide(),$("#mail_list, .js-top-toolbar").empty(),$(".tools_item > a").removeClass("active"),$(".l-side").tmpl("t_corp_menu"),$(".js-top-toolbar").tmpl("t_corp_users_toolbar");else if(3==e){exMail.cleanSideClasses(),$(".l-side").tmpl("t_files_menu");var i=null===t.type||"r"===t.type?0:1;$(".js-l-files-list li[data-type="+i+"]").addClass("active").addClass("js-l-file-active"),$(".js-top-toolbar").empty().appendTmpl("t_files_ctrl")}else if(5==e){$("#ib_search, #ib_search_contact, #ib_search_btn2, #j_upload_file").hide(),$("#ib_search_btn").hide(),$("#settings-wrap, #files_wrap").hide(),t.labels=exMail.currentParams.labels,console.log(t.labels),$(".l-side").tmpl("t_left_menu",t),$(".app-main-js").addClass("js-settings-open"),$(".js-top-toolbar").tmpl("t_sett_menu"),$("#mail_list").empty();var a="common"==t.action?"#!settings":"#!settings/"+t.action;$('.settings-menu-list a[href$="'+a+'"]').addClass("active")}else 6==e&&(exMail.cleanSideClasses(),$(".l-side").tmpl("t_left_menu_history_login"),$("#ib_search_btn").hide());boxInfo()},exMail.cleanSideClasses=function(){$(".l-side").removeClass("l-labels-open").removeClass("l-minify"),$(".app-main-js").removeClass("r-labels-open").removeClass("r-minify")},exMail.loadMailList=function(e){var t={},i={_self:$(),name:"inbox",page:0,search_text:void 0,box_id:0,is_search:!1,byAll:!1};(t=$.extend(!0,i,e)).byAll&&(t.box_id=0);var a=t.name;a=/^(f\d{3})$/i.test(t.name)?"j_box/"+t.name.split("f")[1]:"j_"+a,t.page=null==t.page?0:t.page;var n={};_.each(exMail.currentParams.labels,function(e,t){n[e[0]]={name:e[1],data:e[2],id:e[0]}});var o=$("#mail_list");o.tmpl("t_spiner");var s=$.getJSON("/"+(t.is_search?"j_search":a),{p:t.page,s:t.search_text,per:$.uConfig.per_page,box_id:parseInt(t.box_id)}),r=$.ajax({url:"/j_box_name_list",data:{v:"refresh"},dataType:"json"}),l=$.ajax({url:"/j_alias_list",data:{v:"for_thread"},dataType:"json"});exMail.setMenu(0,{action:t.name}),$.when(s,r,l).done(function(e,i,a){function s(e,t,i){a=_.map(i,function(e,i){var a=t[i]||"",n=e.split("@")[0]||"";return _.contains(l,n)?u.msg_count>1&&(a="я"):a.length?f<=1&&(a=a.split(" ")[0]):(a=e,f<=2&&(a=n)),a});if((a=_.uniq(_.compact(a)).join(", ")).length>e&&f>1)f--,s(e,t,i);else{var a=_.map(a.split(", "),function(e,t){return"я"==e?e:'<span data-mail="'+i[t]+'" data-user="'+e+'" class="js-user-mail-tt">'+e+"</span>"});g=a.join(", ")}}$(".js-top-toolbar").tmpl("t_top_ctrl"),exMail.currentParams.labels=converLabelsData(i[0]),exMail.currentParams.aliases=a[0];getHost(),$.user_email.toLowerCase();var r=e[0],l=_.map(exMail.currentParams.aliases,function(e,t){return e[0]});t.is_search&&(r.is_search=1,r.search_text=t.search_text);for(var d=0,c=r.thread_list.length;d<c;d++){var u=r.thread_list[d];r.thread_list[d].msg_time_full=timeConverter(0|r.thread_list[d].msg_time),r.thread_list[d].msg_time=timeConverter(0|r.thread_list[d].msg_time,!0);var p=_.without(r.thread_list[d].box_list,1,2,3,4,5,6);if(p.length){var h=[],m="";_.each(p,function(e,t){void 0!==n[e]&&t>1&&(m+=n[e].name+", "),void 0!==n[e]&&t<=1&&h.push(n[e])}),m=m.substring(0,m.length-2),r.thread_list[d].hide_box_name=m,r.thread_list[d].box_list_original_count=p.length,r.thread_list[d].box_list=h}if(u.mail.length){var f=3,g="";s(exMail.currentParams.mailMaxCountChars,r.thread_list[d].mail_name,r.thread_list[d].mail),r.thread_list[d].mail_name=g}}r.action=t.name,r.byAll=t.byAll,o.empty().tmpl("t-mail-list",r),setToolbar(t.name,r),r.thread_list.length?$(".js-top-toolbar").find(".toolbar").show():$(".js-top-toolbar").find(".toolbar").hide(),t_init_box(t_action),o.find(".check").click(function(e){e.stopImmediatePropagation()}),o.find(".ib_important").click(function(e){var t=$(this),i=t.parent().data("thread_id"),a=1;t.hasClass("ib_important_select")?(a=0,t.removeClass("ib_important_select")):t.addClass("ib_important_select"),$.getJSON("/j_thread_is_starred/"+i+"?is_starred="+a,function(e){}),e.stopImmediatePropagation()}),$(".read-one-control").on("click",function(e){e.stopImmediatePropagation();var t=$(this),i=t.parent().data("thread_id"),a=1;t.parent().hasClass("new")&&(a=0),$.ajax({url:"/j_thread_list_is_new",type:"get",data:{thread_list:i,is_new:a},dataType:"text",complete:function(){a=0,boxInfo()}}),t.parent().toggleClass("new")}),o.height()>=$(".ib_mail_list_wr").height()&&$(".app-main-js").addClass("app-box-scrollable"),o.find('li[data-garbage="0"]').droppable({drop:function(e,t){var i=$(this).data("thread_id"),a=t.helper.data("id"),n=t.helper.find("span").text().trim();$(this).removeClass("over"),$.ajax({url:"/j_thread_mark/"+i,data:{box_id:a,is_mark:1},dataType:"json",success:function(e){console.log(e),e.result&&addLabelUI(i,a,n)}})},over:function(e,t){$(this).addClass("over")},out:function(e,t){$(this).removeClass("over")}}),exMail.firstLoad&&(exMail.firstLoad=!1)})},function(e){function t(){function e(e){var i=a.offset(),n=e.pageX-i.left,o=$(t.controlBar.progressControl.seekBar.playProgressBar.el());n<o.width()?$tooltipLine.css({left:n+2+"px",width:o.width()-n+"px"}):$tooltipLine.css({width:n-o.width()+"px",left:o.width()+"px"})}var t=this;n=$(this.el()),a=n.find(".vjs-progress-control"),$fakeHolde=$("<div>",{class:"vjs-fake-progress-holder"}),o=$("<div>",{class:"vjs-time-tooltip",text:"00:00:00"}),$tooltipLine=$("<div>",{class:"vjs-line-tooltip"}),a.append(o,$tooltipLine,$fakeHolde);var s={from:"M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26",to:"M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28",dur:"0.1s",keySplines:".4 0 1 1",repeatCount:1},r={from:"M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28",to:"M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26",dur:"0.1s",keySplines:".4 0 1 1",repeatCount:1},l=$(t.controlBar.playToggle.el());l.append('<svg width="100%" height="100%" viewBox="0 0 36 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path id="fox-play-svg" d="M 11 10 L 18 13.74 L 18 22.28 L 11 26 M 18 13.74 L 26 18 L 26 18 L 18 22.28"><animate attributeType="XML" attributeName="d" fill="freeze"></animate></path>');var d=l.find("svg animate");t.on("play",function(){d.attr(r).get(0).beginElement()}),t.on("pause",function(){d.attr(s).get(0).beginElement()});var c=!1;"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch?(t.controlBar.progressControl.on("touchstart",function(){c=!0}),t.controlBar.progressControl.on("touchend",function(){c=!1}),t.controlBar.progressControl.on("touchmove",function(e){c&&this.seekBar.update()})):(t.controlBar.progressControl.on("mousedown",function(){c=!0}),t.controlBar.progressControl.on("mouseup",function(){c=!1}),t.controlBar.progressControl.on("mousemove",function(e){c&&this.seekBar.update()})),a.on("mousemove",function(a){e(a);var n=$(this).offset(),s=a.pageX-n.left;o.css({left:s+"px"});var r=s/$(this).width()*t.duration();o.text(i(r,t.duration()))})}function i(e,t){t=t||e;var i=Math.floor(e%60),a=Math.floor(e/60%60),n=Math.floor(e/3600),o=Math.floor(t/60%60),s=Math.floor(t/3600);return(isNaN(e)||e===1/0)&&(n=a=i="-"),n=n>0||s>0?n+":":"",a=((n||o>=10)&&a<10?"0"+a:a)+":",i=i<10?"0"+i:i,n+a+i}var a,n,o;e.plugin("foxPlugin",t)}(videojs),function(){"use strict";var e=null,t=Backbone.Model.extend({defaults:{visible:!1,token:"",imageUrl:"",data:{},action:""},getDomainName:function(){return this.get("isAuthAction")?exMail.apiUrls.captchaDomain:"/"},reload:function(){var e=exMail.getCaptchaToken(32);this.set({token:e,imageUrl:this.getDomainName()+"captcha?captcha_token="+e})},validate:function(){var e=_.extend(this.get("data"),{captcha_token:this.get("token"),captcha_value:this.get("value")});return $.ajax({url:this.getDomainName()+this.get("action"),method:"POST",xhrFields:{withCredentials:!0},data:e})},clear:function(){this.set({visible:!1,data:{},action:""})}}),i=Backbone.View.extend({template:doT.template($("#fexmail-captcha").html()),tagName:"div",className:"fex-captcha__modal",events:{submit:"validate","click .js-captcha-hide":"hide","click .js-captcha-reload":"reload"},initialize:function(){this.model=new t,this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.toggle(this.model.get("visible")),this.$el.find(".js-captcha-input").focus(),this},show:function(t){return e=jQuery.Deferred(),this.model.set({visible:!0,action:t.action,data:t.data,isAuthAction:t.isAuthAction},{silent:!0}),this.model.reload(),e},reload:function(){this.model.reload()},hide:function(){this.model.clear()},validate:function(t){t.preventDefault();var i=this,a=this.$el.find(".js-captcha-input").val();""!==a&&(this.model.set("value",a,{silent:!0}),this.model.validate().then(function(t){exMail.utils.needCaptcha(t)?(i.model.reload(),$.note({text:t.err.msg,cont:$("#alert_box")})):(i.hide(),e.resolve(t))},function(t){e.reject(t)}))}});exMail.ui.captcha=new i,document.body.appendChild(exMail.ui.captcha.render().el)}(),exMail.confInptTel.utilsScript="/v1/exmail4/js_build/lib/intl-tel-input/js/utils.js";